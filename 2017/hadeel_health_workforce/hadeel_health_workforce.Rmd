---
title: "Health Workforce Validation"
author: Richard White
date: "`r lubridate::today()`"
output:
  pdf_document: default
params:
  EXTRA_8000: TRUE
  REMOVE_1000: TRUE
  CW00_AND_CW06: TRUE
editor_options: 
  chunk_output_type: console
---


\newpage

# Loading in data
```{r, results='hide', message=FALSE, warning=FALSE}
org::AllowFileManipulationFromInitialiseProject()
org::InitialiseProject(
  HOME = "/git/code_major/2017/hadeel_health_workforce/",
  RAW = "/dropbox/analyses/data_raw/code_major/2017/hadeel_health_workforce/",
  CLEAN = "/analyses/data_clean/code_major/2017/hadeel_health_workforce/",
  BAKED = "/analyses/results_baked/code_major/2017/hadeel_health_workforce/",
  FINAL = "/analyses/results_final/code_major/2017/hadeel_health_workforce/",
  SHARED = "/dropbox/analyses/data_raw/code_major/2017/hadeel_health_workforce/results/")

library(data.table)
library(ggplot2)

if(!exists("params")){
  EXTRA_8000 <<- TRUE
  REMOVE_1000 <<- TRUE
  CW00_AND_CW06 <<- TRUE
} else {
  EXTRA_8000 <<- params$EXTRA_8000
  REMOVE_1000 <<- params$REMOVE_1000
  CW00_AND_CW06 <<- params$CW00_AND_CW06
}

if(!EXTRA_8000 & !REMOVE_1000){
  extraDir <- "without8000_NOTremoving1000"
} else if(!EXTRA_8000 & REMOVE_1000){
  extraDir <- "without8000_removing1000"
} else if(EXTRA_8000 & !REMOVE_1000){
  extraDir <- "with8000_NOTremoving1000"
} else if(EXTRA_8000 & REMOVE_1000){
  extraDir <- "with8000_removing1000"
}

if(CW00_AND_CW06){
  extraDir <- file.path(extraDir,"CW00_AND_CW06")
} else {
  extraDir <- file.path(extraDir,"CW00")
}

SHARED_TODAY <- file.path(org::PROJ$SHARED_TODAY,extraDir)

## MOH WORKERS TO REMOVE
dMOHToRemove <- readxl::read_excel(file.path(org::PROJ$RAW,
                                             "Fixed excels - to be included in calculations",
                                             "Copy of MoH employees - to be removed from calculations 2018 latest.xlsx"),sheet=2)
dMOHToRemove <- as.numeric(dMOHToRemove[[1]])
length(dMOHToRemove)

# ED03


# 
d1 <- readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Data collected by PCBS - Gaza 1st phase",
                                    "Gaza Phase I - After auditing by Fayez",
                                    "WORKERS_ED03 (1).xlsx"))

d2 <- readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Data collected by PCBS - WB 1st phase",
                                    "WB - Phase I",
                                    "WORKERS_ED03 WB.xlsx"))

d3 <- readxl::read_excel(file.path(
  org::PROJ$RAW,
  "Data collected by PNIPH - Gaza 2nd phase",
  "WORKERS_ED03_GAZA-2nd phase-final.xlsx"))

d4 <- readxl::read_excel(file.path(
  org::PROJ$RAW,
  "Data collected by PNIPH - WB 2nd phase",
  "WORKERS_ED03_WB-final-2nd phase.xlsx"))

d5 <- haven::read_spss(file.path(
  org::PROJ$RAW,
  "New 8,000 records for data importing-received from Fayez",
  "worker_ed03 (4).sav"))

dUNRWA <- readxl::read_excel(file.path(
  org::PROJ$RAW,
  "New UNRWA West Bank employees",
  "WORKER_ED03.xlsx"))

if(EXTRA_8000){
  masterdED03 <- dED03 <- data.table(rbind(d1,d2,d3[names(d1)],d4[names(d1)],d5[names(d1)],dUNRWA[names(d1)]))
} else {
  masterdED03 <- dED03 <- data.table(rbind(d1,d2,d3[names(d1)],d4[names(d1)],dUNRWA[names(d1)]))
}

# DISTRICTS
dLocation <- list()
for(i in c("North WB","Middle WB", "South WB", "North Gaza", "Middle Gaza", "South Gaza", "East Jerusalem (J1)")){
  dLocation[[i]] <- readxl::read_excel(file.path(org::PROJ$RAW,
                                                   "Districts and localities codes - Richard.xls"),
                                         sheet = i)
  dLocation[[i]]$region <- i
}
dLocation <- rbindlist(dLocation)
dLocation[,isGaza := 0]
dLocation[region %in% c("North Gaza", "Middle Gaza", "South Gaza"), isGaza := 1]
setnames(dLocation,c("district","districtCode","localityCode","localityName","urbanRural","region","isGaza"))
dLocation[,districtCode:=as.numeric(districtCode)]
dLocation <- dLocation[!is.na(districtCode)]
dLocation[,districtJerusalemClean:=district]
dLocation[district %in% c("Jerusalem (J2)", "East Jerusalem (J1)"),districtJerusalemClean:="Jerusalem"]

dLocation[,isGazaNOJERUSALEM:=isGaza]
dLocation[district=="East Jerusalem (J1)",isGazaNOJERUSALEM:=NA]
dLocation[,gazaWBEJ:="West Bank (Not East J)"]
dLocation[isGaza==1,gazaWBEJ:="Gaza"]
dLocation[district=="East Jerusalem (J1)",gazaWBEJ:="East Jerusalem"]


dCountryCodes <- readxl::read_excel(file.path(
    org::PROJ$RAW,"county_codes.xlsx"))
  setnames(dCountryCodes,c("english","x","ED03D","x2"))

jordanValley <- readxl::read_excel(file.path(org::PROJ$RAW,
                                             "Jordan valley villages (OCHA).xlsx"))

updatedFacilitiesList <- readxl::read_excel(file.path(org::PROJ$RAW,
                                    "data_richard",
                                    "All Facilities FINAL - Richard.xlsx"))

# missing CW00
updatedCW00 <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,
                                    "data_richard",
                                    "missing_CW00.xlsx")))
updatedCW00 <- na.omit(updatedCW00[,c("HR01","CW00")])
nrow(updatedCW00)
updatedCW00 <- updatedCW00[!duplicated(updatedCW00$HR01)]
nrow(updatedCW00)
setnames(updatedCW00,"CW00","updated_CW00")

updatedCW00x <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,
                                    "data_richard",
                                    "2018-08-missing_CW00.xlsx")))
updatedCW00x <- na.omit(updatedCW00x[,c("HR01","CW00")])
nrow(updatedCW00x)
updatedCW00x <- updatedCW00x[!duplicated(updatedCW00x$HR01)]
nrow(updatedCW00x)
setnames(updatedCW00x,"CW00","updated_CW00")

updatedCW00xx <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,
                                    "data_richard",
                                    "2018-08-23_missing_CW00.xlsx")))
updatedCW00xx <- na.omit(updatedCW00xx[,c("HR01","CW00")])
nrow(updatedCW00xx)
updatedCW00xx <- updatedCW00xx[!duplicated(updatedCW00xx$HR01)]
nrow(updatedCW00xx)
setnames(updatedCW00xx,"CW00","updated_CW00")

updatedCW00xxx <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,
                                    "data_richard",
                                    "2018-09-11_missing_CW00_updated.xlsx")))
updatedCW00xxx <- na.omit(updatedCW00xxx[,c("HR01","CW00")])
nrow(updatedCW00xxx)
updatedCW00xxx <- updatedCW00xxx[!duplicated(updatedCW00xxx$HR01)]
nrow(updatedCW00xxx)
setnames(updatedCW00xxx,"CW00","updated_CW00")

updatedCW00 <- rbind(updatedCW00,updatedCW00x,updatedCW00xx,updatedCW00xxx)
nrow(updatedCW00)
updatedCW00 <- updatedCW00[updated_CW00!=""]
nrow(updatedCW00)
updatedCW00 <- unique(updatedCW00)
nrow(updatedCW00)
updatedCW00[,n:=1:.N,by=HR01]
updatedCW00 <- updatedCW00[n==1]
nrow(updatedCW00)
updatedCW00[,n:=NULL]
#updatedCW00$HR01 <- as.character(updatedCW00$HR01)

# adding a list of GPs
listOfGPs <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,
                                    "data_richard",
                                    "all GPs at MoH West Bank - from MoH list.xlsx")))

# TO REMOVE
# workers
d1 <- readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Workers records to be removed",
                                    "MoH Gaza - left facility.xlsx"))
d2 <- readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Workers records to be removed",
                                    "RICHARD_CARITAS_SELECTION.xlsx"))
d3 <- readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Workers records to be removed",
                                    "left facility - makassed.xlsx"))
d4 <- readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Workers records to be removed",
                                    "to remove.xlsx"))
dxxx <- d5 <- readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Workers records to be removed",
                                    "West Bank_ARABIC_WRITING_GOES_HERE.xlsx"))

TO_REMOVE <- unique(c(d1$HR01,d2$HR01,d3$HR01,d4$`ID number`,d5$HR01))
length(TO_REMOVE)

# FACILITIES
d1 <- readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Data collected by PCBS - Gaza 1st phase",
                                    "Gaza Phase I - After auditing by Fayez",
                                    "FACILITY_MAIN_Gaza I_Richard.xlsx"))

d2 <- readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Data collected by PCBS - WB 1st phase",
                                    "WB - Phase I",
                                    "FACILITY_MAIN WB I_Richard.xlsx"))

d3 <- readxl::read_excel(file.path(
  org::PROJ$RAW,
  "Data collected by PNIPH - Gaza 2nd phase",
  "FACILITY_MAIN_GAZA-2nd phase-final-Richard.xlsx"))

d4 <- readxl::read_excel(file.path(
  org::PROJ$RAW,
  "Data collected by PNIPH - WB 2nd phase",
  "FACILITY_MAIN_WB-second phase-final-Richard.xlsx"))

d5 <- readxl::read_excel(file.path(
  org::PROJ$RAW,
  "New 8,000 records for data importing-received from Fayez",
  "Copy of facility_main.xlsx"))
d5$IDH00 <- as.numeric(d5$IDH00)

dUNRWA <- readxl::read_excel(file.path(
  org::PROJ$RAW,
  "New UNRWA West Bank employees",
  "facility_main.xlsx"
))
dUNRWA$IS04 <- 8

if(EXTRA_8000){
  dFacilities <- data.table(rbind(d1,d2,d3[names(d1)],d4[names(d1)],d5[names(d1)],dUNRWA[names(d1)]))
} else {
  dFacilities <- data.table(rbind(d1,d2,d3[names(d1)],d4[names(d1)],dUNRWA[names(d1)]))
}
dFacilities[,IDH01:=as.numeric(IDH01)]
dFacilities[!is.na(IDH03),isJordanValley:=0]
dFacilities[IDH03 %in% jordanValley$`Basic:Geo PCBS Code`,isJordanValley:=1]
xtabs(~dFacilities$isJordanValley)
xtabs(~dFacilities$RE01)

# Remove duplicated facilities
dFacilities <- dFacilities[!(IDH00==1855756 & IS04!=1)]
dFacilities <- dFacilities[!(IDH00==1862880 & IS04!=1)]
dFacilities <- dFacilities[!(IDH00==1887796 & IS04!=2)]
dFacilities <- dFacilities[!(IDH00==1978454 & IS04!=7)]


dFacilities[,NUMDUP:=.N, by=IDH00]
setorder(dFacilities,IDH00)
duplicateFacilities <- dFacilities[NUMDUP>1,
                                   c("IDH00","IDH01","IDH03","IS04","IDH02")]
openxlsx::write.xlsx(duplicateFacilities,
                     file.path(SHARED_TODAY,"dupliated_facilities.xlsx"))


# Remove duplicated facilities
updatedFacilitiesList[updatedFacilitiesList$IDH00 %in% duplicateFacilities$IDH00,c("IDH00","IS04")]
duplicateFacilities[,c("IDH00","IDH01","IDH03","IS04")]

##????

nrow(updatedFacilitiesList)
length(unique(updatedFacilitiesList$IDH00))

nrow(dFacilities)
length(unique(dFacilities$IDH00))

updatedFacilitiesList[updatedFacilitiesList$IDH00 %in% duplicateFacilities$IDH00,c("IDH00","IS04")]
duplicateFacilities[,c("IDH00","IDH01","IDH03","IS04")]
dFacilities[dFacilities$IDH00 %in% duplicateFacilities$IDH00,c("IDH00","IS04")]

# Update old facilities data with new facilities data
names(updatedFacilitiesList)[!names(updatedFacilitiesList) %in% names(dFacilities)]
xtabs(~dFacilities$IS04,addNA = T)
for(name in names(updatedFacilitiesList)){
  if(name=="IDH00") next
  setnames(dFacilities,name,sprintf("OLD_%s",name))
}
nrow(dFacilities)
dFacilities <- merge(dFacilities, updatedFacilitiesList, by="IDH00",all.x=T)
nrow(dFacilities)
xtabs(~dFacilities$IS04,addNA = T)
for(name in names(updatedFacilitiesList)){
  if(name=="IDH00") next
  oldName <- sprintf("OLD_%s",name)
  dFacilities[is.na(get(name)),(name):=get(oldName)]
  dFacilities[,(oldName):=NULL]
}
xtabs(~dFacilities$IS04,addNA = T)
# END UPDATE

table(dFacilities$IS04,useNA = "always")
dFacilities[,facilitySector:=as.character(NA)]
dFacilities[IS04 %in% c(7),facilitySector:="Ministry of Health"]
dFacilities[IS04 %in% c(9),facilitySector:="Military Health Services"]
dFacilities[IS04 %in% c(8),facilitySector:="UNRWA"]
dFacilities[IS04 %in% c(1,12),facilitySector:="Private"]
dFacilities[IS04 %in% c(2,3,4,5,6,10,11,13,14),facilitySector:="NGO"]
dFacilities[,IDH03:=as.numeric(IDH03)]
dFacilities[IDH03==100750,IDH03:=100570]

xtabs(~dFacilities$IS04,addNA=TRUE)
xtabs(~dFacilities$facilitySector,addNA=TRUE)
xtabs(~dFacilities$IS04+dFacilities$facilitySector,addNA=TRUE)

# WORKERS
d1 <- readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Data collected by PCBS - Gaza 1st phase",
                                    "Gaza Phase I - After auditing by Fayez",
                                    "WORKERS_MAIN (1).xlsx"))
d1 <- d1[,names(d1)[1:which(names(d1)=="MD03_1_B")]]

d2 <- readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Data collected by PCBS - WB 1st phase",
                                    "WB - Phase I",
                                    "WORKERS_MAIN WB.xlsx"))
d2 <- d2[,names(d2)[1:which(names(d2)=="MD03_1_B")]]

d3 <- readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Data collected by PNIPH - Gaza 2nd phase",
                                    "WORKERS_MAIN_GAZA-final-2nd phase.xlsx"))

d4 <- readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Data collected by PNIPH - WB 2nd phase",
                                    "WORKERS_MAIN_WB-second phase-final.xlsx"))

dxxx2 <- d5 <- haven::read_spss(file.path(org::PROJ$RAW,
                                    "New 8,000 records for data importing-received from Fayez",
                                    "worker_main (6).sav"))
d6 <- readxl::read_excel(file.path(org::PROJ$RAW,
                                   "data_richard",
                                   "MoH West Bank records  - missing from system.xlsx"))
dUNRWA <- readxl::read_excel(file.path(
  org::PROJ$RAW,
  "New UNRWA West Bank employees",
  "WORKER_MAIN.xlsx"
))

d2 <- d2[,names(d1)]
d3 <- d3[,names(d1)]
d4 <- d4[,names(d1)]
d5 <- d5[,names(d1)]
n <- names(d6)[names(d6) %in% names(d1)]
d6 <- d6[,n]
d6$HR01 <- as.numeric(d6$HR01)
dUNRWA <- dUNRWA[,names(d1)]

NAMES_OF_WORKERS_FILE <- names(d1)

if(EXTRA_8000){
  dWorkers <- rbindlist(list(d1,d2,d3,d4,d5,d6,dUNRWA),fill=T)
} else {
  dWorkers <- rbindlist(list(d1,d2,d3,d4,d6,dUNRWA),fill=T)
}
dWorkers[,IDH03:=as.numeric(IDH03)]
dWorkers[IDH03==100750,IDH03:=100570]
dWorkers[IDH03==45540,IDH03:=452240]
dWorkers[IDH03==310810,IDH03:=301810]
nrow(dWorkers)

if(REMOVE_1000){
  nrow(dWorkers)
  dWorkers <- dWorkers[!HR01 %in% TO_REMOVE]
  nrow(dWorkers)
}

# remove MOH retired, etc
(a <- nrow(dWorkers))
dWorkers <- dWorkers[!HR01 %in% dMOHToRemove]
(b <- nrow(dWorkers))
b-a

dWorkers[CW00=="",CW00:=NA]
dWorkers[CW06=="",CW06:=NA]

# workers from system
workersFromSystem <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Workers records from system.xlsx")))

x1 <- data.table(table(dWorkers$HR01))
setnames(x1,c("HR01","n_richard"))

x2 <- data.table(table(workersFromSystem$HR01))
setnames(x2,c("HR01","n_system"))

x <- merge(x1,x2,by="HR01",all=T)
x[is.na(n_system),n_system:=0]
x[is.na(n_richard),n_richard:=0]
openxlsx::write.xlsx(x[n_richard!=n_system],file.path(SHARED_TODAY,"HR01_discrepancies.xlsx"))

# updating CW00 when available, from hadeel
nrow(dWorkers)
dWorkers <- merge(dWorkers,updatedCW00,by="HR01",all.x=T)
nrow(dWorkers)
sum(is.na(dWorkers$CW00))
dWorkers[is.na(CW00) & !is.na(updated_CW00) & updated_CW00!="",CW00:=updated_CW00]
sum(is.na(dWorkers$CW00))
dWorkers[,updated_CW00:=NULL]

#xtabs(~dWorkers[HR01 %in% updatedCW00$HR01]$CW00,addNA=T)

# if workers have CW00 for one of their jobs, and are missing another, then assign that
updatedCW00 <- unique(na.omit(dWorkers[,c("HR01","CW00")]))
updatedCW00[,numCW00:=.N,by=HR01]
updatedCW00 <- updatedCW00[numCW00==1]
updatedCW00[,numCW00:=NULL]
setnames(updatedCW00,"CW00","updated_CW00")

nrow(dWorkers)
dWorkers <- merge(dWorkers,updatedCW00,by="HR01",all.x=T)
nrow(dWorkers)
nrow(dWorkers[is.na(CW00) & !is.na(updated_CW00)])
dWorkers[is.na(CW00) & !is.na(updated_CW00),CW00:=updated_CW00]
dWorkers[,updated_CW00:=NULL]


# updating CW00 for GPs from a list that hadeel gave me
#xtabs(~dWorkers[HR01 %in% listOfGPs$HR01 & IDH00 %in% dFacilities[facilitySector=="Ministry of Health"]$IDH00]$CW00,addNA=T)
dWorkers[HR01 %in% listOfGPs$HR01 & IDH00 %in% dFacilities[facilitySector=="Ministry of Health"]$IDH00,CW00:="221101"]

dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00",all.x=T)

# updating CW00 for MOH family physicians that hadeel gave me
dWorkers[HR01 %in% c(
  902914548,
  912285871,
  851408724,
  959603978,
  904812583,
  978345734,
  904613940
),CW00:=221102]

# correcting ages that were wrong over two documents
correctAges <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,"data_richard","conflicing_ages.xlsx")))
changeHR01 <- correctAges[!is.na(changeHR01),c("HR01","HR03")]
changeHR01[,flag:=TRUE]
nrow(dWorkers)
dWorkers <- merge(dWorkers,changeHR01,by=c("HR01","HR03"),all.x=T)
nrow(dWorkers)
dWorkers[flag==T,HR01:=HR01*10]
dWorkers[,flag:=NULL]

changeHR03 <- correctAges[!is.na(correctHR03),c("HR01","HR03")]
setnames(changeHR03,"HR03","new_HR03")
nrow(dWorkers)
dWorkers <- merge(dWorkers,changeHR03,by=c("HR01"),all.x=T)
nrow(dWorkers)
dWorkers[!is.na(new_HR03),HR03:=new_HR03]
dWorkers[,new_HR03:=NULL]

# correcting ages that were wrong over two documents (round 2)
changeHR03 <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,"data_richard","2018-09-12_conflicing_ages_overwrite.xlsx")))

setnames(changeHR03,"HR03","new_HR03")
nrow(dWorkers)
dWorkers <- merge(dWorkers,changeHR03,by=c("HR01"),all.x=T)
nrow(dWorkers)
dWorkers[!is.na(new_HR03),HR03:=new_HR03]
dWorkers[,new_HR03:=NULL]

# fixing some missing ages, and identifying ages that aren't consistent
dWorkers[,numAgesNotMissing:=length(na.omit(unique(HR03))),by=HR01]
xtabs(~dWorkers$numAgesNotMissing)
dWorkers[numAgesNotMissing==1,HR03:=mean(HR03,na.rm=T),by=HR01]
dWorkers[,numAgesNotMissing:=length(na.omit(unique(HR03))),by=HR01]
xtabs(~dWorkers$numAgesNotMissing)

openxlsx::write.xlsx(dWorkers[numAgesNotMissing>1,c("HR01","HR03")],file.path(SHARED_TODAY,"conflicing_ages.xlsx"))

# updating genders by their names
dGender <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,
                                    "2017_12_14_hadeel_missing_gender.xlsx")))
dGender <- dGender[!is.na(HR01) & HR01!=999999999]
dGender[tolower(Gender)=="male",HR02_new:=1]
dGender[tolower(Gender)=="female",HR02_new:=2]
dGender <- unique(dGender[,c("HR01","HR02_new")])
sum(is.na(dGender$HR02_new)) # 22
dGender[,N:=.N,by=HR01]
dGender[N>1]
dGender <- dGender[!is.na(HR02_new) & N==1]
dGender[,N:=NULL]
nrow(dGender) # 489

nrow(dWorkers)
dWorkers <- merge(dWorkers,dGender,by=c("HR01"),all.x=T)
nrow(dWorkers)
sum(is.na(dWorkers$HR02)) #587
dWorkers[is.na(HR02) & !is.na(HR02_new), HR02:=HR02_new]
sum(is.na(dWorkers$HR02)) #32
dWorkers[,HR02_new:=NULL]

length(unique(dWorkers[is.na(HR02)]$HR01)) #25

# updating genders by their names 2
dGender <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,
                                    "data_richard",
                                    "2018-08-two_genders_same_name.xlsx")))
dGender <- dGender[!is.na(HR01) & HR01!=999999999]
dGender[tolower(`Correct gender`)=="male",HR02_new:=1]
dGender[tolower(`Correct gender`)=="female",HR02_new:=2]
dGender <- unique(dGender[,c("HR01","HR02_new")])
sum(is.na(dGender$HR02_new)) #
dGender[,N:=.N,by=HR01]
dGender[N>1]
dGender <- dGender[!is.na(HR02_new) & N==1]
dGender[,N:=NULL]
nrow(dGender) # 489

nrow(dWorkers)
dWorkers <- merge(dWorkers,dGender,by=c("HR01"),all.x=T)
nrow(dWorkers)
sum(is.na(dWorkers$HR02)) #32
sum(!is.na(dWorkers$HR02_new)) #587
dWorkers[!is.na(HR02_new), HR02:=HR02_new]
sum(is.na(dWorkers$HR02)) #32
dWorkers[,HR02_new:=NULL]

# GENDERS FIX 1
updatedGender <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,
                                    "data_richard",
                                    "2018-08-missing_gender.xlsx")))
updatedGender <- unique(na.omit(updatedGender[,c("HR01","HR02")]))
setnames(updatedGender,"HR02","updated_HR02")

nrow(dWorkers)
dWorkers <- merge(dWorkers,updatedGender,by="HR01",all.x=T)
nrow(dWorkers)
nrow(dWorkers[is.na(HR02) & !is.na(updated_HR02)])
dWorkers[is.na(HR02) & !is.na(updated_HR02),HR02:=updated_HR02]
dWorkers[,updated_HR02:=NULL]


# midwives that should be female
femaleWorkers <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,
                                                         "data_richard",
                                                         "Workers to be changed from male to female.xlsx")))
dWorkers[HR01 %in% femaleWorkers$`Worker ID Number`, HR02:=2]

# updating genders for people with dual genders in same ID
dGender <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,
                                    "Workers records same ID but different gender.xlsx")))
setnames(dGender,c("HR01","Gender"))
dGender[tolower(Gender)=="male",HR02_new:=1]
dGender[tolower(Gender)=="female",HR02_new:=2]
dGender <- unique(dGender[,c("HR01","HR02_new")])
sum(is.na(dGender$HR02_new)) # 0
dGender[,N:=.N,by=HR01]
dGender[N>1]
dGender <- dGender[!is.na(HR02_new) & N==1]
dGender[,N:=NULL]
nrow(dGender) # 17

nrow(dWorkers)
dWorkers <- merge(dWorkers,dGender,by=c("HR01"),all.x=T)
nrow(dWorkers)
sum(is.na(dWorkers$HR02)) #32
dWorkers[is.na(HR02) & !is.na(HR02_new), HR02:=HR02_new]
sum(is.na(dWorkers$HR02)) #26

namesIDGender <- unique(dWorkers[,c("HR00","HR01","HR02")])
namesIDGender <- namesIDGender[,.(N=.N),by=.(HR00,HR01)]
openxlsx::write.xlsx(namesIDGender[N>1],file.path(SHARED_TODAY,"two_genders_same_name.xlsx"))

##### MOH WORKERS #############

dMaster <- merge(dWorkers, dFacilities[facilitySector=="Ministry of Health" & IDH03 %in% dLocation[isGaza==0]$localityCode,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
#dMaster[HR01=="910435585"]

dMOHMaster <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,"Fixed excels - to be included in calculations","2018 MoH WB employees with DOB - Richard.xlsx")))
dMOHMaster[,HR01:=as.numeric(HR01)]

# remove MOH retired, etc
(a <- nrow(dMOHMaster))
dMOHMaster <- dMOHMaster[!HR01 %in% dMOHToRemove]
(b <- nrow(dMOHMaster))
b-a


dMOH <- unique(na.omit(data.table(HR01=as.numeric(dMOHMaster[["HR01"]]))))

dMOH_From_System <- unique(dMaster[,c("HR01")])

dMOH[,existsInMOH:="MOH"]
dMOH_From_System[,existsInSystem:="SYSTEM"]

final <- merge(dMOH_From_System,dMOH,by="HR01",all.x=T,all.y=T)
nrow(final)
nrow(dMOH)
nrow(dMOH_From_System)
final[,cat:="BOTH"]
final[is.na(existsInSystem),cat:="MOH_ONLY"]
final[is.na(existsInMOH),cat:="SYSTEM_ONLY"]

#final[HR01=="910435585"]

final[,num:=1:.N,by=cat]
final <- dcast.data.table(final,num~cat,value.var="HR01")
final[,num:=NULL]

#final[MOH_ONLY=="910435585"]

openxlsx::write.xlsx(final,file.path(SHARED_TODAY,"VALIDATING MoH West Bank official list.xlsx"))

openxlsx::write.xlsx(dWorkers[HR01 %in% final$SYSTEM_ONLY,NAMES_OF_WORKERS_FILE,with=F],file.path(SHARED_TODAY,"VALIDATING MoH West Bank official list_DATASET_THAT_EXISTS_IN_SYSTEM_BUT_NOT_MOH_LIST.xlsx"))

openxlsx::write.xlsx(dMOHMaster[HR01 %in% final$MOH_ONLY],file.path(SHARED_TODAY,"VALIDATING MoH West Bank official list_DATASET_THAT_EXISTS_IN_MOH_LIST_BUT_NOT_SYSTEM.xlsx"))

##### ADDING IN THE SPECIAL PEOPLE WHO EXIST ON MOH LIST BUT NOT IN SYSTEM
goodNames <- names(dWorkers)
badNames <- names(dMOHMaster)
newNames <- badNames[badNames %in% goodNames]
f <- rbind(dWorkers,dMOHMaster[HR01 %in% final$MOH_ONLY,newNames,with=F],fill=T)

## checking to see if professions are different
## TODO MORE HERE
tabx <- unique(dMaster[HR01 %in% final$BOTH,c("HR00","HR01","CW00","CW00_T")])
setnames(tabx,c("CW00","CW00_T"),c("CW00_OLD","CW00_T_OLD"))
new <- unique(dMOHMaster[HR01 %in% final$BOTH,c("HR01","CW00","CW00_T")])
setnames(new,c("CW00","CW00_T"),c("CW00_NEW","CW00_T_NEW"))

tab <- merge(tabx,new,by="HR01",all.x=T,all.y=T)
nrow(tabx)
nrow(new)
nrow(tab)
tab <- tab[CW00_OLD!=CW00_NEW]
setorder(tab,HR01)

edu <- dED03[HR01 %in% final$BOTH & ED03A<=7,]
edu[,m:=max(ED03A),by=HR01]
edu <- unique(edu[ED03A==m])
edu[,m:=NULL]
edu[,m:=1:.N,by=HR01]
edu <- edu[m==1]
edu[,m:=NULL]

tab2 <- merge(tab,edu,by="HR01",all.x=T)
nrow(tab)
nrow(tab2)

openxlsx::write.xlsx(tab2,file.path(SHARED_TODAY,"VALIDATING MoH West Bank official list_WHEN_CW00_DISAGREES.xlsx"))
## end

problematic <- dMaster[HR01 %in% final$MOH_ONLY]
xtabs(~problematic$facilitySector,addNA=T)
xtabs(~problematic[is.na(facilitySector)]$IDH00,addNA=T)

### UPDATING DOB (HR03) FOR ALL MOH WORKERS
newDOB <- unique(na.omit(dMOHMaster[,c("HR01","HR03")]))
setnames(newDOB,c("HR01","HR03_new"))

dWorkers <- merge(dWorkers,newDOB,by="HR01",all.x=T)
nrow(dWorkers)
sum(!is.na(dWorkers$HR03))
dWorkers[!is.na(HR03_new),HR03:=HR03_new]
sum(!is.na(dWorkers$HR03))
nrow(dWorkers)

### UPDATING CW00 FOR ALL MOH WORKERS
newCW00 <- unique(na.omit(dMOHMaster[,c("HR01","CW00")]))
setnames(newCW00,c("HR01","CW00_new"))

dWorkers <- merge(dWorkers,newCW00,by="HR01",all.x=T)
nrow(dWorkers)
sum(!is.na(dWorkers$CW00))
dWorkers[!is.na(CW00_new),CW00:=as.character(CW00_new)]
sum(!is.na(dWorkers$CW00))
nrow(dWorkers)
dWorkers[,CW00_new:=NULL]

### FIX 

#So, could you please make sure to change the codes in the MOH West Bank list: all 221213 needs to be changed to 221101.
#We need to do that so that they are not be included under the indicator of doctors in residency training.
MOH_WB <- dFacilities[facilitySector=="Ministry of Health" & IDH03 %in% dLocation[isGaza==0]$localityCode]$IDH00
dWorkers[IDH00 %in% MOH_WB & CW00 == "221213", CW00:="221101"]
dWorkers[IDH00 %in% MOH_WB & CW06 == "221213", CW06:="221101"]


######## MOH WORKERS END

###To solve this, I would like us to delete the code 321302 and replace all records with CW00 or CW06 = 321302 to 532905. 532905 is the code you used for the calculations of pharmacy assistant.
dWorkers[CW00 == "321302", CW00:="532905"]
dWorkers[CW06 == "321302", CW06:="532905"]


# update old workers facilities data with new facilities data
xtabs(~updatedFacilitiesList$IDH01)
xtabs(~updatedFacilitiesList$IDH01_T)
setnames(updatedFacilitiesList,
         c("IDH01","IDH01_T","IDH02"),
         c("IDH02","IDH02_T","IDH04"))
xtabs(~updatedFacilitiesList$IDH02)
xtabs(~updatedFacilitiesList$IDH02_T)

updateWorkerNames <- c("IDH00","IDH02","IDH02_T","IDH04","IDH03","IDH03_T")
for(name in updateWorkerNames){
  if(name=="IDH00") next
  dWorkers[,(name):=NULL]
}
nrow(dWorkers)
dWorkers <- merge(dWorkers, updatedFacilitiesList[,updateWorkerNames], by="IDH00",all.x=T)
nrow(dWorkers)

# IF dWorkers$IDH03 is missing, use dFacilities$IDH03 and link on IDH00
fixable <- unique(dFacilities[,c("IDH00","IDH03")])
setnames(fixable,"IDH03","IDH03_from_facility")
nrow(dWorkers)
dWorkers <- merge(dWorkers,fixable,by="IDH00",all.x=T)
nrow(dWorkers)
dWorkers[is.na(IDH03),IDH03:=IDH03_from_facility]
nrow(dWorkers)


# WORKER CODES
dWorkers[,CW00:=as.numeric(CW00)]
dWorkers[,CW06:=as.numeric(CW06)]

oldToNew <- readxl::read_excel(file.path(org::PROJ$RAW,"Groups - specialists_changing.xlsx"))

dSpecializedDoctors <- readxl::read_excel(file.path(org::PROJ$RAW,
                                                   "Groups - ULTIMIT.xlsx"),
                                         sheet = "Specialized doctor")
dSpecializedDoctors <- dSpecializedDoctors[,c("Code of profession","Profession")]
setnames(dSpecializedDoctors,c("CW00","doctor_specialization"))
setnames(oldToNew,c("CW00","newVal"))
nrow(dSpecializedDoctors)
dSpecializedDoctors <- merge(dSpecializedDoctors,oldToNew,by="CW00",all=T)
nrow(dSpecializedDoctors)
setDT(dSpecializedDoctors)
dSpecializedDoctors[!is.na(newVal),CW00:=newVal]
dSpecializedDoctors[,newVal:=NULL]
dSpecializedDoctors <- dSpecializedDoctors[,paste0(doctor_specialization,collapse="/"),by=CW00]
setnames(dSpecializedDoctors,"V1","doctor_specialization")

nrow(dWorkers)
dWorkers <- merge(dWorkers,oldToNew,by="CW00",all.x=T)
nrow(dWorkers)
dWorkers[!is.na(newVal),CW00:=newVal]
dWorkers[,newVal:=NULL]

nrow(dWorkers)
dWorkers <- merge(dWorkers,dSpecializedDoctors[!is.na(dSpecializedDoctors$CW00),],by="CW00",all.x=T)
nrow(dWorkers)

dSpecializedDoctors <- readxl::read_excel(file.path(org::PROJ$RAW,
                                                   "Groups - ULTIMIT.xlsx"),
                                         sheet = "Specialized doctor")
dSpecializedDoctors <- dSpecializedDoctors[,c("Code of profession","Profession")]
setnames(dSpecializedDoctors,c("CW06","CW06doctor_specialization"))
setnames(oldToNew,c("CW06","newVal"))
nrow(dSpecializedDoctors)
dSpecializedDoctors <- merge(dSpecializedDoctors,oldToNew,by="CW06",all=T)
nrow(dSpecializedDoctors)
setDT(dSpecializedDoctors)
dSpecializedDoctors[!is.na(newVal),CW06:=newVal]
dSpecializedDoctors[,newVal:=NULL]

nrow(dWorkers)
dWorkers <- merge(dWorkers,oldToNew,by="CW06",all.x=T)
nrow(dWorkers)
dWorkers[!is.na(newVal),CW06:=newVal]
dWorkers[,newVal:=NULL]
dSpecializedDoctors <- dSpecializedDoctors[,paste0(CW06doctor_specialization,collapse="/"),by=CW06]
setnames(dSpecializedDoctors,"V1","CW06doctor_specialization")

nrow(dWorkers)
dWorkers <- merge(dWorkers,dSpecializedDoctors[!is.na(dSpecializedDoctors$CW06),],by="CW06",all.x=T)
nrow(dWorkers)

sum(dWorkers$doctor_specialization!=dWorkers$CW06doctor_specialization,na.rm=T)

dWorkers[doctor_specialization!=CW06doctor_specialization]
dWorkers[,BOTHdoctor_specialization:=doctor_specialization]
dWorkers[is.na(BOTHdoctor_specialization),BOTHdoctor_specialization:=CW06doctor_specialization]

xtabs(~dWorkers$doctor_specialization)
xtabs(~dWorkers$BOTHdoctor_specialization)

sum(!is.na(dWorkers$doctor_specialization))
sum(!is.na(dWorkers$BOTHdoctor_specialization))

dWorkerCodes <- list()
for(i in c(
  "Doctor",
  "residentdoctor",
  "Specialized doctor",
  "Dentist",
  "Pharmacist",
  "Nurse",
  "Midwife",
  "Psychologist,counselors, therap",
  "Psychiatrist",
  "Allied health sciences",
  "Alternative  Medicine",
  "Administrative & support staff",
  "GP",
  "FamilyPhysician",
  "Radiologist",
  "LabTech",
  "PharmacyAssistant",
  "medgroupspecialists",
  "surgicalgroupspecialists",
  "othergroupspecialists",
  "physiotherapists012019",
  "speech",
  "audio",
  "dietnut",
  "foot",
  "rehabilitation",
  "chw"
)){
    dWorkerCodes[[i]] <- readxl::read_excel(file.path(org::PROJ$RAW,
                                                   "Groups - ULTIMIT.xlsx"),
                                         sheet = i)
    dWorkerCodes[[i]]$groupedProfession <- i
    if(ncol(dWorkerCodes[[i]])!=5) dWorkerCodes[[i]]$`Profession sub-category` <- ""
    if(i!="Doctor"){
      dWorkerCodes[[i]] <- dWorkerCodes[[i]][names(dWorkerCodes[["Doctor"]])]  
    }
}
for(i in names(dWorkerCodes)){
    newName <- stringr::str_replace_all(i,"[& ,]","")
    newName <- sprintf("isProf_%s",newName)
    dWorkerCodes[[i]][[newName]] <- 1
}
dWorkerCodes <- rbindlist(dWorkerCodes,fill=T)
setnames(dWorkerCodes,c(1:5),c("CW00","profession","arabicProfession","professionGrouped","progessionSubCategory"))

professionVarsTemp <- c(
  "isProf_Doctor",
  "isProf_Specializeddoctor",
  "isProf_Dentist",          
  "isProf_Pharmacist",
  "isProf_Nurse",
  "isProf_Midwife",
  "isProf_Psychologistcounselorstherap",
  "isProf_Psychiatrist",
  "isProf_Alliedhealthsciences",
  "isProf_AlternativeMedicine",
  "isProf_Administrativesupportstaff",
  "isProf_GP",
  "isProf_FamilyPhysician",
  "isProf_Radiologist",
  "isProf_LabTech",
  "isProf_PharmacyAssistant",
  "isProf_residentdoctor",
  "isProf_medgroupspecialists",
  "isProf_surgicalgroupspecialists",
  "isProf_othergroupspecialists",
  "isProf_physiotherapists012019",
  "isProf_speech",
  "isProf_audio",
  "isProf_dietnut",
  "isProf_foot",
  "isProf_rehabilitation",
  "isProf_chw"
  )

professionVarsTempHealthCare <- c(
  "isProf_Doctor",
  "isProf_Specializeddoctor",
  "isProf_Dentist",          
  "isProf_Pharmacist",
  "isProf_Nurse",
  "isProf_Midwife",
  "isProf_Psychologistcounselorstherap",
  "isProf_Psychiatrist",
  "isProf_Alliedhealthsciences",
  "isProf_GP",
  "isProf_FamilyPhysician"
  )
professionVars <- c(professionVarsTemp,"isProf_Healthworker","isProf_DocNurseMid")

for (col in professionVarsTemp) dWorkerCodes[is.na(get(col)), (col) := 0]
dWorkerCodes <- dWorkerCodes[, lapply(.SD, max, na.rm=T), by = CW00, .SDcols = professionVarsTemp]
dWorkerCodes[,isProf_Healthworker:=matrixStats::rowMaxs(as.matrix(.SD)),.SDcols=professionVarsTempHealthCare]
dWorkerCodes[,isProf_DocNurseMid:=matrixStats::rowMaxs(as.matrix(.SD)),.SDcols=c("isProf_Doctor","isProf_Nurse","isProf_Midwife")]

dWorkerCodes <- dWorkerCodes[!is.na(CW00)]

nrow(dWorkers)
dWorkers <- merge(dWorkers,dWorkerCodes,by="CW00",all.x=T)
nrow(dWorkers)

# NOW REDO FOR CW06
namesToChange <- names(dWorkerCodes)[stringr::str_detect(names(dWorkerCodes),"isProf")]
setnames(dWorkerCodes,namesToChange,paste0("CW06",namesToChange))
setnames(dWorkerCodes,"CW00","CW06")
nrow(dWorkers)
dWorkers[,CW06:=as.numeric(CW06)]
dWorkers <- merge(dWorkers,dWorkerCodes,by="CW06",all.x=T)
nrow(dWorkers)



for(i in professionVars){
  newVar <- sprintf("BOTH_%s",i)
  oldVar1 <- i
  oldVar2 <- sprintf("CW06%s",i)
  dWorkers[(!is.na(get(oldVar1))) | (!is.na(get(oldVar2))),(newVar):=0]
  dWorkers[get(oldVar1)==1,(newVar):=1]
  dWorkers[get(oldVar2)==1,(newVar):=1]
}

for(i in professionVars){
  print(sprintf("***%s***",i))
  tmpdata <- dWorkers[get(sprintf("BOTH_%s",i))==1]
  expression <- sprintf("print(xtabs(~tmpdata$%s+tmpdata$CW06%s,addNA=T))",i,i) 
   eval(parse(text=expression))
}

sum(is.na(dWorkers$CW00))
sum(is.na(dWorkers$CW06))
sum(is.na(dWorkers$CW00) & is.na(dWorkers$CW06))
sum(is.na(dWorkers$CW00) & !is.na(dWorkers$CW06))

professionVarsBOTH <- paste0("BOTH_",professionVars)

# save CW00 as CW00!
for(i in professionVars){
  newVar <- sprintf("CW00%s",i)
  oldVar1 <- i
  dWorkers[,(newVar):=get(i)]
}

# if CW00_AND_CW06==TRUE then copy professionVarsBOTH values into professionVars
if(CW00_AND_CW06){
  for(i in 1:length(professionVars)){
    dWorkers[,(professionVars[i]):=get(professionVarsBOTH[i])]
  }
}

#### all midwifes must be female
dWorkers[BOTH_isProf_Midwife==1,HR02:=2]

# Remove east jerusalem non-hospitals
#badFacilities <- dFacilities[
#  IDH03 %in% c(dLocation[district=="East Jerusalem (J1)"]$localityCode) &
#  IS06!=9]$IDH00
#nrow(dWorkers)
#dWorkers <- dWorkers[!IDH00 %in% badFacilities]
#nrow(dWorkers)
#dFacilities <- dFacilities[!IDH00 %in% badFacilities]

#dFacilities[NUMDUP>1,c("IDH00","IDH01","IDH03","IS04","IDH02")]

# POPULATION
pop <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,"data_richard/pop_estimates_2017.xlsx")))
setnames(pop,c("districtName","pop","districtCode","area"))

popunrwa <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,"data_richard/pop_estimates_2017_unrwa.xlsx")))
setnames(popunrwa,c("districtName","pop","districtCode","area"))


PrintTableNPerc <- function(d){
  print(xtabs(~d$numerator,addNA=TRUE))
  cat(sprintf("\nN=%s\n", nrow(d)))
  cat(sprintf("Percentage indicator: %s%%\n", RAWmisc::Format(mean(d$numerator*100,na.rm=T),1)))
}

cat(dFacilities$IDH00[duplicated(dFacilities$IDH00)],file=file.path(SHARED_TODAY,"DUPLICATED_FACILITY_IDH00_NUMBERS.txt"))

# SAVING FILES
openxlsx::write.xlsx(dFacilities,file.path(SHARED_TODAY,"dFacilities.xlsx"))
openxlsx::write.xlsx(dWorkers,file.path(SHARED_TODAY,"dWorkers.xlsx"))
openxlsx::write.xlsx(masterdED03,file.path(SHARED_TODAY,"dED03.xlsx"))



# remove MOH retired, etc
(a <- nrow(dWorkers))
dWorkers <- dWorkers[!HR01 %in% dMOHToRemove]
(b <- nrow(dWorkers))
b-a

dWorkers[,age:=floor(as.numeric(difftime("2018-01-01",HR03,units="days"))/365.25)]

dWorkers[,ageCat:=as.character(NA)]
dWorkers[age>=18 & age<=30,ageCat:="18-30"]
dWorkers[age>=31 & age<=45,ageCat:="31-45"]
dWorkers[age>=46 & age<=54,ageCat:="46-54"]
dWorkers[age>=55 & age<=59,ageCat:="55-59"]
dWorkers[age>=60,ageCat:="60+"]

sum(is.na(dWorkers$age))
```

```{r, warning=FALSE}
nrow(dFacilities)
nrow(dWorkers)
```

```{r, warning=F}
dWorkers[,isGaza:=as.numeric(NA)]
dWorkers[,isWB:=as.numeric(NA)]

dWorkers[,isPalestineUrban:=as.numeric(NA)]
dWorkers[,isGazaUrban:=as.numeric(NA)]
dWorkers[,isWBUrban:=as.numeric(NA)]

dWorkers[,isPalestineRural:=as.numeric(NA)]
dWorkers[,isGazaRural:=as.numeric(NA)]
dWorkers[,isWBRural:=as.numeric(NA)]

dWorkers[,isPalestineCamp:=as.numeric(NA)]
dWorkers[,isGazaCamp:=as.numeric(NA)]
dWorkers[,isWBCamp:=as.numeric(NA)]

dWorkers[,isPalestine:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

dWorkers[IDH03 %in% dLocation[urbanRural=="Urban"]$localityCode,
         isPalestineUrban:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1 & urbanRural=="Urban"]$localityCode,
         isGazaUrban:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0 & urbanRural=="Urban"]$localityCode,
         isWBUrban:=1]

dWorkers[IDH03 %in% dLocation[urbanRural=="Rural"]$localityCode,
         isPalestineRural:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1 & urbanRural=="Rural"]$localityCode,
         isGazaRural:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0 & urbanRural=="Rural"]$localityCode,
         isWBRural:=1]

dWorkers[IDH03 %in% dLocation[urbanRural=="Camp"]$localityCode,
         isPalestineCamp:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1 & urbanRural=="Camp"]$localityCode,
         isGazaCamp:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0 & urbanRural=="Camp"]$localityCode,
         isWBCamp:=1]

dWorkers[,isFemale:=HR02-1]

districtNames <- c("isPalestine","isGaza","isWB",
                   "isPalestineUrban","isGazaUrban","isWBUrban",
                   "isPalestineRural","isGazaRural","isWBRural",
                   "isPalestineCamp","isGazaCamp","isWBCamp")

for(i in unique(dLocation$district)){
  newName <- stringr::str_replace_all(i,"[& ,\\-\\(\\)]","")
  newName <- sprintf("isDistrict_%s",newName)
  districtNames <- c(districtNames, newName)
  dWorkers[,(newName):=as.numeric(NA)]
  dWorkers[IDH03 %in% dLocation[district==i]$localityCode, (newName):=1]
}

ALL_DISTRICT_NAMES <- districtNames
```

## MISSING FACILITIES

```{r, warning=FALSE}
openxlsx::write.xlsx(unique(dFacilities[!IDH00 %in% unique(dWorkers$IDH00),c("IDH00","IDH02")]),
                     file.path(SHARED_TODAY,"not_connected_IDH00_from_facilities.xlsx"))

openxlsx::write.xlsx(unique(dWorkers[!IDH00 %in% unique(dFacilities$IDH00),c("IDH00")]),
                     file.path(SHARED_TODAY,"not_connected_IDH00_from_workers.xlsx"))

```


## FINDING HR01==999999999

```{r, warning=FALSE}
missingHR01 <- dWorkers[HR01==999999999,
                          c("HR00","HR01","IDH04","HR02","HR03","IDH00","IDH03","CW00")]
dLoc <- unique(dLocation[,c("localityCode","localityName","district","gazaWBEJ")])

setnames(dLoc,"localityCode","IDH03")
nrow(missingHR01)
missingHR01 <- merge(missingHR01,dLoc,by="IDH03",all.x=T)
nrow(missingHR01)

openxlsx::write.xlsx(missingHR01,file.path(SHARED_TODAY,"missing_HR01.xlsx"))
```

## Multiple names, same ID number

```{r, warning=FALSE}
missingHR01 <- unique(dWorkers[,c("HR00","HR01")])
missingHR01[,numberOfNames:=.N,by=.(HR01)]
missingHR01 <- dWorkers[HR01 %in% missingHR01[numberOfNames>1]$HR01,
                          c("HR00","HR01","IDH04","HR02","HR03","IDH00","IDH03","CW00","CW00_T")]
dLoc <- unique(dLocation[,c("localityCode","localityName","district","gazaWBEJ")])

setnames(dLoc,"localityCode","IDH03")
nrow(missingHR01)
missingHR01 <- merge(missingHR01,dLoc,by="IDH03",all.x=T)
nrow(missingHR01)
setorder(missingHR01,HR01, HR00)

openxlsx::write.xlsx(missingHR01,file.path(SHARED_TODAY,"multiple_names_same_hr01.xlsx"))
```

## MISSING CW00 OR CW06

```{r, warning=FALSE}
missingCW <- dWorkers[is.na(CW00)]
missingCW <- merge(missingCW, dFacilities[,c("IDH00","facilitySector","IS04","IS06")], by="IDH00")
missingCW <- missingCW[,c("HR00","HR01","CW00","CW06","IS04","IS06","facilitySector","IDH03","IDH04")]

dLoc <- unique(dLocation[,c("localityCode","district","gazaWBEJ")])
setnames(dLoc,"localityCode","IDH03")

nrow(missingCW)
missingCW <- merge(missingCW,dLoc,by="IDH03",all.x=T)
nrow(missingCW)

openxlsx::write.xlsx(missingCW,file.path(SHARED_TODAY,"missing_CW00.xlsx"))
```


## FINDING MISSING GENDER PERSON

```{r, warning=FALSE}
missingGender <- dWorkers[is.na(HR02),
                          c("HR00","HR01")]
openxlsx::write.xlsx(missingGender,file.path(SHARED_TODAY,"missing_gender.xlsx"))
```


## LIST OF ALL FACILITIES IN AREA C AND JORDAN VALLEY

```{r, warning=FALSE}
areaC <- dFacilities[RE02==1,
                           c("IDH00","IDH01","IDH02","IDH03","IS06","IS04","facilitySector","RE01","RE02")]

openxlsx::write.xlsx(areaC,file.path(SHARED_TODAY,"facilities_areaC.xlsx"))

jordanvalley <- dFacilities[isJordanValley==1,
                           c("IDH00","IDH01","IDH02","IDH03","IS06","IS04","facilitySector","RE01","RE02")]

openxlsx::write.xlsx(jordanvalley,file.path(SHARED_TODAY,"facilities_jordan_valley.xlsx"))
```

## VALIDATING IDHs in WORKERS TO IDHs in FACILITIES

```{r, warning=FALSE}
dW <- dWorkers[,c("IDH00","IDH02","IDH03")] # district, locality
dF <- dFacilities[,c("IDH00","IDH01","IDH03")] # district, locality

setnames(dW,c("IDH00","IDH02_W_dist","IDH03_W_loc"))
setnames(dF,c("IDH00","IDH01_F_dist","IDH03_F_loc"))

nrow(dW)
d <- merge(dW,dF,by="IDH00",all.x=T)
nrow(d)

d[,districtMatch:=IDH02_W_dist==IDH01_F_dist]
d[,localityMatch:=IDH03_W_loc==IDH03_F_loc]

xtabs(~d$districtMatch, addNA = T)
xtabs(~d$localityMatch, addNA = T)

sum(is.na(dW$IDH02_W_dist))
sum(is.na(dF$IDH01_F_dist))

openxlsx::write.xlsx(d[,c("IDH00","IDH02_W_dist","IDH03_W_loc","IDH01_F_dist","IDH03_F_loc","districtMatch","localityMatch")],file.path(SHARED_TODAY,"VALIDATING IDHs in WORKERS TO IDHs in FACILITIES.xlsx"))
```


# Sept 12 2018 Requests

## Possible duplications in two facilities

```{r, warning=FALSE}
temp <- unique(dWorkers[IDH00 %in% c(1913028, 4500006),c("IDH00","HR01")])
temp[,exists:="YES"]
temp <- dcast.data.table(temp,HR01~IDH00)

openxlsx::write.xlsx(temp, file.path(SHARED_TODAY,"workers_IDH00_1913028_4500006.xlsx"))
```

## Workers in both gaza and wb

```{r, warning=FALSE}
tempG <- dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode]
tempWB <- dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode]

temp <- tempG[IDH00 %in% tempWB$IDH00,c("IDH00")]

openxlsx::write.xlsx(temp, file.path(SHARED_TODAY,"workers_in_both_gaza_and_wb.xlsx"))
```

## Facilities missing IDH01 and/or IDH03

```{r, warning=FALSE}
temp <- dFacilities[is.na(IDH01) | is.na(IDH03)]

openxlsx::write.xlsx(temp, file.path(SHARED_TODAY,"Facilities_missing_IDH01_and_or_IDH03.xlsx"))
```

\newpage

# June 2018 MOH Requests

## Physicians who answered yes to receiving CPD in the last year by sector

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00",all.x=T)
nrow(dWorkers)
nrow(dMaster)

```


### Results

```{r message=FALSE, warning=FALSE}
for(i in unique(dMaster$facilitySector)){
  if(is.na(i)){
    d <- dMaster[is.na(facilitySector) & isProf_Doctor==1]
  } else {
    d <- dMaster[facilitySector==i & isProf_Doctor==1]
  }
  d[,numerator:=as.numeric(NA)]
  d[!is.na(SK02),numerator:=0]
  d[SK02==1,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  cat(sprintf("***** %s *****\n",i))
  PrintTableNPerc(d)
  cat("\n\n")
}
```

## Total number of General Practitioners in Palestine, West Bank, Gaza

### Results

```{r}
dWorkers[,isGaza:=as.numeric(NA)]
dWorkers[,isWB:=as.numeric(NA)]

dWorkers[,isPalestine:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

for(i in c("isPalestine","isWB","isGaza")){
  d <- dWorkers[get(i)==1 & isProf_GP==1,.(
    numerator=1
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  cat(sprintf("***** %s *****\n",i))
  PrintTableNPerc(d)
  cat("\n\n")
}

```

## Distribution of GPs by sector in Palestine, West Bank, Gaza

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00",all.x=T)
nrow(dWorkers)
nrow(dMaster)

```


### Results

```{r message=FALSE, warning=FALSE}
for(j in c("isPalestine","isWB","isGaza")) for(i in unique(dMaster$facilitySector)){
  if(is.na(i)){
    d <- dMaster[get(j)==1 & is.na(facilitySector) & isProf_GP==1]
  } else {
    d <- dMaster[get(j)==1 & facilitySector==i & isProf_GP==1]
  }
  
  d <- d[,.(
    numerator=1
  ),by=.(
    HR01
  )]
  
  cat(sprintf("***** %s %s *****\n",j,i))

   if(j=="isPalestine"){
    usePop <- pop[districtName=="Palestine population"]$pop
  } else if(j=="isGaza"){
    usePop <- pop[districtName=="Gaza Population"]$pop
  } else if(j=="isWB"){
    usePop <- pop[districtName=="West Bank Population"]$pop
  } else if(j=="isEJerusalem"){
    usePop <- 0
  }
  
  cat(sprintf("\nNumber of people=%s\n",
              nrow(d)
              ))
  
  cat(sprintf("People per 1,000 pop: %s\n\n",
              round(nrow(d)/usePop*1000,4)
              ))
}
```

## Distribution of GPs between PHC and hospitals by sector in Palestine, West Bank, Gaza

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector","IS06")], by="IDH00",all.x=T)
nrow(dWorkers)
nrow(dMaster)
dMaster[!is.na(IS06),isPHC:=0]
dMaster[!is.na(isPHC) & IS06==4,isPHC:=1]

dMaster[!is.na(IS06),isHospital:=0]
dMaster[!is.na(isHospital) & IS06==9,isHospital:=1]
```


### Results

```{r message=FALSE, warning=FALSE}
for(j in c("isPalestine","isWB","isGaza")) for(i in unique(dMaster$facilitySector)) {
  if(is.na(i)){
    d <- dMaster[is.na(facilitySector) & isProf_GP==1 & get(j)==1]
  } else {
    d <- dMaster[facilitySector==i & isProf_GP==1 & get(j)==1]
  }
  
  d <- d[,.(
    numGPsInPHC=max(isPHC,na.rm=T),
    numGPsInHospitals=max(isHospital,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d <- d[,.(
    numGPsInPHC=sum(numGPsInPHC,na.rm=T),
    numGPsInHospitals=sum(numGPsInHospitals,na.rm=T)
  )]
  
  cat(sprintf("***** %s %s *****\n",j,i))
  print(d)
  cat("\n\n")
}
```

## Total number of specialized doctors by specialty by sector in Palestine, West Bank, Gaza

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector","IS06")], by="IDH00",all.x=T)
nrow(dWorkers)
nrow(dMaster)
```


### Results

GO TO: "CW00_Total number of specialized doctors by specialty by sector in Palestine, West Bank, Gaza.xlsx"

```{r message=FALSE, warning=FALSE}
for(i in c("isPalestine","isWB","isGaza")){
  d <- dMaster[get(i)==1]
  d <- d[!is.na(doctor_specialization),.(
    numerator=1
  ),by=.(
    HR01,
    facilitySector,
    doctor_specialization
  )]
  d <- d[,
         .(num=sum(numerator)),
         by=.(
           facilitySector,
           doctor_specialization
         )
         ]
  setorder(d,facilitySector,doctor_specialization)
  openxlsx::write.xlsx(d,
                       file.path(SHARED_TODAY,sprintf("%s_Total number of specialized doctors by specialty by sector in Palestine, West Bank, Gaza.xlsx",i)))
}
```

## Age distribution of General Practitioners in Palestine, West Bank, Gaza

```{r message=FALSE, warning=FALSE}

dWorkers[,isGaza:=as.numeric(NA)]
dWorkers[,isWB:=as.numeric(NA)]

dWorkers[,isPalestine:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

for(prof in c("isProf_GP")) for(area in c(
    "isPalestine",
    "isGaza",
    "isWB"
  )){
    d <- dWorkers[get(prof)==1 & get(area)==1]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     ageCat
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=ageCat]
    d[!is.na(ageCat),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    d[,ageCat:=factor(ageCat,levels=c(
      "18-30",
      "31-45",
      "46-54",
      "55-59",
      "60+"
      ))]
    setorder(d,ageCat)

    cat("*******\n")
    cat(sprintf("%s %s\n",prof,area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

## Age distribution of General Practitioners by sector in West Bank, Gaza

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00",all.x=T)
nrow(dWorkers)
nrow(dMaster)
```

```{r message=FALSE, warning=FALSE}

for(prof in c("isProf_GP")) for(sector in unique(dMaster$facilitySector)) for(area in c(
    "isPalestine",
    "isGaza",
    "isWB"
  )){
    if(is.na(sector)) next
  
    d <- dMaster[get(prof)==1 & facilitySector==sector & get(area)==1]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     ageCat
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=ageCat]
    d[!is.na(ageCat),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    d[,ageCat:=factor(ageCat,levels=c(
      "18-30",
      "31-45",
      "46-54",
      "55-59",
      "60+"
      ))]
    setorder(d,ageCat)

    cat("*******\n")
    cat(sprintf("%s %s %s\n",prof,sector,area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

## Gender distribution of GPs in Palestine, West Bank, Gaza

```{r message=FALSE, warning=FALSE}

dWorkers[,isGaza:=as.numeric(NA)]
dWorkers[,isWB:=as.numeric(NA)]

dWorkers[,isPalestine:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

dWorkers[,isFemale:=HR02-1]

for(prof in c("isProf_GP")) for(area in c(
    "isPalestine",
    "isGaza",
    "isWB"
  )){
    d <- dWorkers[get(prof)==1 & get(area)==1]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     isFemale
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=isFemale]
    d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    setorder(d,isFemale)

    cat("*******\n")
    cat(sprintf("%s %s\n",prof,area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

## Gender distribution of GPs by sector in West Bank, Gaza

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00",all.x=T)
nrow(dWorkers)
nrow(dMaster)
```

```{r message=FALSE, warning=FALSE}

for(prof in c("isProf_GP")) for(sector in unique(dMaster$facilitySector)) for(area in c(
    "isPalestine",
    "isGaza",
    "isWB"
  )){
    if(is.na(sector)) next
  
    d <- dMaster[get(prof)==1 & facilitySector==sector & get(area)==1]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     isFemale
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=isFemale]
    d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    setorder(d,isFemale)

    cat("*******\n")
    cat(sprintf("%s %s %s\n",prof,sector,area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

## Distribution of GPs by country of graduation

SEARCH BELOW FOR "WHAT COUNTRY DO GPs GRADUATE FROM CW00 AND CW06"

## Total number of Family physicians in Palestine, West Bank, Gaza

```{r}
dWorkers[,isGaza:=as.numeric(NA)]
dWorkers[,isWB:=as.numeric(NA)]

dWorkers[,isPalestine:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

for(i in c("isPalestine","isWB","isGaza")){
  d <- dWorkers[get(i)==1 & isProf_FamilyPhysician==1,.(
    numerator=1
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  cat(sprintf("***** %s *****\n",i))
  PrintTableNPerc(d)
  cat("\n\n")
}

```

## Total number of Family physicians by sector in West Bank and Gaza

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00",all.x=T)
nrow(dWorkers)
nrow(dMaster)

```

### Results

```{r message=FALSE, warning=FALSE}
for(i in c("isPalestine","isWB","isGaza")) for(j in unique(dMaster$facilitySector)){
  if(is.na(j)) next
  d <- dMaster[get(i)==1 & facilitySector==j & isProf_FamilyPhysician==1,.(
    numerator=1
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  cat(sprintf("***** %s %s *****\n",i,j))
  print(sum(d$numerator))
  cat("\n\n")
}
```

## Density of Family physicians to Palestine population, West Bank, Gaza

### Results

```{r}
dWorkers[,isGaza:=as.numeric(NA)]
dWorkers[,isWB:=as.numeric(NA)]

dWorkers[,isPalestine:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

for(i in c("isPalestine","isWB","isGaza")){
  d <- dWorkers[get(i)==1 & isProf_FamilyPhysician==1,.(
    numerator=1
  ),by=.(
    HR01
  )]
  
  if(i=="isPalestine"){
    p <- pop[districtName=="Palestine population"]$pop
  } else if(i=="isWB"){
    p <- pop[districtName=="West Bank Population"]$pop
  } else if(i=="isGaza"){
    p <- pop[districtName=="Gaza Population"]$pop
  }
  
  d[is.infinite(numerator),numerator:=NA]
  res <- sum(d$numerator,na.rm=T)
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Num: %s, Pop: %s, Num/1000: %s\n",res,round(p),res/p*1000))
  cat("\n\n")
}

```

## Distribution of GPs by geographic area

### Results

```{r}
dLocation[,IDH03:=localityCode]
dMaster <- merge(dWorkers, dLocation[,c("IDH03","region","district")], by="IDH03",all.x=T)
nrow(dWorkers)
```

```{r}
for(i in unique(dMaster$region)){
  if(is.na(i)) next
  d <- dMaster[region==i & isProf_GP==1,.(
    numerator=1
  ),by=.(
    HR01
  )]
  
  
  d[is.infinite(numerator),numerator:=NA]
  res <- sum(d$numerator,na.rm=T)
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Num: %s\n",res))
  cat("\n\n")
}
```

## Distribution of GPs by facility type


```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","IS06")], by="IDH00",all.x=T)
nrow(dWorkers)
nrow(dMaster)

```

### Results

```{r message=FALSE, warning=FALSE}
d <- dMaster[isProf_GP==1,
             .(numerator=1),
             by=.(HR01,IS06)]
d <- d[,.(num=sum(numerator)),by=.(IS06)]
setorder(d,IS06)
print(d)
```


## MOH GP GEOGRAPHY IS06==4/IS06==9

```{r, warning=FALSE}

dWorkers[,isPalestine:=1]
dWorkers[,isGaza:=0]
dWorkers[,isWB:=0]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

dWorkers[,campUrbanRural:=as.character(NA)]
dWorkers[IDH03 %in% dLocation[urbanRural=="Urban"]$localityCode,
         campUrbanRural:="Urban"]
dWorkers[IDH03 %in% dLocation[urbanRural=="Rural"]$localityCode,
         campUrbanRural:="Rural"]
dWorkers[IDH03 %in% dLocation[urbanRural=="Camp"]$localityCode,
         campUrbanRural:="Camp"]

districtNames <- c("isPalestine","isGaza","isWB")

stack <- data.table(expand.grid(
  prof="isProf_GP",
  dist=ALL_DISTRICT_NAMES,
  sector="Ministry of Health",
  xIS06=c(4,9),
  stringsAsFactors = F))

dLocation[,IDH03:=localityCode]
dMaster <- merge(dWorkers, dLocation[,c("IDH03","region","district")], by="IDH03",all.x=T)
nrow(dWorkers)
nrow(dMaster)

nrow(dMaster)
dMaster <- merge(dMaster, dFacilities[,c("IDH00","facilitySector","IS06")], by="IDH00", all.x=T)
nrow(dMaster)

unique(dMaster[is.na(region),"IDH03"])

for(i in 1:nrow(stack)){
  
  ## by region
  s <- stack[i]
  d <- dMaster[get(s$prof)==1 & get(s$dist)==1]
  d <- d[facilitySector==s$sector]
  d <- d[IS06==s$xIS06]
  
  d[,numerator:=1]
  d <- d[,.(
      person=max(numerator,na.rm=T),
      jobs=sum(numerator,na.rm=T)
    ),by=.(
      HR01
    )]
  
  cat(sprintf("***** %s - %s - %s - IS06=%s *****\n",s$prof,s$dist,s$sector,s$xIS06))
  print(sprintf("Number of jobs: %s",sum(d$jobs)))
  print(sprintf("Number of people-regions: %s",sum(d$person)))
  cat("\n\n")
  
}
```

\newpage

# June 2018 UNRWA

## Total number of doctors working at UNRWA in Palestine/WB/Gaza

### Results

```{r message=FALSE, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
unique(dMaster$facilitySector)

for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- popunrwa[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- popunrwa[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- popunrwa[districtName=="Gaza Population"]$pop
  }
  d <- dMaster[isProf_Doctor==1 & get(location)==1 & facilitySector=="UNRWA"]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

## Density of all professions in Palestine, West Bank, Gaza

### Results

```{r message=FALSE, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
unique(dMaster$facilitySector)

for(prof in professionVars) for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",prof,"  ",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- popunrwa[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- popunrwa[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- popunrwa[districtName=="Gaza Population"]$pop
  }
  d <- dMaster[get(prof)==1 & get(location)==1 & facilitySector=="UNRWA"]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

\newpage

# Extra random things Hadeel wanted

Could we also have distribution of health facilities by IS04 and by sector.

For example: how many UNRWA facilities?
How many Military Health services facilities
How many private sector pharmacies?
How many Palestinian Red crescent facilties? 
etc... for each answer in IS04 how many facilities do we have. By IS06 if possible (type of facility). For example: how many UNRWA hospitals and how many UNRWA health centers in Palestine, in West Bank and in Gaza for all sectors and IS04. Thank you

## IS06

```{r, warning=FALSE}
d <- dFacilities[,.(N=.N),by=.(facilitySector,IS06)]
setorder(d,facilitySector,IS06)
print(d)
```

```{r, warning=FALSE}
dLoc <- unique(dLocation[,c("localityCode","district","gazaWBEJ")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities,dLoc,by="IDH03",all.x=T)
d <- d[,.(N=.N),by=.(gazaWBEJ,facilitySector,IS06)]
setorder(d,gazaWBEJ,facilitySector,IS06)
print(d)
```

## IS06 Hospitals, trying to find discrepancy between system and mine

```{r, warning=FALSE}
dLoc <- unique(dLocation[,c("localityCode","district","gazaWBEJ")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities[IS06==9 & facilitySector %in% c("NGO","Private")],dLoc,by="IDH03",all.x=T)

openxlsx::write.xlsx(d,file.path(SHARED_TODAY,"hospital_discrepancies.xlsx"))
```


### Taking a look at JERUSALEM DISTRICT

```{r, warning=FALSE}
d <- dFacilities[IDH03 %in% dLoc[district=="Jerusalem"]$IDH03,.(N=.N),by=.(facilitySector,IS06)]
setorder(d,facilitySector,IS06)
print(d)
```

### Taking a look at AREA C

```{r, warning=FALSE}
d <- dFacilities[RE02==1,.(N=.N),by=.(facilitySector,IS06)]
setorder(d,facilitySector,IS06)
print(d)
```

### Taking a look at JORDAN VALLEY [HADEEL CHECK THIS]

```{r, warning=FALSE}
d <- dFacilities[isJordanValley==1,.(N=.N),by=.(facilitySector,IS06)]
setorder(d,facilitySector,IS06)
print(d)
```

## IS04 ONLY NGOs

```{r, warning=FALSE}
d <- dFacilities[facilitySector=="NGO",.(N=.N),by=.(facilitySector,IS06,IS04)]
setorder(d,facilitySector,IS06,IS04)
setcolorder(d,c("facilitySector","IS06","IS04","N"))
print(d)
```

```{r, warning=FALSE}
dLoc <- unique(dLocation[,c("localityCode","district","gazaWBEJ")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities,dLoc,by="IDH03",all.x=T)
d <- d[facilitySector=="NGO",.(N=.N),by=.(gazaWBEJ,facilitySector,IS06,IS04)]
setorder(d,gazaWBEJ,facilitySector,IS06,IS04)
setcolorder(d,c("gazaWBEJ","facilitySector","IS06","IS04","N"))
print(d)
```



## Diploma vs BA nurse

```{r, warning=FALSE}
d <- dWorkers[isProf_Nurse==1]
d[,numerator:=ED01>=4]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
cat("has a BA or higher, versus diploma or lower\n")
PrintTableNPerc(d)
cat("\n\n")
```

## How many OTHER places have you worked

```{r, warning=FALSE}
d <- copy(dWorkers)
d[,age:=floor(as.numeric(difftime("2018-01-01",HR03,units="days"))/365.25)]

d[,ageCat:=as.character(NA)]
d[age>=18 & age<=30,ageCat:="18-30"]
d[age>=31 & age<=45,ageCat:="31-45"]
d[age>=46 & age<=54,ageCat:="46-54"]
d[age>=55 & age<=59,ageCat:="55-59"]
d[age>=60,ageCat:="60+"]
d[,numerator:=ED01>=4]

d <- d[,.(
  number_places_worked=mean(PW03,na.rm=T)
),by=.(
  HR01,ageCat
)]

d <- d[,.(
  average_number_places_worked=mean(number_places_worked,na.rm=T),
  N=.N
),by=.(ageCat)]

setorder(d,ageCat)
print(d)
```

## How many OTHER places have you worked by profession

```{r, warning=FALSE}
for(i in professionVars){
  d <- dWorkers[get(i)==1]
  d[,age:=floor(as.numeric(difftime("2018-01-01",HR03,units="days"))/365.25)]
  
  d[,ageCat:=as.character(NA)]
  d[age>=18 & age<=30,ageCat:="18-30"]
  d[age>=31 & age<=45,ageCat:="31-45"]
  d[age>=46 & age<=54,ageCat:="46-54"]
  d[age>=55 & age<=59,ageCat:="55-59"]
  d[age>=60,ageCat:="60+"]
  d[,numerator:=ED01>=4]
  
  d <- d[,.(
    number_places_worked=mean(PW03,na.rm=T)
  ),by=.(
    HR01,ageCat
  )]
  
  d <- d[,.(
    average_number_places_worked=mean(number_places_worked,na.rm=T),
    N=.N
  ),by=.(ageCat)]
  
  setorder(d,ageCat)
  cat(sprintf("***** %s *****\n",i))
  print(d)
  cat("\n\n")
}
```

# PCBS REQUESTS

## 1.   Distribution of health workers by Educational Speciality stratified by gender (ED03)

- only include ED03A<=7 [removing both people and records]
- only keep ED03A==max(ED03A) [highest level per person, removing just records]
- we now have problems with people with multiple records at the same level
- only keep ED03B==max(ED03B) [latest year per person, removing just records]
- only keep people whose countries are the same [removing just people!!!]
- keep records with the highest ED03C code [removing just records]
- people who answer as both male and female are recoded to female

```{r, warning=FALSE}
workerLabels <- data.table(readxl::read_excel(file.path(org::PROJ$RAW,
                                             "Educational Specialty ED03 - C.xls")))
setnames(workerLabels,c("arabic_names","ED03C"))
workerLabels <- workerLabels[!is.na(ED03C)]
workerLabels[,N:=.N,by=ED03C]
workerLabels <- workerLabels[N==1]
workerLabels[,N:=NULL]

d <- dWorkers[isProf_Healthworker==1]
d[,isFemale:=HR02-1]
d <- d[,.(isFemale=max(isFemale)),by=.(HR01)]

reducedED03 <- masterdED03[ED03A<=7 & !is.na(ED03C) & HR01 %in% d$HR01]
reducedED03[,maxED03A:=max(ED03A,na.rm=T),by=HR01]
reducedED03 <- reducedED03[maxED03A==ED03A]
reducedED03[,maxYear:=max(ED03B,na.rm=T),by=HR01]
reducedED03 <- reducedED03[maxYear==ED03B]
reducedED03[,num_at_same_level:=.N,by=HR01]
xtabs(~reducedED03$num_at_same_level)

reducedED03[,maxCountry:=max(ED03D,na.rm=T),by=HR01]
reducedED03 <- reducedED03[maxCountry==ED03D | is.na(maxCountry)]
reducedED03[,num_at_same_level:=.N,by=HR01]
xtabs(~reducedED03$num_at_same_level)

reducedED03[,max_ED03C:=max(ED03C),by=HR01]
reducedED03 <- reducedED03[max_ED03C==ED03C]
reducedED03[,num_at_same_level:=.N,by=HR01]
xtabs(~reducedED03$num_at_same_level)

reducedED03[,IDH00:=NULL]
reducedED03[,ED03E:=NULL]
reducedED03[,ED03C_T:=NULL]
reducedED03[,ED03D_T:=NULL]
reducedED03 <- unique(reducedED03)
reducedED03[,num_at_same_level:=.N,by=HR01]
xtabs(~reducedED03$num_at_same_level)

nrow(d)
d <- merge(d,reducedED03,by="HR01",all.x=T)
nrow(d)

res <- d[,.(N=.N),by=.(isFemale,ED03C)]
setorder(res,isFemale,-N)
nrow(res)
res <- merge(res,workerLabels,by=c("ED03C"),all.x=T)
nrow(res)
openxlsx::write.xlsx(res,file.path(SHARED_TODAY,"Distribution of health workers by Educational Speciality stratified by gender.xlsx"))

nrow(d)
d[,ED03D:=as.numeric(ED03D)]
d <- merge(d,dCountryCodes,by="ED03D",all.x=T)
nrow(d)

res <- d[,.(N=.N),by=.(isFemale,ED03C,english)]
setorder(res,isFemale,english,-N)
nrow(res)
res <- merge(res,workerLabels,by=c("ED03C"),all.x=T)
nrow(res)
openxlsx::write.xlsx(res,file.path(SHARED_TODAY,"Distribution of health workers by graduation country, educational specialty by gender.xlsx"))
```

## 3. Distribution of health workers by highest educational level and gender (ED01)
```{r, warning=FALSE}
d <- dWorkers[isProf_Healthworker==1]
d[,isFemale:=HR02-1]
d <- d[,.(
  ED01=max(ED01,na.rm=T),
  isFemale=max(isFemale,na.rm=T)
),by=.(
  HR01
)]
d[is.infinite(ED01),ED01:=NA]
xtabs(~d$ED01+d$isFemale,addNA=T)
```


## 4. Distribution of health workers by years of experience and gender (ED02)
```{r, warning=FALSE}
d <- dWorkers[isProf_Healthworker==1]
d[,isFemale:=HR02-1]
d <- d[,.(
  yearsExperience=max(ED02,na.rm=T),
  isFemale=max(isFemale,na.rm=T)
),by=.(
  HR01
)]
d[,yearsExperience:=cut(yearsExperience,c(-5,4,10,30,500),labels=c("0-4","5-10","11-30","31+"))]
d[is.infinite(yearsExperience),yearsExperience:=NA]
xtabs(~d$yearsExperience+d$isFemale,addNA=T)
```


## Who lives in SAME district THAT THEY WORK IN (BY RECORDS)

### EVERYONE

```{r, warning=FALSE}
dWorkers[,livesInSameDistrictAsWork:= HR08_B==IDH02]
xtabs(~dWorkers$livesInSameDistrictAsWork, addNA=T)
```

### BY PROFESSION

```{r, warning=FALSE}
for(i in professionVars){
  print("")
  print("")
  print("****")
  print(i)
  print(xtabs(~dWorkers[get(i)==1]$livesInSameDistrictAsWork, addNA=T))
}
```


## Who lives RURAL AND WORKS IN URBAN (BY RECORDS)

### EVERYONE

```{r, warning=FALSE}
dWorkers[,livesInRural:= HR08_A %in% dLocation[urbanRural=="Rural"]$localityCode]
dWorkers[,worksInUrban:= IDH03 %in% dLocation[urbanRural=="Urban"]$localityCode]

xtabs(~dWorkers$livesInRural+dWorkers$worksInUrban, addNA=T)
```

### BY PROFESSION

```{r, warning=FALSE}
for(i in professionVars){
  print("")
  print("")
  print("****")
  print(i)
  d <- dWorkers[get(i)==1]
  print(xtabs(~d$livesInRural+d$worksInUrban, addNA=T))
}
```


### sector = Ministry of Health  + IS06 = 4

```{r, warning=FALSE}
keepIDH00 <- dFacilities[facilitySector=="Ministry of Health" & IS06==4]$IDH00

xtabs(~dWorkers[IDH00 %in% keepIDH00]$livesInRural+dWorkers[IDH00 %in% keepIDH00]$worksInUrban, addNA=T)
```

### sector = Ministry of Health  + IS06 = 4 BY PROFESSION

```{r, warning=FALSE}
for(i in professionVars){
  print("")
  print("")
  print("****")
  print(i)
  d <- dWorkers[get(i)==1]
  print(xtabs(~d[IDH00 %in% keepIDH00]$livesInRural+d[IDH00 %in% keepIDH00]$worksInUrban, addNA=T))
}
```

\newpage 

# Pre-service training indicators

## 1. Total number of facilities that provide clinical trainings ( pre-graduation ) in Palestine

- Source: Facility questionnaire
- Calculation: TR01 answer 1
- Indicator description: Total number of health facilities in Palestine that offer clinical trainings sites 

### Results

```{r, warning=FALSE}
xtabs(~dFacilities$TR01,addNA=TRUE)
```

## 1x NEW. Distribution of each type of facility (IS06) that provide clinical trainings by sector and the professions they train in ( this can be obtained from TR02 )

### Results

```{r, warning=FALSE}
dLoc <- unique(dLocation[,c("localityCode","district","gazaWBEJ")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities[TR01==1],dLoc,by="IDH03",all.x=T)
d2 <- copy(d)
d2[,gazaWBEJ:="Palestine"]
d <- rbind(d,d2)
nrow(d)
d <- d[,.(N=.N),by=.(gazaWBEJ,facilitySector,IS06)]
setorder(d,gazaWBEJ,facilitySector,IS06)
openxlsx::write.xlsx(d,file.path(SHARED_TODAY,"clinical_training_facility_is06.xlsx"))
```

```{r, warning=FALSE}
dLoc <- unique(dLocation[,c("localityCode","district","gazaWBEJ")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities[TR01==1],dLoc,by="IDH03",all.x=T)
d2 <- copy(d)
d2[,gazaWBEJ:="Palestine"]
d <- rbind(d,d2)
nrow(d)
d <- melt.data.table(d[,c("IDH00","gazaWBEJ","facilitySector","IS06","TR02_A","TR02_B","TR02_C","TR02_D")],id.vars = c("IDH00","gazaWBEJ","facilitySector","IS06"))
d <- d[!is.na(value)]
setnames(d,"value","TR02")
d <- d[,.(N=.N),by=.(gazaWBEJ,facilitySector,IS06,TR02)]
setorder(d,gazaWBEJ,facilitySector,IS06,TR02)
openxlsx::write.xlsx(d,file.path(SHARED_TODAY,"clinical_training_facility_is06_TR02.xlsx"))
```

## 1x NEW. Distribution of each type of facility (IS06) that provide internships by sector and the professions they train in ( this can be obtained from TR06)

### Results

```{r, warning=FALSE}
dLoc <- unique(dLocation[,c("localityCode","district","gazaWBEJ")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities[TR05==1],dLoc,by="IDH03",all.x=T)
d2 <- copy(d)
d2[,gazaWBEJ:="Palestine"]
d <- rbind(d,d2)
nrow(d)
d <- d[,.(N=.N),by=.(gazaWBEJ,facilitySector,IS06)]
setorder(d,gazaWBEJ,facilitySector,IS06)
openxlsx::write.xlsx(d,file.path(SHARED_TODAY,"clinical_internship_facility_is06.xlsx"))
```

```{r, warning=FALSE}
dLoc <- unique(dLocation[,c("localityCode","district","gazaWBEJ")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities[TR05==1],dLoc,by="IDH03",all.x=T)
d2 <- copy(d)
d2[,gazaWBEJ:="Palestine"]
d <- rbind(d,d2)
nrow(d)
d <- melt.data.table(d[,c("IDH00","gazaWBEJ","facilitySector","IS06","TR06_1_T","TR06_2_T","TR06_3_T")],id.vars = c("IDH00","gazaWBEJ","facilitySector","IS06"))
d <- d[!is.na(value)]
setnames(d,"value","TR06")
d <- d[,.(N=.N),by=.(gazaWBEJ,facilitySector,IS06,TR06)]
setorder(d,gazaWBEJ,facilitySector,IS06,TR06)
openxlsx::write.xlsx(d,file.path(SHARED_TODAY,"clinical_internship_facility_is06_TR06.xlsx"))
```


\newpage 

## 2. Total number of facilities that provide clinical trainings ( pre-graduation ) in the West Bank

- Source: Facility questionnaire
- Calculation: Sum of all TR01 answer 1 per  IDH 01 District in West Bank
- Indicator description: Total number of health facilities in the West Bank that offer clinical trainings sites 

```{r, warning=FALSE}
dLoc <- unique(dLocation[,c("localityCode","district","isGaza")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities,dLoc,by="IDH03",all.x=T)
nrow(d)
```

### Results

```{r, warning=FALSE}
with(d[isGaza==0],xtabs(~district+TR01,addNA=TRUE))
with(d[isGaza==0],xtabs(~TR01,addNA=TRUE))
```

\newpage 

## 3. Total number of facilities that provide clinical trainings (pre-graduation ) in Gaza

- Source: Facility questionnaire
- Calculation: Sum of all TR01 answer 1 per IDH 01 district in Gaza
- Indicator description: Total number of health facilities in Gaza that offer clinical trainings sites 

```{r, warning=FALSE}
dLoc <- unique(dLocation[,c("localityCode","district","isGaza")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities,dLoc,by="IDH03",all.x=T)
nrow(d)
```

### Results

```{r, warning=FALSE}
with(d[isGaza==1],xtabs(~district+TR01,addNA=TRUE))
with(d[isGaza==1],xtabs(~TR01,addNA=TRUE))
```

\newpage 

## 4. Total number of facilities that provide internships (post-graduation) in Palestine

- Source: Facility questionnaire
- Calculation: Sum of all TR05 answer 1
- Indicator description: Total number of health facilities in Palestine that offer internship sites needed to apply for licensing

```{r, warning=FALSE}
xtabs(~dFacilities$TR05,addNA=TRUE)
```

\newpage 

## 5. Total number of facilities that provide internships (post-graduation) in the West Bank

- Source: Facility questionnaire
- Calculation: Sum of all TR05 answer 1 per IDH01 district in West Bank
- Indicator description: Total number of health facilities in the West Bank that offer internship sites needed to apply for licensing

```{r, warning=FALSE}
dLoc <- unique(dLocation[,c("localityCode","district","isGaza")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities,dLoc,by="IDH03",all.x=T)
nrow(d)
```

### Results

```{r, warning=FALSE}
with(d[isGaza==0],xtabs(~district+TR05,addNA=TRUE))
with(d[isGaza==0],xtabs(~TR05,addNA=TRUE))
```


\newpage 

## 6. Total number of facilities that provide internships (post-graduation) in Gaza 

- Source: Facility questionnaire
- Calculation: Sum of all TR05 answer 1 per IDH01 district in Gaza
- Indicator description: Total number of health facilities in Gaza that offer internship sites needed to apply for licensing

```{r, warning=FALSE}
dLoc <- unique(dLocation[,c("localityCode","district","isGaza")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities,dLoc,by="IDH03",all.x=T)
nrow(d)
```

### Results

```{r, warning=FALSE}
with(d[isGaza==1],xtabs(~district+TR05,addNA=TRUE))
with(d[isGaza==1],xtabs(~TR05,addNA=TRUE))
```

\newpage

## 7. Percentage of facilities with semi-structured clinical training programs in Palestine

- Source: Facility questionnaire
- Calculation: ( Sum of all TR01 answer 1. who answered at least 3 Yes from TR03   / sum of TR01 answer 1.  ) * 100
- Indicator description: Percentage of clinical training sites that offer semi-structures taining programs

```{r, warning=FALSE}
dFacilities[,sumYesTR03:=0]
dFacilities[,numMissing:=0]
for(l in c("A","B","C","D","E","F","G")){
  newVar <- sprintf("TR03_%s",l)
  dFacilities[get(newVar)==1,sumYesTR03:=sumYesTR03+1]
  dFacilities[is.na(get(newVar)),numMissing:=numMissing+1]
}
dFacilities[numMissing>=5,sumYesTR03:=NA]

dFacilities[,three_or_more_TR03:=as.numeric(NA)]
dFacilities[!is.na(sumYesTR03),three_or_more_TR03:=0]
dFacilities[sumYesTR03>=3,three_or_more_TR03:=1]

d <- dFacilities[TR01==1]
d[,numerator:=three_or_more_TR03]
```

### Results

```{r, warning=FALSE}
PrintTableNPerc(d)
```

\newpage

## 8. Percentage of facilities with semi-structured internship programs in Palestine

- Source: Facility questionnaire
- Calculation: ( Sum of all TR05 answer 1. who answered at least 3 YES from TR07  / sum of all TR05 answer 1 ) * 100
- Indicator description: Percentage of internship sites that offer semi-structures training programs

```{r, warning=FALSE}
dFacilities[,sumYesTR07:=0]
dFacilities[,numMissing:=0]
for(l in c("A","B","C","D","E","F","G")){
  newVar <- sprintf("TR07_%s",l)
  dFacilities[get(newVar)==1,sumYesTR07:=sumYesTR07+1]
  dFacilities[is.na(get(newVar)),numMissing:=numMissing+1]
}
dFacilities[numMissing>=5,sumYesTR07:=NA]

dFacilities[,three_or_more_TR07:=as.numeric(NA)]
dFacilities[!is.na(sumYesTR07),three_or_more_TR07:=0]
dFacilities[sumYesTR07>=3,three_or_more_TR07:=1]

d <- dFacilities[TR05==1]
d[,numerator:=three_or_more_TR07]
```

### Results

```{r, warning=FALSE}
PrintTableNPerc(d)
```

\newpage 

# CPD Indicators

## 5. Percentage distribution of health workers per profession who took CPD courses within the past year

- Source: Workforce questionnaire 
- Calculation: ( CW00 nurses who answered SK02 with 1. Yes  / sum of CW00 nurses) * 100
- Indicator description: Percentage distribution of health workers from each profession, who took certified CPD courses within the past year
- Note: Note that this indicator needs to be repeated for each profession in CW00 and present percentage distribution ( the calculation provided was an example, repeat the indicator for doctors, allied health sciences, pharmacists, dentists, psychologists)

### Results 

```{r message=FALSE, warning=FALSE}
for(i in professionVars){
  d <- dWorkers[get(i)==1]
  d[,numerator:=as.numeric(NA)]
  d[!is.na(SK02),numerator:=0]
  d[SK02==1,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  cat(sprintf("***** %s *****\n",i))
  PrintTableNPerc(d)
  cat("\n\n")
}
```


## 6. Percentage distribution of health workers  per sector who took CPD courses within the past year

- Source: Workforce questionnaire 
- Calculation: ( sum of SK02 with 1. Yes  / All health workers ) * 100----> this is done by sector
- Percentage distritbution of health workers from each sector, who took certified CPD courses within the past year 
- Note: Note that this indicators is combined from 2 forms. We need the facility sector ) + this indicator needs to be repeated for each sector (Ministry of Health, Military Health Services, UNRWA, Private and NGO from IS04 ) and present percentage distribution and shows different values in same indicator

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

```


### Results 

```{r message=FALSE, warning=FALSE}
for(i in unique(dMaster$facilitySector)){
  d <- dMaster[facilitySector==i & isProf_Healthworker==1]
  d[,numerator:=as.numeric(NA)]
  d[!is.na(SK02),numerator:=0]
  d[SK02==1,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  cat(sprintf("***** %s *****\n",i))
  PrintTableNPerc(d)
  cat("\n\n")
}
```


# Health Workforce Indicators

## XX. Total number of working Radiologists in Palestine/WB/Gaza

### Results 

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[isProf_Radiologist==1 & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

## XX. Total number of working Lab Techs in Palestine/WB/Gaza

### Results 

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[isProf_LabTech==1 & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

## 1. Total number of working doctors in Palestine/WB/Gaza

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 ( doctors )
- Indicator description: Total number of doctors ( General Doctors and Specialized Doctors ) currently working in Palestine
- Note: 

### Results 

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[isProf_Doctor==1 & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```


## 3. Total number of working specialized doctors per specialization in Palestine/WB/Gaza

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 ( specialized doctors )
- Indicator description: Total number of specialized doctors currently working in Palestine
- Note: 

### Results for all specialized doctors 

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[isProf_Specializeddoctor==1 & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

### Results stratified by type of specialized doctors

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[isProf_Specializeddoctor==1 & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01,doctor_specialization
  )]
  
  d <- d[,.(
    numerator=sum(numerator,na.rm=T)
  ),by=.(
    doctor_specialization
  )]
  setorder(d,doctor_specialization)
  d[,per1000:=numerator/usePopulation*1000]
  
  print(d)
}
```

## 5. Total number of  working dentists in Palestine/WB/Gaza

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 dentists
- Indicator description: Total number of dentists currently working in Palestine 
- Note: 

### Results

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[isProf_Dentist==1 & get(location)==1]
  
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

## 7. Total number of working pharmacists in Palestine/WB/Gaza

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 pharmacists 
- Indicator description: Total number of pharmacists working in Palestine

### Results

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[isProf_Pharmacist==1 & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

## 9. Total number of working nurses in Palestine/WB/Gaza

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 nurses
- Indicator description: Total number of nurses ( Registered and Practical ) working in Palestine

### Results

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[isProf_Nurse==1 & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

## 11. Total number of working midwives in Palestine/WB/Gaza

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 midwives
- Indicator description: Total number of midwives working in Palestine

### Results

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[isProf_Midwife==1 & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

## 13. Total number of working allied health sciences professionals in Palestine/WB/Gaza

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 allied health sciences
- Indicator description: Total number of allied health sciences professionals working in Palestine

### Results

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[isProf_Alliedhealthsciences==1 & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

## 15. Total number of working psychologists, counselors and therapists in Palestine/WB/Gaza

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 ( psychologists, counselor and therapists )
- Indicator description: Total number of psychologists, counselors and therapists working in Palestine

### Results

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[isProf_Psychologistcounselorstherap==1 & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

## 17. Total number of working psychaitrists in Palestine/WB/Gaza

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 psychaitrists
- Indicator description: Total number of psychologists, counselors and therapists working in Palestine

### Results

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[isProf_Psychiatrist==1 & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

## 19. Total number of working alternative medicine practitioners in Palestine/WB/Gaza 

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 alternative medicine practitioners
- Indicator description: Total number of alternative medicine practitioners in Palestine

### Results

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[isProf_AlternativeMedicine==1 & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

## 21. Total number of working doctors, nurses and midwives per 1,000 population in Palestine/WB/Gaza

- Source: Workforce questionnaire 
- Calculation: ( CW00 doctors + CW00 nurses + CW00 midwives / total Palestine population ) * 1,000
- Indicator description: Total number of doctors, nurses and midwives working in Palestine per 1,000 population

### Results

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[(isProf_Doctor==1 | isProf_Nurse==1 | isProf_Midwife==1) & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

## 22. Total number of administrative and support staff in the health sector in Palestine/WB/Gaza

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 administrative and support staff
- Indicator description: Total number of administrative and support staff working in the health sector in Palestine

### Results

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[(isProf_Administrativesupportstaff==1) & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

## 23. Health workers : administrative and support staff per sector of employment in Palestine/WB/Gaza

- Source: Workforce questionnaire and linked by faciity sector from facility questionnaire
- Calculation: sum of all health workers / sum of all administrative and support staff ----(this should be applied for all workers under each sector)
- Indicator description: Ratio of health workers to administrative and supportstaff in each sector of employment ( repeat for each sector of employment )

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
```


### Results

```{r message=FALSE, warning=FALSE}
for(i in unique(dMaster$facilitySector)){
  for(location in c("isPalestine","isWB","isGaza")){
    if(location=="isPalestine"){
      usePopulation <- pop[districtName=="Palestine population"]$pop
    } else if(location=="isWB"){
      usePopulation <- pop[districtName=="West Bank Population"]$pop
    } else if(location=="isGaza"){
      usePopulation <- pop[districtName=="Gaza Population"]$pop
    }
    d <- dMaster[facilitySector==i & (isProf_Healthworker==1 | isProf_Administrativesupportstaff==1) & get(location)==1]
      
    d[,numerator:=isProf_Healthworker]
    d[,denominator:=isProf_Administrativesupportstaff]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01
    )]
    
    cat(sprintf("***** %s %s *****\n",i,location))
    cat(sprintf("Healthcare worker: %s\n",sum(d$numerator)))
    cat(sprintf("Admin staff: %s\n",sum(d$denominator)))
    cat(sprintf("Ratio: %s\n",sum(d$numerator)/sum(d$denominator)))
    cat(sprintf("Number of people in both categories: %s\n",sum(d$numerator==1 & d$denominator==1)))
    cat("\n\n")
  }
}
```

## 24/25. Percentage distribution of each health profession per sector  of employment in Palestine/WB/Gaza

- Source: Workforce and facility questionnaire
- Calculation: ( total number of health workers in MoH / total number of health workers ) * 100 --This is repeated for all sectors to come out with percentage distribution
- Indicator description: Percentge of total health workers at each sector to total health workers in all sectors ( repeat indicator for each sector of employment )

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

for(i in professionVars){
  for(location in c("isPalestine","isWB","isGaza")){
    if(location=="isPalestine"){
      usePopulation <- pop[districtName=="Palestine population"]$pop
    } else if(location=="isWB"){
      usePopulation <- pop[districtName=="West Bank Population"]$pop
    } else if(location=="isGaza"){
      usePopulation <- pop[districtName=="Gaza Population"]$pop
    }
    d <- dMaster[get(i)==1 & get(location)==1]
    
    d[,numerator:=1]
    d <- d[,.(
        person=max(numerator,na.rm=T),
        jobs=sum(numerator,na.rm=T)
      ),by=.(
        HR01,
        facilitySector
      )]
    
    
    NumberOfPeople <- length(unique(d$HR01))
    
    d <- d[,.(
      person=sum(person),
      jobs=sum(jobs)),
      by=.(facilitySector)]
    d[,denom:=sum(person)]
    d[,percentagePerson:=person/denom*100]
    d[,denom:=NULL]
    
    cat(sprintf("***** %s %s *****\n",i,location))
    print(d)
    print(sprintf("Number of jobs: %s",sum(d$jobs)))
    print(sprintf("Number of people-sectors: %s",sum(d$person)))
    print(sprintf("Number of unique people WITHIN %s: %s",location,NumberOfPeople))
    cat("\n\n")
  }
}
```

### BY SPECIALIZED DOCTOR

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

specializations <- unique(dMaster$doctor_specialization)

for(i in specializations){
  for(location in c("isPalestine","isWB","isGaza")){
    if(location=="isPalestine"){
      usePopulation <- pop[districtName=="Palestine population"]$pop
    } else if(location=="isWB"){
      usePopulation <- pop[districtName=="West Bank Population"]$pop
    } else if(location=="isGaza"){
      usePopulation <- pop[districtName=="Gaza Population"]$pop
    }
    d <- dMaster[doctor_specialization==i & get(location)==1]
    
    d[,numerator:=1]
    d <- d[,.(
        person=max(numerator,na.rm=T),
        jobs=sum(numerator,na.rm=T)
      ),by=.(
        HR01,
        facilitySector
      )]
    
    
    NumberOfPeople <- length(unique(d$HR01))
    
    d <- d[,.(
      person=sum(person),
      jobs=sum(jobs)),
      by=.(facilitySector)]
    d[,denom:=sum(person)]
    d[,percentagePerson:=person/denom*100]
    d[,denom:=NULL]
    
    cat(sprintf("***** %s %s *****\n",i,location))
    print(d)
    print(sprintf("Number of jobs: %s",sum(d$jobs)))
    print(sprintf("Number of people-sectors: %s",sum(d$person)))
    print(sprintf("Number of unique people WITHIN %s: %s",location,NumberOfPeople))
    cat("\n\n")
  }
}
```

## 26/27. Ratio of total working nurses to working doctors in Palestine/WB/Gaza

- Source: Workforce and facility questionnaire
- Calculation: All CW00 nurses / All CW00 doctors
- Indicator description: Ratio of working nurses to working doctors in Palestine

### Results

```{r, warning=FALSE}
# todo
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

for(i in c("All",unique(dMaster$facilitySector))){
  for(location in c("isPalestine","isWB","isGaza")){
    if(location=="isPalestine"){
      usePopulation <- pop[districtName=="Palestine population"]$pop
    } else if(location=="isWB"){
      usePopulation <- pop[districtName=="West Bank Population"]$pop
    } else if(location=="isGaza"){
      usePopulation <- pop[districtName=="Gaza Population"]$pop
    }
    d <- dMaster[(isProf_Doctor==1 | isProf_Nurse==1) & get(location)==1]
    if(i!="All") d <- d[facilitySector==i]
    
    d[,numerator:=isProf_Nurse]
    d[,denominator:=isProf_Doctor]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01
    )]
    
    cat(sprintf("***** %s %s *****\n",i,location))
    cat(sprintf("Nurse: %s\n",sum(d$numerator)))
    cat(sprintf("Doctor: %s\n",sum(d$denominator)))
    cat(sprintf("Ratio: %s\n",sum(d$numerator)/sum(d$denominator)))
    cat("\n\n")
  }
}
```

## xx. Ratio of total working nurses to working doctors IN HOSPITALS BY SECTOR in Palestine/WB/Gaza

- Source: Workforce and facility questionnaire
- Calculation: All CW00 nurses / All CW00 doctors
- Indicator description: Ratio of working nurses to working doctors in Palestine

### Results

```{r, warning=FALSE}
# todo
dMaster <- merge(dWorkers, dFacilities[IS06==9,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

for(i in c("All",unique(dMaster$facilitySector))){
  for(location in c("isPalestine","isWB","isGaza")){
    if(location=="isPalestine"){
      usePopulation <- pop[districtName=="Palestine population"]$pop
    } else if(location=="isWB"){
      usePopulation <- pop[districtName=="West Bank Population"]$pop
    } else if(location=="isGaza"){
      usePopulation <- pop[districtName=="Gaza Population"]$pop
    }
    d <- dMaster[(isProf_Doctor==1 | isProf_Nurse==1) & get(location)==1]
    if(i!="All") d <- d[facilitySector==i]
    
    d[,numerator:=isProf_Nurse]
    d[,denominator:=isProf_Doctor]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01
    )]
    
    cat(sprintf("***** %s %s *****\n",i,location))
    cat(sprintf("Nurse: %s\n",sum(d$numerator)))
    cat(sprintf("Doctor: %s\n",sum(d$denominator)))
    cat(sprintf("Ratio: %s\n",sum(d$numerator)/sum(d$denominator)))
    cat("\n\n")
  }
}
```

## xx. Ratio of admin to HCW IN HOSPITALS BY SECTOR in Palestine/WB/Gaza

- Source: Workforce and facility questionnaire
- Calculation: All CW00 nurses / All CW00 doctors
- Indicator description: Ratio of working nurses to working doctors in Palestine

### Results

```{r, warning=FALSE}
# todo
dMaster <- merge(dWorkers, dFacilities[IS06==9,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

for(i in c("All",unique(dMaster$facilitySector))){
  for(location in c("isPalestine","isWB","isGaza")){
    if(location=="isPalestine"){
      usePopulation <- pop[districtName=="Palestine population"]$pop
    } else if(location=="isWB"){
      usePopulation <- pop[districtName=="West Bank Population"]$pop
    } else if(location=="isGaza"){
      usePopulation <- pop[districtName=="Gaza Population"]$pop
    }
    d <- dMaster[(isProf_Administrativesupportstaff==1 | isProf_Healthworker==1) & get(location)==1]
    if(i!="All") d <- d[facilitySector==i]
    
    d[,numerator:=isProf_Administrativesupportstaff]
    d[,denominator:=isProf_Healthworker]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01
    )]
    
    cat(sprintf("***** %s %s *****\n",i,location))
    cat(sprintf("Admin: %s\n",sum(d$numerator)))
    cat(sprintf("HCW: %s\n",sum(d$denominator)))
    cat(sprintf("Ratio: %s\n",sum(d$numerator)/sum(d$denominator)))
    cat("\n\n")
  }
}
```

## 28/30. Percentage of health workers from the Ministry of Health who dual practice Palestine/WB/Gaza

- Source: Workforce and facility questionnaire
- Calculation: ( Health workers at Ministry of Health (IS04) with IDs found in outside MoH sector / all MoH workers ) * 100
- Indicator description: Percentage of health workers at the Ministry of Health of who dual practice

### Results

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
unique(dMaster$facilitySector)

for(i in professionVars){
  for(location in c("isPalestine","isWB","isGaza")){
    if(location=="isPalestine"){
      usePopulation <- pop[districtName=="Palestine population"]$pop
    } else if(location=="isWB"){
      usePopulation <- pop[districtName=="West Bank Population"]$pop
    } else if(location=="isGaza"){
      usePopulation <- pop[districtName=="Gaza Population"]$pop
    }
    d <- dMaster[get(i)==1 & get(location)==1]
    
    d[,numerator:=0]
    d[facilitySector!="Ministry of Health",numerator:=1]
    d[,denominator:=0]
    d[facilitySector=="Ministry of Health",denominator:=1]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01
    )]
    d <- d[denominator==1]
    
    cat(sprintf("***** %s %s *****\n",i,location))
    cat(sprintf("Numerator: %s\n",sum(d$numerator)))
    cat(sprintf("Denominator: %s\n",sum(d$denominator)))
    cat(sprintf("Percentage: %s%%\n",sum(d$numerator)/sum(d$denominator)*100))
    cat("\n\n")
  }
}
```

### BY SPECIALIZED DOCTOR

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
unique(dMaster$facilitySector)

specializations <- unique(dMaster$doctor_specialization)

for(i in specializations){
  for(location in c("isPalestine","isWB","isGaza")){
    if(location=="isPalestine"){
      usePopulation <- pop[districtName=="Palestine population"]$pop
    } else if(location=="isWB"){
      usePopulation <- pop[districtName=="West Bank Population"]$pop
    } else if(location=="isGaza"){
      usePopulation <- pop[districtName=="Gaza Population"]$pop
    }
    d <- dMaster[doctor_specialization==i & get(location)==1]
    
    d[,numerator:=0]
    d[facilitySector!="Ministry of Health",numerator:=1]
    d[,denominator:=0]
    d[facilitySector=="Ministry of Health",denominator:=1]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01
    )]
    d <- d[denominator==1]
    
    cat(sprintf("***** %s %s *****\n",i,location))
    cat(sprintf("Numerator: %s\n",sum(d$numerator)))
    cat(sprintf("Denominator: %s\n",sum(d$denominator)))
    cat(sprintf("Percentage: %s%%\n",sum(d$numerator)/sum(d$denominator)*100))
    cat("\n\n")
  }
}
```

## 28/30. Percentage of health workers from the Ministry of Health who dual practice IN HOSPITALS Palestine/WB/Gaza

- Source: Workforce and facility questionnaire
- Calculation: ( Health workers at Ministry of Health (IS04) with IDs found in outside MoH sector / all MoH workers ) * 100
- Indicator description: Percentage of health workers at the Ministry of Health of who dual practice

### Results IN HOSPITALS

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[IS06==9,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
unique(dMaster$facilitySector)

for(i in professionVars){
  for(location in c("isPalestine","isWB","isGaza")){
    if(location=="isPalestine"){
      usePopulation <- pop[districtName=="Palestine population"]$pop
    } else if(location=="isWB"){
      usePopulation <- pop[districtName=="West Bank Population"]$pop
    } else if(location=="isGaza"){
      usePopulation <- pop[districtName=="Gaza Population"]$pop
    }
    d <- dMaster[get(i)==1 & get(location)==1]
    
    d[,numerator:=0]
    d[facilitySector!="Ministry of Health",numerator:=1]
    d[,denominator:=0]
    d[facilitySector=="Ministry of Health",denominator:=1]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01
    )]
    d <- d[denominator==1]
    
    cat(sprintf("***** %s %s *****\n",i,location))
    cat(sprintf("Numerator: %s\n",sum(d$numerator)))
    cat(sprintf("Denominator: %s\n",sum(d$denominator)))
    cat(sprintf("Percentage: %s%%\n",sum(d$numerator)/sum(d$denominator)*100))
    cat("\n\n")
  }
}
```

### BY SPECIALIZED DOCTOR IN HOSPITALS

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[IS06==9,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
unique(dMaster$facilitySector)

specializations <- unique(dMaster$doctor_specialization)

for(i in specializations){
  for(location in c("isPalestine","isWB","isGaza")){
    if(location=="isPalestine"){
      usePopulation <- pop[districtName=="Palestine population"]$pop
    } else if(location=="isWB"){
      usePopulation <- pop[districtName=="West Bank Population"]$pop
    } else if(location=="isGaza"){
      usePopulation <- pop[districtName=="Gaza Population"]$pop
    }
    d <- dMaster[doctor_specialization==i & get(location)==1]
    
    d[,numerator:=0]
    d[facilitySector!="Ministry of Health",numerator:=1]
    d[,denominator:=0]
    d[facilitySector=="Ministry of Health",denominator:=1]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01
    )]
    d <- d[denominator==1]
    
    cat(sprintf("***** %s %s *****\n",i,location))
    cat(sprintf("Numerator: %s\n",sum(d$numerator)))
    cat(sprintf("Denominator: %s\n",sum(d$denominator)))
    cat(sprintf("Percentage: %s%%\n",sum(d$numerator)/sum(d$denominator)*100))
    cat("\n\n")
  }
}
```

## 28/30. Percentage of health workers from the Ministry of Health who dual practice IN HEALTH CENTERS Palestine/WB/Gaza

- Source: Workforce and facility questionnaire
- Calculation: ( Health workers at Ministry of Health (IS04) with IDs found in outside MoH sector / all MoH workers ) * 100
- Indicator description: Percentage of health workers at the Ministry of Health of who dual practice

### Results IN HEALTH CENTERS

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[IS06==4,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
unique(dMaster$facilitySector)

for(i in professionVars){
  for(location in c("isPalestine","isWB","isGaza")){
    if(location=="isPalestine"){
      usePopulation <- pop[districtName=="Palestine population"]$pop
    } else if(location=="isWB"){
      usePopulation <- pop[districtName=="West Bank Population"]$pop
    } else if(location=="isGaza"){
      usePopulation <- pop[districtName=="Gaza Population"]$pop
    }
    d <- dMaster[get(i)==1 & get(location)==1]
    
    d[,numerator:=0]
    d[facilitySector!="Ministry of Health",numerator:=1]
    d[,denominator:=0]
    d[facilitySector=="Ministry of Health",denominator:=1]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01
    )]
    d <- d[denominator==1]
    
    cat(sprintf("***** %s %s*****\n",i,location))
    cat(sprintf("Numerator: %s\n",sum(d$numerator)))
    cat(sprintf("Denominator: %s\n",sum(d$denominator)))
    cat(sprintf("Percentage: %s%%\n",sum(d$numerator)/sum(d$denominator)*100))
    cat("\n\n")
  }
}
```

### BY SPECIALIZED DOCTOR IN HEALTH CENTERS

```{r, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[IS06==4,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
unique(dMaster$facilitySector)

specializations <- unique(dMaster$doctor_specialization)

for(i in specializations){
  for(location in c("isPalestine","isWB","isGaza")){
    if(location=="isPalestine"){
      usePopulation <- pop[districtName=="Palestine population"]$pop
    } else if(location=="isWB"){
      usePopulation <- pop[districtName=="West Bank Population"]$pop
    } else if(location=="isGaza"){
      usePopulation <- pop[districtName=="Gaza Population"]$pop
    }
    d <- dMaster[doctor_specialization==i & get(location)==1]
    
    d[,numerator:=0]
    d[facilitySector!="Ministry of Health",numerator:=1]
    d[,denominator:=0]
    d[facilitySector=="Ministry of Health",denominator:=1]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01
    )]
    d <- d[denominator==1]
    
    cat(sprintf("***** %s %s *****\n",i,location))
    cat(sprintf("Numerator: %s\n",sum(d$numerator)))
    cat(sprintf("Denominator: %s\n",sum(d$denominator)))
    cat(sprintf("Percentage: %s%%\n",sum(d$numerator)/sum(d$denominator)*100))
    cat("\n\n")
  }
}
```

## 31. Percentage of doctors working in hospitals in Palestine/WB/Gaza

- Source: Workforce and facility questionnaire
- Calculation: ( sum of CW00 doctors with answer 9 in facility questionnaire IS06 / total doctors ) * 100
- Indicator description: Percentage of doctors working in Palestine who work in hospitals


```{r, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- merge(dWorkers, dFacilities[,c("IDH00","IS06")], by="IDH00")
  d <- d[isProf_Doctor==1 & get(location)==1]
  d[!is.na(IS06),numerator:=0]
  d[IS06==9,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
   
  cat("\n\n******* ",location," **\n")
  PrintTableNPerc(d)
}
```

## 32. Percentage of nurses working in hospitals in Palestine/WB/Gaza

- Source: Workforce and facility questionnaire
- Calculation: ( sum of CW00 nurses with answer 9 in facility questionnaire IS06 / total nurses ) * 100
- Indicator description: Percentage of nurses working in Palestine who work in hospitals

### Results 

```{r, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- merge(dWorkers, dFacilities[,c("IDH00","IS06")], by="IDH00")
  d <- d[isProf_Nurse==1 & get(location)==1]
  d[!is.na(IS06),numerator:=0]
  d[IS06==9,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
   
  cat("\n\n******* ",location," **\n")
  PrintTableNPerc(d)
}
```

## 33. Percentage of working doctors in private clinics in Palestine/WB/Gaza

- Source: Workforce and facility questionnaire
- Calculation: ( sum of CW00 doctors with answers in facility questionnaire IS06 1 +2 (and IS04--Private sector) / total number of CW00 doctors ) * 100
- Indicator description: Percentage of doctors working in Palestine who work in private clinics

### Results

```{r, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- merge(dWorkers, dFacilities[,c("IDH00","IS06","facilitySector")], by="IDH00")
  d <- d[isProf_Doctor==1 & get(location)==1]
  d[!is.na(IS06),numerator:=0]
  d[IS06 %in% c(1,2),numerator:=1]
  d[facilitySector=="Private",numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
   
  cat("\n\n******* ",location," **\n")
  PrintTableNPerc(d) 
}
```

## 34. Percentage of working specialized doctors in private clinics in Palestine/WB/Gaza

- Source: Workforce and facility questionnaire
- Calculation: ( sum of CW00 specialized doctors with answers in facilitiy questionnaire IS06 1+ 2 (ad IS04--private sector)/ total number of CW00 specialized doctors ) * 100
- Indicator description: Percentage of working specialized doctors in private clinics in Palestine

### Results

```{r, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- merge(dWorkers, dFacilities[,c("IDH00","IS06","facilitySector")], by="IDH00")
  d <- d[isProf_Specializeddoctor==1 & get(location)==1]
  d[!is.na(IS06),numerator:=0]
  d[IS06 %in% c(1,2),numerator:=1]
  d[facilitySector=="Private",numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
   
  cat("\n\n******* ",location," **\n")
  PrintTableNPerc(d) 
}
```

### Results by specialization type

```{r, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- merge(dWorkers, dFacilities[,c("IDH00","IS06","facilitySector")], by="IDH00")
  d <- d[isProf_Specializeddoctor==1 & get(location)==1]
  d[!is.na(IS06),numerator:=0]
  d[IS06 %in% c(1,2),numerator:=1]
  d[facilitySector=="Private",numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01,doctor_specialization
  )]
  
  d <- d[,.(
    numerator=sum(numerator,na.rm=T),
    denominator=.N
  ),by=.(
    doctor_specialization
  )]
  d[,perc:=RAWmisc::Format(100*numerator/denominator,digits = 2)]
  
  setorder(d,doctor_specialization)
  cat("\n\n******* ",location," **\n")
  print(d)
}
```

## 35x-41x. Total number of X (doctors/nurses/etc) working in East Jerusalem hospitals


- Source: Workforce and facility questionnaire
- Calculation: ( sum of CW00 doctors IDH03 who work in a facility in East Jerusalem and IS06 9. hospitals )
- Indicator description: Total number of doctors working in East Jerusalem hospitals

### Results

```{r message=FALSE, warning=FALSE}

dMaster <- merge(dWorkers, dFacilities[,c("IDH00","IS06")], by="IDH00")

for(i in professionVars){
  #d <- dWorkers[get(i)==1 & IDH03 %in% c(dLocation[district=="East Jerusalem (J1)"]$localityCode)]
  d <- dMaster[get(i)==1 & 
                  IDH03 %in% c(dLocation[district=="East Jerusalem (J1)"]$localityCode) &
                  IS06==9]
  
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Numerator: %s\n",sum(d$numerator)))
  cat("\n\n")
}
```

### BY SPECIALIZED DOCTOR

```{r message=FALSE, warning=FALSE}

dMaster <- merge(dWorkers, dFacilities[,c("IDH00","IS06")], by="IDH00")

specializations <- unique(dMaster$doctor_specialization)

for(i in specializations){
  #d <- dWorkers[get(i)==1 & IDH03 %in% c(dLocation[district=="East Jerusalem (J1)"]$localityCode)]
  d <- dMaster[doctor_specialization==i & 
                  IDH03 %in% c(dLocation[district=="East Jerusalem (J1)"]$localityCode) &
                  IS06==9]
  
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Numerator: %s\n",sum(d$numerator)))
  cat("\n\n")
}
```

# At Risk Area Indicators

- Number/per 1000 
- Doctors, Dentists, Pharmacists, Nurses, Midwives, Doctors+Nurses+Midwives
- Area C, Jordan Valley, Jerusalem District

```{r message=FALSE, warning=FALSE}

#dMaster <- merge(dWorkers, dFacilities[,c("IDH00","RE02")], by="IDH00")
#xtabs(~dMaster$RE02)

dWorkers[,isJerusalem:=as.numeric(NA)]
dWorkers[IDH03 %in% dLocation[district=="Jerusalem"]$localityCode, isJerusalem:=1]

whereDoTheyWork <- dFacilities[,c("IDH00","isJordanValley","RE02")]
whereDoTheyWork[RE02==1,worksInAreaC:=1]
whereDoTheyWork[isJordanValley==1,worksInJordanValley:=1]
whereDoTheyWork[,isJordanValley:=NULL]
whereDoTheyWork[,RE02:=NULL]

xtabs(~whereDoTheyWork$worksInAreaC)
xtabs(~whereDoTheyWork$worksInJordanValley)

nrow(dWorkers)
dWorkers[,worksInAreaC:=NULL]
dWorkers[,worksInJordanValley:=NULL]
dWorkers <- merge(dWorkers,whereDoTheyWork,by="IDH00",all.x=T)
nrow(dWorkers)


res <- list()
index <- 1
for(prof in c(
  "isProf_Doctor",
  "isProf_Dentist",
  "isProf_Pharmacist",
  "isProf_Nurse",
  "isProf_Midwife",
  "isProf_DocNurseMid"
  )) for(area in c(
    "worksInAreaC",
    "worksInJordanValley",
    "isJerusalem"
  )){
    d <- dWorkers[get(prof)==1 & get(area)==1]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01
    )]
    res[[index]] <- data.frame(prof=prof,area=area,n=nrow(d))
    index <- index + 1
  }

res <- rbindlist(res)
res[,pop:=161596.6]
res[area=="worksInAreaC",pop:=297986]
res[area=="worksInJordanValley",pop:=18241]
res[,ratep1000:=RAWmisc::Format(n/pop*1000,digits=2)]
print(res)
```

# Age Indicators

- Age -> should sum up to 100%
- Stratified by professionVars
- Stratified by Palestine/Gaza/WB
- Doctors, Dentists, Pharmacists, Nurses, Midwives, Doctors+Nurses+Midwives
- Area C, Jordan Valley, Jerusalem District

```{r message=FALSE, warning=FALSE}

dWorkers[,isGaza:=as.numeric(NA)]
dWorkers[,isWB:=as.numeric(NA)]

dWorkers[,isPalestine:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]
dWorkers[,age:=floor(as.numeric(difftime("2018-01-01",HR03,units="days"))/365.25)]

dWorkers[,ageCat:=as.character(NA)]
dWorkers[age>=18 & age<=30,ageCat:="18-30"]
dWorkers[age>=31 & age<=45,ageCat:="31-45"]
dWorkers[age>=46 & age<=54,ageCat:="46-54"]
dWorkers[age>=55 & age<=59,ageCat:="55-59"]
dWorkers[age>=60,ageCat:="60+"]

for(prof in professionVars) for(area in c(
    "isPalestine",
    "isGaza",
    "isWB"
  )){
    d <- dWorkers[get(prof)==1 & get(area)==1]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     ageCat
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=ageCat]
    d[!is.na(ageCat),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    d[,ageCat:=factor(ageCat,levels=c(
      "18-30",
      "31-45",
      "46-54",
      "55-59",
      "60+"
      ))]
    setorder(d,ageCat)

    cat("*******\n")
    cat(sprintf("%s %s\n",prof,area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

### STRATIFIED BY SPECIALIZED DOCTOR

```{r message=FALSE, warning=FALSE}
specializations <- unique(dWorkers$doctor_specialization)

for(prof in specializations) for(area in c(
    "isPalestine",
    "isGaza",
    "isWB"
  )){
    d <- dWorkers[doctor_specialization==prof & get(area)==1]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     ageCat
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=ageCat]
    d[!is.na(ageCat),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    d[,ageCat:=factor(ageCat,levels=c(
      "18-30",
      "31-45",
      "46-54",
      "55-59",
      "60+"
      ))]
    setorder(d,ageCat)

    cat("*******\n")
    cat(sprintf("%s %s\n",prof,area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

# Age Indicators FOR MINISTRY OF HEALTH AND IS06==9

- Age -> should sum up to 100%
- Stratified by professionVars
- Stratified by Palestine/Gaza/WB
- Doctors, Dentists, Pharmacists, Nurses, Midwives, Doctors+Nurses+Midwives
- Area C, Jordan Valley, Jerusalem District

## FOR MINISTRY OF HEALTH AND IS06==9

```{r message=FALSE, warning=FALSE}

keepIDH00 <- dFacilities[facilitySector=="Ministry of Health" & IS06==9]$IDH00

dWorkers[,isGaza:=as.numeric(NA)]
dWorkers[,isWB:=as.numeric(NA)]

dWorkers[,isPalestine:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]
dWorkers[,age:=floor(as.numeric(difftime("2018-01-01",HR03,units="days"))/365.25)]

dWorkers[,ageCat:=as.character(NA)]
dWorkers[age>=18 & age<=30,ageCat:="18-30"]
dWorkers[age>=31 & age<=45,ageCat:="31-45"]
dWorkers[age>=46 & age<=54,ageCat:="46-54"]
dWorkers[age>=55 & age<=59,ageCat:="55-59"]
dWorkers[age>=60,ageCat:="60+"]

for(prof in professionVars) for(area in c(
    "isPalestine",
    "isGaza",
    "isWB"
  )){
    d <- dWorkers[get(prof)==1 & get(area)==1 & IDH00 %in% keepIDH00]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     ageCat
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=ageCat]
    d[!is.na(ageCat),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    d[,ageCat:=factor(ageCat,levels=c(
      "18-30",
      "31-45",
      "46-54",
      "55-59",
      "60+"
      ))]
    setorder(d,ageCat)

    cat("*******\n")
    cat(sprintf("%s %s\n",prof,area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

### STRATIFIED BY SPECIALIZED DOCTOR FOR MINISTRY OF HEALTH AND IS06==9

```{r message=FALSE, warning=FALSE}
specializations <- unique(dWorkers$doctor_specialization)

for(prof in specializations) for(area in c(
    "isPalestine",
    "isGaza",
    "isWB"
  )){
    d <- dWorkers[doctor_specialization==prof & get(area)==1 & IDH00 %in% keepIDH00]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     ageCat
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=ageCat]
    d[!is.na(ageCat),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    d[,ageCat:=factor(ageCat,levels=c(
      "18-30",
      "31-45",
      "46-54",
      "55-59",
      "60+"
      ))]
    setorder(d,ageCat)

    cat("*******\n")
    cat(sprintf("%s %s\n",prof,area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

# Age Indicators FOR MINISTRY OF HEALTH AND IS06==4

- Age -> should sum up to 100%
- Stratified by professionVars
- Stratified by Palestine/Gaza/WB
- Doctors, Dentists, Pharmacists, Nurses, Midwives, Doctors+Nurses+Midwives
- Area C, Jordan Valley, Jerusalem District

## FOR MINISTRY OF HEALTH AND IS06==4

```{r message=FALSE, warning=FALSE}

keepIDH00 <- dFacilities[facilitySector=="Ministry of Health" & IS06==4]$IDH00

dWorkers[,isGaza:=as.numeric(NA)]
dWorkers[,isWB:=as.numeric(NA)]

dWorkers[,isPalestine:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]
dWorkers[,age:=floor(as.numeric(difftime("2018-01-01",HR03,units="days"))/365.25)]

dWorkers[,ageCat:=as.character(NA)]
dWorkers[age>=18 & age<=30,ageCat:="18-30"]
dWorkers[age>=31 & age<=45,ageCat:="31-45"]
dWorkers[age>=46 & age<=54,ageCat:="46-54"]
dWorkers[age>=55 & age<=59,ageCat:="55-59"]
dWorkers[age>=60,ageCat:="60+"]

for(prof in professionVars) for(area in ALL_DISTRICT_NAMES){
    d <- dWorkers[get(prof)==1 & get(area)==1 & IDH00 %in% keepIDH00]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     ageCat
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=ageCat]
    d[!is.na(ageCat),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    d[,ageCat:=factor(ageCat,levels=c(
      "18-30",
      "31-45",
      "46-54",
      "55-59",
      "60+"
      ))]
    setorder(d,ageCat)

    cat("*******\n")
    cat(sprintf("%s %s\n",prof,area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

### FOR MOH GPs, IS06==4, by district

```{r message=FALSE, warning=FALSE}
specializations <- unique(dWorkers$doctor_specialization)

for(area in ALL_DISTRICT_NAMES){
    d <- dWorkers[isProf_GP==1 & get(area)==1 & IDH00 %in% keepIDH00]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     ageCat
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=ageCat]
    d[!is.na(ageCat),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    d[,ageCat:=factor(ageCat,levels=c(
      "18-30",
      "31-45",
      "46-54",
      "55-59",
      "60+"
      ))]
    setorder(d,ageCat)

    cat("*******\n")
    cat(sprintf("%s\n",area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

### STRATIFIED BY SPECIALIZED DOCTOR FOR MINISTRY OF HEALTH AND IS06==4

```{r message=FALSE, warning=FALSE}
specializations <- unique(dWorkers$doctor_specialization)

for(prof in specializations) for(area in c(
    "isPalestine",
    "isGaza",
    "isWB"
  )){
    d <- dWorkers[doctor_specialization==prof & get(area)==1 & IDH00 %in% keepIDH00]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     ageCat
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=ageCat]
    d[!is.na(ageCat),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    d[,ageCat:=factor(ageCat,levels=c(
      "18-30",
      "31-45",
      "46-54",
      "55-59",
      "60+"
      ))]
    setorder(d,ageCat)

    cat("*******\n")
    cat(sprintf("%s %s\n",prof,area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

# Gender Indicators

- Sex -> should sum up to 100% (numbers and percentages)
- Stratified by professionVars
- Stratified by Palestine/Gaza/WB/Gaza Districts/WB Districts
- Doctors, Dentists, Pharmacists, Nurses, Midwives, Doctors+Nurses+Midwives
- Area C, Jordan Valley, Jerusalem District

```{r message=FALSE, warning=FALSE}

dWorkers[,isGaza:=as.numeric(NA)]
dWorkers[,isWB:=as.numeric(NA)]

dWorkers[,isPalestineUrban:=as.numeric(NA)]
dWorkers[,isGazaUrban:=as.numeric(NA)]
dWorkers[,isWBUrban:=as.numeric(NA)]

dWorkers[,isPalestineRural:=as.numeric(NA)]
dWorkers[,isGazaRural:=as.numeric(NA)]
dWorkers[,isWBRural:=as.numeric(NA)]

dWorkers[,isPalestineCamp:=as.numeric(NA)]
dWorkers[,isGazaCamp:=as.numeric(NA)]
dWorkers[,isWBCamp:=as.numeric(NA)]

dWorkers[,isPalestine:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

dWorkers[IDH03 %in% dLocation[urbanRural=="Urban"]$localityCode,
         isPalestineUrban:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1 & urbanRural=="Urban"]$localityCode,
         isGazaUrban:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0 & urbanRural=="Urban"]$localityCode,
         isWBUrban:=1]

dWorkers[IDH03 %in% dLocation[urbanRural=="Rural"]$localityCode,
         isPalestineRural:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1 & urbanRural=="Rural"]$localityCode,
         isGazaRural:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0 & urbanRural=="Rural"]$localityCode,
         isWBRural:=1]

dWorkers[IDH03 %in% dLocation[urbanRural=="Camp"]$localityCode,
         isPalestineCamp:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1 & urbanRural=="Camp"]$localityCode,
         isGazaCamp:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0 & urbanRural=="Camp"]$localityCode,
         isWBCamp:=1]

dWorkers[,isFemale:=HR02-1]

districtNames <- c("isPalestine","isGaza","isWB",
                   "isPalestineUrban","isGazaUrban","isWBUrban",
                   "isPalestineRural","isGazaRural","isWBRural",
                   "isPalestineCamp","isGazaCamp","isWBCamp")

for(i in unique(dLocation$district)){
  newName <- stringr::str_replace_all(i,"[& ,\\-\\(\\)]","")
  newName <- sprintf("isDistrict_%s",newName)
  districtNames <- c(districtNames, newName)
  dWorkers[,(newName):=as.numeric(NA)]
  dWorkers[IDH03 %in% dLocation[district==i]$localityCode, (newName):=1]
}

stack <- data.table(expand.grid(prof=professionVars,dist=districtNames,stringsAsFactors = F))

for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dWorkers[get(s$prof)==1 & get(s$dist)==1]
  allFemalesInPalestine <- length(unique(dWorkers[get(s$prof)==1 & isFemale==TRUE]$HR01))
  d[,numerator:=1]

  d <- d[,.(
   numerator=max(numerator,na.rm=T)
  ),by=.(
   HR01,
   isFemale
  )]
  
  d <- d[,.(numerator=sum(numerator)),by=isFemale]
  d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  d[,ratio:=RAWmisc::Format(numerator/(denominator_excl_miss-numerator),2)]
  d[,allFemalesInPalestine:=allFemalesInPalestine]
  d[isFemale==1,percOfAllFemalesInPalestine:=RAWmisc::Format(numerator/allFemalesInPalestine*100,1)]
  setorder(d,isFemale)
  cat("*******\n")
  cat(sprintf("%s %s\n",s$prof,s$dist))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
  }
  cat("\n\n")
}

```


### IS06==9 & MINISTRY OF HEALTH

```{r, warning=FALSE}
keepIDH00 <- dFacilities[facilitySector=="Ministry of Health" & IS06==9]$IDH00
for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dWorkers[get(s$prof)==1 & get(s$dist)==1 & IDH00 %in% keepIDH00]
  allFemalesInPalestine <- length(unique(dWorkers[get(s$prof)==1 & isFemale==TRUE]$HR01))
  d[,numerator:=1]

  d <- d[,.(
   numerator=max(numerator,na.rm=T)
  ),by=.(
   HR01,
   isFemale
  )]
  
  d <- d[,.(numerator=sum(numerator)),by=isFemale]
  d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  d[,ratio:=RAWmisc::Format(numerator/(denominator_excl_miss-numerator),2)]
  d[,allFemalesInPalestine:=allFemalesInPalestine]
  d[isFemale==1,percOfAllFemalesInPalestine:=RAWmisc::Format(numerator/allFemalesInPalestine*100,1)]
  setorder(d,isFemale)
  cat("*******\n")
  cat(sprintf("%s %s\n",s$prof,s$dist))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
  }
  cat("\n\n")
}
```

### IS06==4 & MINISTRY OF HEALTH

```{r, warning=FALSE}
keepIDH00 <- dFacilities[facilitySector=="Ministry of Health" & IS06==4]$IDH00
for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dWorkers[get(s$prof)==1 & get(s$dist)==1 & IDH00 %in% keepIDH00]
  allFemalesInPalestine <- length(unique(dWorkers[get(s$prof)==1 & isFemale==TRUE]$HR01))
  d[,numerator:=1]

  d <- d[,.(
   numerator=max(numerator,na.rm=T)
  ),by=.(
   HR01,
   isFemale
  )]
  
  d <- d[,.(numerator=sum(numerator)),by=isFemale]
  d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  d[,ratio:=RAWmisc::Format(numerator/(denominator_excl_miss-numerator),2)]
  d[,allFemalesInPalestine:=allFemalesInPalestine]
  d[isFemale==1,percOfAllFemalesInPalestine:=RAWmisc::Format(numerator/allFemalesInPalestine*100,1)]
  setorder(d,isFemale)
  cat("*******\n")
  cat(sprintf("%s %s\n",s$prof,s$dist))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
  }
  cat("\n\n")
}
```


### Gender Distribution by Age

```{r}
stack <- na.omit(data.table(expand.grid(prof=c("isProf_Doctor","isProf_Dentist"),age=unique(dWorkers$ageCat),stringsAsFactors = F)))
setorder(stack,prof,age)

for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dWorkers[get(s$prof)==1 & ageCat==s$age]
  #allFemalesInPalestine <- length(unique(dWorkers[get(s$prof)==1 & isFemale==TRUE]$HR01))
  d[,numerator:=1]

  d <- d[,.(
   numerator=max(numerator,na.rm=T)
  ),by=.(
   HR01,
   isFemale
  )]
  
  d <- d[,.(numerator=sum(numerator)),by=isFemale]
  d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  d[,ratio:=RAWmisc::Format(numerator/(denominator_excl_miss-numerator),2)]
  #d[,allFemalesInPalestine:=allFemalesInPalestine]
  #d[isFemale==1,percOfAllFemalesInPalestine:=RAWmisc::Format(numerator/allFemalesInPalestine*100,1)]
  setorder(d,isFemale)
  cat("*******\n")
  cat(sprintf("%s %s\n",s$prof,s$age))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
  }
  cat("\n\n")
}

```

### STRATIFIED BY SPECIALIZED DOCTORS

```{r, warning=FALSE}
## FINDING OUT DUAL SPECIALIZATIONS
locationsToMerge <- dWorkers[,c("HR01","doctor_specialization","IDH00")]
locationsToMerge <- merge(locationsToMerge,dFacilities[,c("IDH00","IS04_T")],by="IDH00")


temp <- dWorkers[isFemale==1 & isProf_Specializeddoctor==1,.(N=.N),by=.(HR01,doctor_specialization)]
temp[,N:=NULL]
temp[,N:=.N,by=HR01]
setorder(temp,HR01)
temp <- temp[N>1]
temp <- merge(temp,locationsToMerge,by=c("HR01","doctor_specialization"))
openxlsx::write.xlsx(temp,file.path(SHARED_TODAY,"dual_specialization_female.xlsx"))

temp <- dWorkers[isFemale==0 & isProf_Specializeddoctor==1,.(N=.N),by=.(HR01,doctor_specialization)]
temp[,N:=NULL]
temp[,N:=.N,by=HR01]
setorder(temp,HR01)
temp <- temp[N>1]
temp <- merge(temp,locationsToMerge,by=c("HR01","doctor_specialization"))
openxlsx::write.xlsx(temp,file.path(SHARED_TODAY,"dual_specialization_male.xlsx"))
```

```{r, warning=FALSE}
specializations <- unique(dWorkers$doctor_specialization)
stack <- data.table(expand.grid(prof=specializations,dist=districtNames,stringsAsFactors = F))

res <- list()
for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dWorkers[doctor_specialization==s$prof & get(s$dist)==1]
  allFemalesInPalestine <- length(unique(dWorkers[doctor_specialization==s$prof & isFemale==TRUE]$HR01))
  d[,numerator:=1]

  d <- d[,.(
   numerator=max(numerator,na.rm=T)
  ),by=.(
   HR01,
   isFemale
  )]
  
  d <- d[,.(numerator=sum(numerator)),by=isFemale]
  d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  d[,ratio:=RAWmisc::Format(numerator/(denominator_excl_miss-numerator),2)]
  d[,allFemalesInPalestine:=allFemalesInPalestine]
  d[isFemale==1,percOfAllFemalesInPalestine:=RAWmisc::Format(numerator/allFemalesInPalestine*100,1)]
  setorder(d,isFemale)
  cat("*******\n")
  cat(sprintf("%s %s\n",s$prof,s$dist))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
    res[[i]] <- d
  }
  
  cat("\n\n")
}
```

## BY SECTOR

- Sex -> should sum up to 100% (numbers and percentages)
- Stratified by professionVars
- Stratified by Palestine/Gaza/WB/Gaza Districts/WB Districts
- Doctors, Dentists, Pharmacists, Nurses, Midwives, Doctors+Nurses+Midwives
- Area C, Jordan Valley, Jerusalem District

```{r message=FALSE, warning=FALSE}

dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

for(i in unique(dMaster$facilitySector)){
  d <- dMaster[facilitySector==i & isProf_Healthworker==1]
  allFemalesInPalestine <- length(unique(dWorkers[isProf_Healthworker==1 & isFemale==TRUE]$HR01))
  d[,numerator:=1]

  d <- d[,.(
   numerator=max(numerator,na.rm=T)
  ),by=.(
   HR01,
   isFemale
  )]
  
  d <- d[,.(numerator=sum(numerator)),by=isFemale]
  d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  d[,ratio:=RAWmisc::Format(numerator/(denominator_excl_miss-numerator),2)]
  d[,allFemalesInPalestine:=allFemalesInPalestine]
  d[isFemale==1,percOfAllFemalesInPalestine:=RAWmisc::Format(numerator/allFemalesInPalestine*100,1)]
  setorder(d,isFemale)
  cat("*******\n")
  cat(sprintf("%s\n",i))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
  }
  cat("\n\n")
}

```

# GEOGRAPHIC INDICATORS 

## PERCENTAGE DISTRIBUTIONS BY GEOGRAPHY

- Percentage distribution (doctors/dentist/nurses/midwives/psychologisttherapistcounselor/psychiatrist) per (palestine), (WB/Gaza), (north/middle/south of wb/gaza)

```{r, warning=FALSE}

dWorkers[,isPalestine:=1]
dWorkers[,isGaza:=0]
dWorkers[,isWB:=0]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

dWorkers[,campUrbanRural:=as.character(NA)]
dWorkers[IDH03 %in% dLocation[urbanRural=="Urban"]$localityCode,
         campUrbanRural:="Urban"]
dWorkers[IDH03 %in% dLocation[urbanRural=="Rural"]$localityCode,
         campUrbanRural:="Rural"]
dWorkers[IDH03 %in% dLocation[urbanRural=="Camp"]$localityCode,
         campUrbanRural:="Camp"]

districtNames <- c("isPalestine","isGaza","isWB")

stack <- data.table(expand.grid(prof=professionVars,dist=districtNames,
  sector=c("All sectors",unique(dFacilities$facilitySector)),stringsAsFactors = F))

dLocation[,IDH03:=localityCode]
dMaster <- merge(dWorkers, dLocation[,c("IDH03","region","district")], by="IDH03",all.x=T)
nrow(dWorkers)
nrow(dMaster)

nrow(dMaster)
dMaster <- merge(dMaster, dFacilities[,c("IDH00","facilitySector")], by="IDH00", all.x=T)
nrow(dMaster)

unique(dMaster[is.na(region),"IDH03"])

for(i in 1:nrow(stack)){
  
  ## by region
  s <- stack[i]
  d <- dMaster[get(s$prof)==1 & get(s$dist)==1]
  if(s$sector!="All sectors"){
    d <- d[facilitySector==s$sector]
  }
  
  d[,numerator:=1]
  d <- d[,.(
      person=max(numerator,na.rm=T),
      jobs=sum(numerator,na.rm=T)
    ),by=.(
      HR01,
      region
    )]
  
  NumberOfPeople <- length(unique(d$HR01))
  
  d <- d[,.(
    person=sum(person),
    jobs=sum(jobs)),
    by=.(region)]
  d[,denom:=sum(person)]
  d[,percentagePerson:=person/denom]
  d[,denom:=NULL]
  
  cat(sprintf("***** %s - %s - %s *****\n",s$prof,s$dist,s$sector))
  print(d)
  print(sprintf("Number of jobs: %s",sum(d$jobs)))
  print(sprintf("Number of people-regions: %s",sum(d$person)))
  print(sprintf("Number of unique people WITHIN %s: %s",s$dist,NumberOfPeople))
  cat("\n\n")
  
  ## by district
  s <- stack[i]
  d <- dMaster[get(s$prof)==1 & get(s$dist)==1]
  if(s$sector!="All sectors"){
    d <- d[facilitySector==s$sector]
  }
  
  d[,numerator:=1]
  d <- d[,.(
      person=max(numerator,na.rm=T),
      jobs=sum(numerator,na.rm=T)
    ),by=.(
      HR01,
      district
    )]
  
  NumberOfPeople <- length(unique(d$HR01))
  
  d <- d[,.(
    person=sum(person),
    jobs=sum(jobs)),
    by=.(district)]
  d[,denom:=sum(person)]
  d[,percentagePerson:=person/denom*100]
  d[,denom:=NULL]
  
  cat(sprintf("***** %s - %s - %s *****\n",s$prof,s$dist,s$sector))
  print(d)
  print(sprintf("Number of jobs: %s",sum(d$jobs)))
  print(sprintf("Number of people-regions: %s",sum(d$person)))
  print(sprintf("Number of unique people WITHIN %s: %s",s$dist,NumberOfPeople))
  cat("\n\n")
  
  ## by camp\urban\rural
  s <- stack[i]
  d <- dMaster[get(s$prof)==1 & get(s$dist)==1]
  if(s$sector!="All sectors"){
    d <- d[facilitySector==s$sector]
  }
  
  d[,numerator:=1]
  d <- d[,.(
      person=max(numerator,na.rm=T),
      jobs=sum(numerator,na.rm=T)
    ),by=.(
      HR01,
      campUrbanRural
    )]
  
  NumberOfPeople <- length(unique(d$HR01))
  
  d <- d[,.(
    person=sum(person),
    jobs=sum(jobs)),
    by=.(campUrbanRural)]
  d[,denom:=sum(person)]
  d[,percentagePerson:=person/denom*100]
  d[,denom:=NULL]
  
  cat(sprintf("***** %s - %s - %s *****\n",s$prof,s$dist,s$sector))
  print(d)
  print(sprintf("Number of jobs: %s",sum(d$jobs)))
  print(sprintf("Number of people-regions: %s",sum(d$person)))
  print(sprintf("Number of unique people WITHIN %s: %s",s$dist,NumberOfPeople))
  cat("\n\n")
}
```


## RATIOS OF NURSES TO DOCTORS

- Percentage distribution (doctors/dentist/nurses/midwives/psychologisttherapistcounselor/psychiatrist) per (palestine), (WB/Gaza), (north/middle/south of wb/gaza)

```{r, warning=FALSE}

dWorkers[,isPalestine:=1]
dWorkers[,isGaza:=0]
dWorkers[,isWB:=0]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

dWorkers[,campUrbanRural:=as.character(NA)]
dWorkers[IDH03 %in% dLocation[urbanRural=="Urban"]$localityCode,
         campUrbanRural:="Urban"]
dWorkers[IDH03 %in% dLocation[urbanRural=="Rural"]$localityCode,
         campUrbanRural:="Rural"]
dWorkers[IDH03 %in% dLocation[urbanRural=="Camp"]$localityCode,
         campUrbanRural:="Camp"]


districtNames <- c("isPalestine","isGaza","isWB")

dLocation[,IDH03:=localityCode]
dMaster <- merge(dWorkers, dLocation[,c("IDH03","region","district")], by="IDH03",all.x=T)
nrow(dWorkers)
nrow(dMaster)

nrow(dMaster)
dMaster <- merge(dMaster, dFacilities[,c("IDH00","facilitySector")], by="IDH00", all.x=T)
nrow(dMaster)

unique(dMaster[is.na(region),"IDH03"])

for(i in c("isPalestine","isGaza","isWB")){
  for(s in c("All sectors",unique(dFacilities$facilitySector))){
    d <- dMaster[(isProf_Doctor==1 | isProf_Nurse==1) & get(i)==1]
    if(s!="All sectors"){
      d <- d[facilitySector==s]
    }
    
    d[,numerator:=isProf_Nurse]
    d[,denominator:=isProf_Doctor]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01
    )]
    
    d <- d[,.(
      nurses=sum(numerator),
      doctors=sum(denominator)
    )]
    d[,ratio:=nurses/doctors]
    
    cat(sprintf("***** ALL: %s - %s *****\n",i,s))
    print(d)
    cat("\n\n")
    
    d <- dMaster[(isProf_Doctor==1 | isProf_Nurse==1) & get(i)==1]
    if(s!="All sectors"){
      d <- d[facilitySector==s]
    }
    
    d[,numerator:=isProf_Nurse]
    d[,denominator:=isProf_Doctor]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01,region
    )]
    
    d <- d[,.(
      nurses=sum(numerator),
      doctors=sum(denominator)
    ),by=.(region)]
    d[,ratio:=nurses/doctors]
    
    cat(sprintf("***** REGION: %s - %s *****\n",i,s))
    print(d)
    cat("\n\n")
    
    d <- dMaster[(isProf_Doctor==1 | isProf_Nurse==1) & get(i)==1]
    if(s!="All sectors"){
      d <- d[facilitySector==s]
    }
    
    d[,numerator:=isProf_Nurse]
    d[,denominator:=isProf_Doctor]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01,district
    )]
    
    d <- d[,.(
      nurses=sum(numerator),
      doctors=sum(denominator)
    ),by=.(district)]
    d[,ratio:=nurses/doctors]
    
    cat(sprintf("***** DISTRICT: %s - %s *****\n",i,s))
    print(d)
    cat("\n\n")
    
    d <- dMaster[(isProf_Doctor==1 | isProf_Nurse==1) & get(i)==1]
    if(s!="All sectors"){
      d <- d[facilitySector==s]
    }
    
    d[,numerator:=isProf_Nurse]
    d[,denominator:=isProf_Doctor]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01,campUrbanRural
    )]
    
    d <- d[,.(
      nurses=sum(numerator),
      doctors=sum(denominator)
    ),by=.(campUrbanRural)]
    d[,ratio:=nurses/doctors]
    
    cat(sprintf("***** campUrbanRural: %s - %s *****\n",i,s))
    print(d)
    cat("\n\n")
  }
}
```

# Disability Indicators with sector/geographic specific denominators

```{r, warning=FALSE}
dFacilities[,isPalestine:=1]
dFacilities[,isGaza := as.numeric(NA)]
dFacilities[,isWB:=as.numeric(NA)]
dFacilities[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dFacilities[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

stack <- data.table(expand.grid(
  sector=c("All sectors",unique(dFacilities$facilitySector)),
  dist=c("isPalestine","isGaza","isWB"),stringsAsFactors = F))

for(i in 1:nrow(stack)){
  d <- dFacilities[get(stack[i]$dist)==1]
  if(stack[i]$sector!="All sectors") d <- d[facilitySector==stack[i]$sector]
  
  
  
  
  numerator <- sum(d$IS03_A,na.rm=T)
  if(stack[i]$dist=="isPalestine" & stack[i]$sector=="All sectors"){
    denominator <- length(unique(dWorkers$HR01))
  } else {
    denominator <- length(unique(dWorkers[IDH00 %in% d$IDH00]$HR01))
  }
  
  missing <- sum(is.na(d$IS03_A),na.rm=T)
  cat(sprintf("*******%s %s with sector/geographic specific denominators\n",stack[i]$dist,stack[i]$sector))
  cat(sprintf("numerator: %s denominator: %s, missing: %s, percentage: %s%%\n",
              numerator,denominator,missing,RAWmisc::Format(numerator/denominator*100),1))
  cat("\n\n")
}
```

# Disability Indicators with Palestine as denominator

```{r, warning=FALSE}
dFacilities[,isPalestine:=1]
dFacilities[,isGaza := as.numeric(NA)]
dFacilities[,isWB:=as.numeric(NA)]
dFacilities[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dFacilities[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

stack <- data.table(expand.grid(
  sector=c("All sectors",unique(dFacilities$facilitySector)),
  dist=c("isPalestine","isGaza","isWB"),stringsAsFactors = F))

for(i in 1:nrow(stack)){
  d <- dFacilities[get(stack[i]$dist)==1]
  if(stack[i]$sector!="All sectors") d <- d[facilitySector==stack[i]$sector]
  
  
  
  
  numerator <- sum(d$IS03_A,na.rm=T)
  #if(stack[i]$dist=="isPalestine" & stack[i]$sector=="All sectors"){
    denominator <- length(unique(dWorkers$HR01))
  #} else {
  #  denominator <- length(unique(dWorkers[isProf_Healthworker==TRUE & 
  #                         IDH00 %in% d$IDH00]$HR01))
  #}
  
  missing <- sum(is.na(d$IS03_A),na.rm=T)
  cat(sprintf("*******%s %s with Palestine as denominator\n",stack[i]$dist,stack[i]$sector))
  cat(sprintf("numerator: %s denominator: %s, missing: %s, percentage: %s%%\n",
              numerator,denominator,missing,RAWmisc::Format(numerator/denominator*100),1))
  cat("\n\n")
}
```

# Services Indicators

## Numbers and per 1000

```{r, warning=FALSE}
dFacilities[,isHospital:=0]
dFacilities[IS06==9,isHospital:=1]

dFacilities[,isMOH_PHC:=0]
dFacilities[facilitySector=="Ministry of Health" & IS06==4, isMOH_PHC:=1]

dFacilities[,isPrivate_Lab:=0]
dFacilities[facilitySector=="Private" & IS06==8, isPrivate_Lab:=1]

dFacilities[,isPrivate_Radiology:=0]
dFacilities[facilitySector=="Private" & IS06==6, isPrivate_Radiology:=1]

dFacilities[,isPrivate_Dentistry:=0]
dFacilities[facilitySector=="Private" & IS06==3, isPrivate_Dentistry:=1]

dFacilities[,isPrivate_Rehab:=0]
dFacilities[facilitySector=="Private" & IS06==7, isPrivate_Rehab:=1]

dFacilities[,isPalestine:=1]
dFacilities[,isGaza:=0]
dFacilities[,isWB:=0]
dFacilities[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dFacilities[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]
dFacilities[IDH03 %in% dLocation[region=="East Jerusalem (J1)"]$localityCode, isEJerusalem:=1]

stack <- data.table(expand.grid(
  type=c("isHospital",
         "isMOH_PHC",
         "isPrivate_Lab",
         "isPrivate_Radiology",
         "isPrivate_Dentistry",
         "isPrivate_Rehab"),
  location=c("isPalestine","isGaza","isWB","isEJerusalem")
  , stringsAsFactors = F
))

for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dFacilities[get(s$type)==1 & get(s$location)==1]
  
  if(s$location=="isPalestine"){
    usePop <- pop[districtName=="Palestine population"]$pop
  } else if(s$location=="isGaza"){
    usePop <- pop[districtName=="Gaza Population"]$pop
  } else if(s$location=="isWB"){
    usePop <- pop[districtName=="West Bank Population"]$pop
  } else if(s$location=="isEJerusalem"){
    usePop <- 0
  }
  
  cat(sprintf("\n\n*********\nNumber of %s in %s: %s\n",
              s$type,
              s$location,
              nrow(d)
              ))
  
  cat(sprintf("\n\n%s in %s per 1,000 pop: %s\n",
              s$type,
              s$location,
              nrow(d)/usePop*1000
              ))
}

```



## Percentage distributions of hospitals

```{r, warning=FALSE}

for(i in c("isPalestine","isGaza","isWB")){
  d <- dFacilities[isHospital==1 & get(i)==1]
  
  d <- d[,.(
    N=.N
  ),by=.(
    facilitySector
  )]
  d[,denominator:=sum(N)]
  d[,perc:=N/denominator*100]
  
  cat(sprintf("\n\n*** %s ***\n",i))
  print(d)
  
}

```

## Numbers and per 1000 by sector

```{r, warning=FALSE}

stack <- data.table(expand.grid(
  type=sort(unique(dFacilities$IS06)),
  sector=unique(dFacilities$facilitySector),
  location=c("isPalestine","isGaza","isWB","isEJerusalem")
  , stringsAsFactors = F
))

for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dFacilities[IS06==s$type & facilitySector==s$sector & get(s$location)==1]
  
  if(s$location=="isPalestine"){
    usePop <- pop[districtName=="Palestine population"]$pop
  } else if(s$location=="isGaza"){
    usePop <- pop[districtName=="Gaza Population"]$pop
  } else if(s$location=="isWB"){
    usePop <- pop[districtName=="West Bank Population"]$pop
  } else if(s$location=="isEJerusalem"){
    usePop <- 0
  }
  
  cat(sprintf("\n\n*********\nNumber of IS06=%s in %s in %s: %s\n",
              s$type,
              s$sector,
              s$location,
              nrow(d)
              ))
  
  cat(sprintf("\n\nIS06=%s in %s in %s per 1,000 pop: %s\n",
              s$type,
              s$sector,
              s$location,
              round(nrow(d)/usePop*1000,4)
              ))
}

```

# Palestine Medical Council (July 2018)

## Age distribution of specialist doctors by specialisation, by Pal/WB/Gaza

```{r, warning=FALSE}

specializations <- sort(unique(dWorkers$doctor_specialization))
stack <- na.omit(data.table(expand.grid(dist=districtNames,prof=specializations,stringsAsFactors = F)))

res <- list()
for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dWorkers[doctor_specialization==s$prof & get(s$dist)==1]
  
  d <- d[,.(
    numerator=1
  ),by=.(
   HR01,
   ageCat
  )]
  
  d <- d[,.(
    numerator=sum(numerator)
  ),by=.(
   ageCat
  )]
  setorder(d,ageCat)
  
  d[!is.na(ageCat),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  
  cat("*******\n")
  cat(sprintf("%s %s\n",s$prof,s$dist))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
    res[[i]] <- d
  }
  
  cat("\n\n")
}
```

## Gender distribution of specialist doctors by specialisation, by Pal/WB/Gaza/District

```{r, warning=FALSE}

specializations <- sort(unique(dWorkers$doctor_specialization))
stack <- na.omit(data.table(expand.grid(dist=c(districtNames,names(dWorkers)[stringr::str_detect(names(dWorkers),"^isDistrict_")]),prof=specializations,stringsAsFactors = F)))

res <- list()
for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dWorkers[doctor_specialization==s$prof & get(s$dist)==1]
  
  d <- d[,.(
    numerator=1
  ),by=.(
   HR01,
   isFemale
  )]
  
  d <- d[,.(
    numerator=sum(numerator)
  ),by=.(
   isFemale
  )]
  setorder(d,isFemale)
  
  d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  
  cat("*******\n")
  cat(sprintf("%s %s\n",s$prof,s$dist))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
    res[[i]] <- d
  }
  
  cat("\n\n")
}
```

## Geographical distribution of specialist doctors by specialisation

```{r, warning=FALSE}

specializations <- sort(unique(dWorkers$doctor_specialization))
stack <- na.omit(data.table(expand.grid(prof=specializations,stringsAsFactors = F)))

areas <- sort(names(dWorkers)[stringr::str_detect(names(dWorkers),"^isDistrict_")])

res <- list()
for(i in 1:nrow(stack)){
  s <- stack[i]
  res <- list()
  
  d <- dWorkers[doctor_specialization==s$prof]
  temp <- data.frame(area="00PALESTINE (no duplicates)",num=length(unique(d$HR01)))
  res[["00PALESTINE (no duplicates)"]] <- temp
  
  for(j in areas){
    d <- dWorkers[doctor_specialization==s$prof & get(j)==TRUE]
    temp <- data.frame(area=j,num=length(unique(d$HR01)))
    res[[j]] <- temp
  }
  d <- rbindlist(res)
  
  cat("*******\n")
  cat(sprintf("%s \n",s$prof))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
  }
  
  cat("\n\n")
}
```

# Requests 22nd July 2018

## We need the gender distribution by districts by profession

```{r message=FALSE, warning=FALSE}
districtNames <- c("isPalestine","isGaza","isWB")
for(i in unique(dLocation$district)){
  newName <- stringr::str_replace_all(i,"[& ,\\-\\(\\)]","")
  newName <- sprintf("isDistrict_%s",newName)
  districtNames <- c(districtNames, newName)
}

stack <- data.table(expand.grid(prof=professionVars,dist=districtNames,stringsAsFactors = F))

for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dWorkers[get(s$prof)==1 & get(s$dist)==1]
  allFemalesInPalestine <- length(unique(dWorkers[get(s$prof)==1 & isFemale==TRUE]$HR01))
  d[,numerator:=1]

  d <- d[,.(
   numerator=max(numerator,na.rm=T)
  ),by=.(
   HR01,
   isFemale
  )]
  
  d <- d[!is.na(isFemale),.(numerator=sum(numerator)),by=isFemale]
  d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  d[,ratio:=RAWmisc::Format(numerator/(denominator_excl_miss-numerator),2)]
  d[,allFemalesInPalestine:=allFemalesInPalestine]
  d[isFemale==1,percOfAllFemalesInPalestine:=RAWmisc::Format(numerator/allFemalesInPalestine*100,1)]
  setorder(d,isFemale)
  cat("*******\n")
  cat(sprintf("%s %s\n",s$prof,s$dist))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
  }
  cat("\n\n")
}

```

## The total number of nurses with a diploma nursing (ED03 A = 3. Diploma and ED01 = 3.)

```{r message=FALSE, warning=FALSE}
dED03 <- masterdED03[ED03A==3]
d <- merge(dWorkers[ED01==3],dED03,by="HR01")
print(nrow(d[isProf_Nurse==TRUE]))
```

## xx. isProf_Specializeddoctor to isProf_GP ratio in Palestine/West Bank/Gaza and by sector.

```{r, warning=FALSE}
# todo
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

for(i in c("All",unique(dMaster$facilitySector))){
  for(location in c("isPalestine","isWB","isGaza")){
    if(location=="isPalestine"){
      usePopulation <- pop[districtName=="Palestine population"]$pop
    } else if(location=="isWB"){
      usePopulation <- pop[districtName=="West Bank Population"]$pop
    } else if(location=="isGaza"){
      usePopulation <- pop[districtName=="Gaza Population"]$pop
    }
    d <- dMaster[(isProf_Specializeddoctor==1 | isProf_GP==1) & get(location)==1]
    if(i!="All") d <- d[facilitySector==i]
    
    d[,numerator:=isProf_Specializeddoctor]
    d[,denominator:=isProf_GP]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01
    )]
    
    cat(sprintf("***** %s %s *****\n",i,location))
    cat(sprintf("isProf_Specializeddoctor: %s\n",sum(d$numerator)))
    cat(sprintf("isProf_GP: %s\n",sum(d$denominator)))
    cat(sprintf("Ratio: %s\n",sum(d$numerator)/sum(d$denominator)))
    cat("\n\n")
  }
}
```

## 1. Total number of PharmacyAssistant in Palestine/WB/Gaza

```{r message=FALSE, warning=FALSE}
for(location in c("isPalestine","isWB","isGaza")){
  cat("\n\n********",location,"**\n\n")
  if(location=="isPalestine"){
    usePopulation <- pop[districtName=="Palestine population"]$pop
  } else if(location=="isWB"){
    usePopulation <- pop[districtName=="West Bank Population"]$pop
  } else if(location=="isGaza"){
    usePopulation <- pop[districtName=="Gaza Population"]$pop
  }
  d <- dWorkers[isProf_PharmacyAssistant==1 & get(location)==1]
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  PrintTableNPerc(d)
  
  cat("***PER 1000 PEOPLE ***\n")
  d[is.infinite(numerator),numerator:=NA]
  print(sum(d$numerator)/usePopulation*1000)
}
```

## WHAT COUNTRY DO DOCTORS GRADUATE FROM

```{r, warning=FALSE}
#dED03[ED03C %in% 720101:720152 & ED03A<4]
dED03 <- masterdED03[ED03C %in% 720101:720152 & ED03A>=4]
dED03[,lowest:=min(ED03A),by=HR01]
dED03 <- dED03[ED03A==lowest]
dED03[,N:=1:.N,by=HR01]
dED03 <- dED03[N==1]
#dED03

for(i in c("isPalestine","isGaza","isWB")){
  print(i)
  
  d <- dWorkers[isProf_Doctor==1 & get(i)==1]
  nrow(d)
  d <- merge(d,dED03,by="HR01",all.x=T)
  nrow(d)
  
  dCountryCodes <- readxl::read_excel(file.path(
    org::PROJ$RAW,"county_codes.xlsx"))
  setnames(dCountryCodes,c("english","x","ED03D","x2"))
  
  nrow(d)
  d[,ED03D:=as.numeric(ED03D)]
  d <- merge(d,dCountryCodes,by="ED03D",all.x=T)
  nrow(d)
  
  d <- d[,.(numerator=.N),by=.(english)]
  d[,denominator:=sum(numerator)]
  d[,perc:=RAWmisc::Format(100*numerator/denominator,digits=2)]
  setorder(d,-numerator)
  print(d)
}
```

## WHAT COUNTRY DO GPs GRADUATE FROM

```{r, warning=FALSE}
for(i in c("isPalestine","isGaza","isWB")){
  print(i)
  d <- dWorkers[isProf_GP==1 & get(i)==1]
  nrow(d)
  d <- merge(d,dED03,by="HR01",all.x=T)
  nrow(d)
  
  dCountryCodes <- readxl::read_excel(file.path(
    org::PROJ$RAW,"county_codes.xlsx"))
  setnames(dCountryCodes,c("english","x","ED03D","x2"))
  
  nrow(d)
  d[,ED03D:=as.numeric(ED03D)]
  d <- merge(d,dCountryCodes,by="ED03D",all.x=T)
  nrow(d)
  
  d <- d[,.(numerator=.N),by=.(english)]
  d[,denominator:=sum(numerator)]
  d[,perc:=RAWmisc::Format(100*numerator/denominator,digits=2)]
  setorder(d,-numerator)
  print(d)
}
```

## WHAT COUNTRY DO NURSES GRADUATE FROM

```{r, warning=FALSE}
dED03 <- masterdED03[ED03C %in% 720301:720315 & ED03A>=4]
dED03[,lowest:=min(ED03A),by=HR01]
dED03 <- dED03[ED03A==lowest]
dED03[,N:=1:.N,by=HR01]
dED03 <- dED03[N==1]
#dED03

for(i in c("isPalestine","isGaza","isWB")){
  print(i)
  d <- dWorkers[isProf_Nurse==1 & get(i)==1]
  nrow(d)
  d <- merge(d,dED03,by="HR01",all.x=T)
  nrow(d)
  
  dCountryCodes <- readxl::read_excel(file.path(
    org::PROJ$RAW,"county_codes.xlsx"))
  setnames(dCountryCodes,c("english","x","ED03D","x2"))
  
  nrow(d)
  d[,ED03D:=as.numeric(ED03D)]
  d <- merge(d,dCountryCodes,by="ED03D",all.x=T)
  nrow(d)
  
  d <- d[,.(numerator=.N),by=.(english)]
  d[,denominator:=sum(numerator)]
  d[,perc:=RAWmisc::Format(100*numerator/denominator,digits=2)]
  setorder(d,-numerator)
  print(d)
}
```

## WHAT COUNTRY DO dentists GRADUATE FROM

```{r, warning=FALSE}
dED03 <- masterdED03[ED03C %in% 720401:720412 & ED03A>=4]
dED03[,lowest:=min(ED03A),by=HR01]
dED03 <- dED03[ED03A==lowest]
dED03[,N:=1:.N,by=HR01]
dED03 <- dED03[N==1]
#dED03

for(i in c("isPalestine","isGaza","isWB")){
  print(i)
  d <- dWorkers[isProf_Dentist==1 & get(i)==1]
  nrow(d)
  d <- merge(d,dED03,by="HR01",all.x=T)
  nrow(d)
  
  dCountryCodes <- readxl::read_excel(file.path(
    org::PROJ$RAW,"county_codes.xlsx"))
  setnames(dCountryCodes,c("english","x","ED03D","x2"))
  
  nrow(d)
  d[,ED03D:=as.numeric(ED03D)]
  d <- merge(d,dCountryCodes,by="ED03D",all.x=T)
  nrow(d)
  
  d <- d[,.(numerator=.N),by=.(english)]
  d[,denominator:=sum(numerator)]
  d[,perc:=RAWmisc::Format(100*numerator/denominator,digits=2)]
  setorder(d,-numerator)
  print(d)
}
```

## WHAT COUNTRY DO pharmacists GRADUATE FROM

```{r, warning=FALSE}
dED03 <- masterdED03[ED03C %in% 720228:720229 & ED03A>=4]
dED03[,lowest:=min(ED03A),by=HR01]
dED03 <- dED03[ED03A==lowest]
dED03[,N:=1:.N,by=HR01]
dED03 <- dED03[N==1]
#dED03

for(i in c("isPalestine","isGaza","isWB")){
  print(i)
  d <- dWorkers[isProf_Pharmacist==1 & get(i)==1]
  nrow(d)
  d <- merge(d,dED03,by="HR01",all.x=T)
  nrow(d)
  
  dCountryCodes <- readxl::read_excel(file.path(
    org::PROJ$RAW,"county_codes.xlsx"))
  setnames(dCountryCodes,c("english","x","ED03D","x2"))
  
  nrow(d)
  d[,ED03D:=as.numeric(ED03D)]
  d <- merge(d,dCountryCodes,by="ED03D",all.x=T)
  nrow(d)
  
  d <- d[,.(numerator=.N),by=.(english)]
  d[,denominator:=sum(numerator)]
  d[,perc:=RAWmisc::Format(100*numerator/denominator,digits=2)]
  setorder(d,-numerator)
  print(d)
}
```





## WHAT COUNTRY DO specialized doctors GRADUATE FROM

```{r, warning=FALSE}
dED03 <- masterdED03[ED03C %in% 720101:720152 & ED03A>=4]
dED03[,lowest:=min(ED03A),by=HR01]
dED03 <- dED03[ED03A==lowest]
dED03[,N:=1:.N,by=HR01]
dED03 <- dED03[N==1]
#dED03

for(i in c("isPalestine","isGaza","isWB")){
  for(j in na.omit(unique(dMaster$doctor_specialization))){
    cat(i,j,"\n")
    d <- dWorkers[doctor_specialization==j & get(i)==1]
    nrow(d)
    d <- merge(d,dED03,by="HR01",all.x=T)
    nrow(d)
    
    dCountryCodes <- readxl::read_excel(file.path(
      org::PROJ$RAW,"county_codes.xlsx"))
    setnames(dCountryCodes,c("english","x","ED03D","x2"))
    
    nrow(d)
    d[,ED03D:=as.numeric(ED03D)]
    d <- merge(d,dCountryCodes,by="ED03D",all.x=T)
    nrow(d)
    
    d <- d[,.(numerator=.N),by=.(english)]
    d[,denominator:=sum(numerator)]
    d[,perc:=RAWmisc::Format(100*numerator/denominator,digits=2)]
    setorder(d,-numerator)
    print(d)
  }
}
```


## WHAT COUNTRY DO MIDWIVES GRADUATE FROM

```{r, warning=FALSE}
dED03 <- masterdED03[ED03C %in% 720308 & ED03A>=4]
dED03[,lowest:=min(ED03A),by=HR01]
dED03 <- dED03[ED03A==lowest]
dED03[,N:=1:.N,by=HR01]
dED03 <- dED03[N==1]
#dED03

for(i in c("isPalestine","isGaza","isWB")){
  print(i)
  d <- dWorkers[isProf_Midwife==1 & get(i)==1]
  nrow(d)
  d <- merge(d,dED03,by="HR01",all.x=T)
  nrow(d)
  
  dCountryCodes <- readxl::read_excel(file.path(
    org::PROJ$RAW,"county_codes.xlsx"))
  setnames(dCountryCodes,c("english","x","ED03D","x2"))
  
  nrow(d)
  d[,ED03D:=as.numeric(ED03D)]
  d <- merge(d,dCountryCodes,by="ED03D",all.x=T)
  nrow(d)
  
  d <- d[,.(numerator=.N),by=.(english)]
  d[,denominator:=sum(numerator)]
  d[,perc:=RAWmisc::Format(100*numerator/denominator,digits=2)]
  setorder(d,-numerator)
  print(d)
}
```

## Total number of working allied health sciences professionals in Palestine/WB/Gaza BY SECTOR

```{r message=FALSE, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector","IS06")], by="IDH00",all.x=T)
nrow(dWorkers)
nrow(dMaster)

for(i in c("isPalestine","isWB","isGaza")){
  cat(i,"\n")
  d <- dMaster[get(i)==1]
  d <- d[isProf_Alliedhealthsciences==1,.(
    numerator=1
  ),by=.(
    HR01,
    facilitySector
  )]
  d <- d[,
         .(num=sum(numerator)),
         by=.(
           facilitySector
         )
         ]
  setorder(d,facilitySector)
  
  print(d)
}
```



## Total number of resident doctors, by gender, by sector, by geographic area

```{r message=FALSE, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector","IS06")], by="IDH00",all.x=T)
nrow(dWorkers)
nrow(dMaster)

for(i in c("isPalestine","isWB","isGaza")){
  cat(i,"\n")
  d <- dMaster[get(i)==1]
  d <- d[isProf_residentdoctor==1,.(
    numerator=1
  ),by=.(
    HR01,
    facilitySector,
    isFemale
  )]
  d <- d[,
         .(num=sum(numerator)),
         by=.(
           facilitySector,
           isFemale
         )
         ]
  setorder(d,facilitySector,isFemale)
  
  print(d)
}
```


## 2019-01-21

### combined specialties for comparisons

```{r message=FALSE, warning=FALSE}
for(i in c("isPalestine","isWB","isGaza")) for(j in c(
  "isProf_surgicalgroupspecialists",
  "isProf_medgroupspecialists",
  "isProf_othergroupspecialists")){
  
  cat(i," - ",j,"\n")
  if(i=="isPalestine"){
    p <- pop[districtName=="Palestine population"]$pop
  } else if(i=="isWB"){
    p <- pop[districtName=="West Bank Population"]$pop
  } else if(i=="isGaza"){
    p <- pop[districtName=="Gaza Population"]$pop
  }
  
  d <- dWorkers[get(i)==1 & get(j)==1]
  d <- d[,.(
    N=1
  ),by=.(
    HR01,
    isFemale,
    ageCat
  )]
  
  res <- nrow(res)
  cat(sprintf("Num: %s, Pop: %s, Num/1000: %s\n",res,round(p),res/p*1000))
  
  res <- d[,.(
    num=.N
  ),keyby=.(isFemale)]
  
  cat("by sex:\n")
  print(res)
  
  res <- d[,.(
    num=.N
  ),keyby=.(ageCat)]
  
  cat("by age:\n")
  print(res)
  
  cat("\n\n")
  
}
```

## Total number of isProf_physiotherapists012019by sector, by geographic area

```{r message=FALSE, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector","IS06")], by="IDH00",all.x=T)
nrow(dWorkers)
nrow(dMaster)

for(i in c("isPalestine","isWB","isGaza")){
  cat(i,"\n\n")
  d <- dMaster[get(i)==1]
  d <- d[isProf_physiotherapists012019==1,.(
    numerator=1
  ),by=.(
    HR01,
    facilitySector,
    isFemale
  )]
  d <- d[,
         .(num=sum(numerator)),
         keyby=.(
           facilitySector
         )
         ]
  
  print(d)
}
```

# 2019-20-27

## Healthcare workers with another non-healthcare job in the same facility

```{r message=FALSE, warning=FALSE}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector","IS06")], by="IDH00",all.x=T)
nrow(dWorkers)
nrow(dMaster)

for(i in c("isPalestine","isWB","isGaza")){
  cat(i,"\n\n")
  d <- dMaster[get(i)==1]
  d <- d[
    (CW00isProf_Healthworker==1 & CW06isProf_Healthworker==0) |
    (CW00isProf_Healthworker==0 & CW06isProf_Healthworker==1)
    ,.(
    numerator=1
  ),by=.(
    HR01,
    facilitySector
  )]
  d <- d[,
         .(num=sum(numerator)),
         keyby=.(facilitySector)
         ]
  
  print(d)
}
```
