---
title: "Health Workforce Validation"
author: Richard White
date: "`r lubridate::today()`"
output:
  pdf_document: default
---


\newpage

# Loading in data
```{r, results='hide', message=FALSE, warning=FALSE}
RAWmisc::AllowFileManipulationFromInitialiseProject()
RAWmisc::InitialiseProject(
  HOME = "/git/code_major/2017/hadeel_health_workforce/",
  RAW = "/dropbox/data_raw/code_major/2017/hadeel_health_workforce/",
  CLEAN = "/analyses/data_clean/code_major/2017/hadeel_health_workforce/",
  BAKED = "/analyses/results_baked/code_major/2017/hadeel_health_workforce/",
  FINAL = "/analyses/results_final/code_major/2017/hadeel_health_workforce/",
  SHARED = "/dropbox/data_raw/code_major/2017/hadeel_health_workforce/results/")

library(data.table)
library(ggplot2)

jordanValley <- readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                             "Jordan valley villages (OCHA).xlsx"))

updatedFacilitiesList <- readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                    "data_richard",
                                    "All Facilities FINAL - Richard.xlsx"))

# FACILITIES
d1 <- readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                    "Data collected by PCBS - Gaza 1st phase",
                                    "Gaza Phase I - After auditing by Fayez",
                                    "FACILITY_MAIN_Gaza I_Richard.xlsx"))

d2 <- readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                    "Data collected by PCBS - WB 1st phase",
                                    "WB - Phase I",
                                    "FACILITY_MAIN WB I_Richard.xlsx"))

d3 <- readxl::read_excel(file.path(
  RAWmisc::PROJ$RAW,
  "Data collected by PNIPH - Gaza 2nd phase",
  "FACILITY_MAIN_GAZA-2nd phase-final-Richard.xlsx"))

d4 <- readxl::read_excel(file.path(
  RAWmisc::PROJ$RAW,
  "Data collected by PNIPH - WB 2nd phase",
  "FACILITY_MAIN_WB-second phase-final-Richard.xlsx"))

dFacilities <- data.table(rbind(d1,d2,d3[names(d1)],d4[names(d1)]))
dFacilities[,IDH01:=as.numeric(IDH01)]
dFacilities[!is.na(IDH03),isJordanValley:=0]
dFacilities[IDH03 %in% jordanValley$`Basic:Geo PCBS Code`,isJordanValley:=1]
xtabs(~dFacilities$isJordanValley)
xtabs(~dFacilities$RE01)

dFacilities[,NUMDUP:=.N, by=IDH00]
setorder(dFacilities,IDH00)
duplicateFacilities <- dFacilities[NUMDUP>1,
                                   c("IDH00","IDH01","IDH03","IS04","IDH02")]
openxlsx::write.xlsx(duplicateFacilities,
                     file.path(RAWmisc::PROJ$SHARED_TODAY,"dupliated_facilities.xlsx"))


# Remove duplicated facilities
updatedFacilitiesList[updatedFacilitiesList$IDH00 %in% duplicateFacilities$IDH00,c("IDH00","IS04")]
duplicateFacilities[,c("IDH00","IDH01","IDH03","IS04")]

dFacilities <- dFacilities[!(IDH00==1855756 & IS04!=1)]
dFacilities <- dFacilities[!(IDH00==1862880 & IS04!=1)]
dFacilities <- dFacilities[!(IDH00==1887796 & IS04!=2)]
dFacilities <- dFacilities[!(IDH00==1978454 & IS04!=7)]

nrow(updatedFacilitiesList)
length(unique(updatedFacilitiesList$IDH00))

nrow(dFacilities)
length(unique(dFacilities$IDH00))

updatedFacilitiesList[updatedFacilitiesList$IDH00 %in% duplicateFacilities$IDH00,c("IDH00","IS04")]
duplicateFacilities[,c("IDH00","IDH01","IDH03","IS04")]
dFacilities[dFacilities$IDH00 %in% duplicateFacilities$IDH00,c("IDH00","IS04")]

# Update old facilities data with new facilities data
names(updatedFacilitiesList)[!names(updatedFacilitiesList) %in% names(dFacilities)]
for(name in names(updatedFacilitiesList)){
  if(name=="IDH00") next
  dFacilities[,(name):=NULL]
}
nrow(dFacilities)
dFacilities <- merge(dFacilities, updatedFacilitiesList, by="IDH00",all.x=T)
nrow(dFacilities)
# END UPDATE

table(dFacilities$IS04,useNA = "always")
dFacilities[,facilitySector:=as.character(NA)]
dFacilities[IS04 %in% c(7),facilitySector:="Ministry of Health"]
dFacilities[IS04 %in% c(9),facilitySector:="Military Health Services"]
dFacilities[IS04 %in% c(8),facilitySector:="UNRWA"]
dFacilities[IS04 %in% c(1,12),facilitySector:="Private"]
dFacilities[IS04 %in% c(2,3,4,5,6,10,11,13,14),facilitySector:="NGO"]
dFacilities[,IDH03:=as.numeric(IDH03)]
dFacilities[IDH03==100750,IDH03:=100570]

xtabs(~dFacilities$IS04,addNA=TRUE)
xtabs(~dFacilities$facilitySector,addNA=TRUE)
xtabs(~dFacilities$IS04+dFacilities$facilitySector,addNA=TRUE)

# WORKERS
d1 <- readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                    "Data collected by PCBS - Gaza 1st phase",
                                    "Gaza Phase I - After auditing by Fayez",
                                    "WORKERS_MAIN (1).xlsx"))
d1 <- d1[,names(d1)[1:which(names(d1)=="MD03_1_B")]]

d2 <- readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                    "Data collected by PCBS - WB 1st phase",
                                    "WB - Phase I",
                                    "WORKERS_MAIN WB.xlsx"))
d2 <- d2[,names(d2)[1:which(names(d2)=="MD03_1_B")]]

d3 <- readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                    "Data collected by PNIPH - Gaza 2nd phase",
                                    "WORKERS_MAIN_GAZA-final-2nd phase.xlsx"))

d4 <- readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                    "Data collected by PNIPH - WB 2nd phase",
                                    "WORKERS_MAIN_WB-second phase-final.xlsx"))

d2 <- d2[,names(d1)]
d3 <- d3[,names(d1)]
d4 <- d4[,names(d1)]

dWorkers <- data.table(rbind(d1,d2,d3,d4))
dWorkers[,IDH03:=as.numeric(IDH03)]
dWorkers[IDH03==100750,IDH03:=100570]
dWorkers[IDH03==45540,IDH03:=452240]
dWorkers[IDH03==310810,IDH03:=301810]
nrow(dWorkers)

# workers from system
workersFromSystem <- data.table(readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                    "Workers records from system.xlsx")))

x1 <- data.table(table(dWorkers$HR01))
setnames(x1,c("HR01","n_richard"))

x2 <- data.table(table(workersFromSystem$HR01))
setnames(x2,c("HR01","n_system"))

x <- merge(x1,x2,by="HR01",all=T)
x[is.na(n_system),n_system:=0]
x[is.na(n_richard),n_richard:=0]
openxlsx::write.xlsx(x[n_richard!=n_system],file.path(RAWmisc::PROJ$SHARED_TODAY,"HR01_discrepancies.xlsx"))



# updating genders by their names
dGender <- data.table(readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                    "2017_12_14_hadeel_missing_gender.xlsx")))
dGender <- dGender[!is.na(HR01) & HR01!=999999999]
dGender[tolower(Gender)=="male",HR02_new:=1]
dGender[tolower(Gender)=="female",HR02_new:=2]
dGender <- unique(dGender[,c("HR01","HR02_new")])
sum(is.na(dGender$HR02_new)) # 22
dGender[,N:=.N,by=HR01]
dGender[N>1]
dGender <- dGender[!is.na(HR02_new) & N==1]
dGender[,N:=NULL]
nrow(dGender) # 489

nrow(dWorkers)
dWorkers <- merge(dWorkers,dGender,by=c("HR01"),all.x=T)
nrow(dWorkers)
sum(is.na(dWorkers$HR02)) #587
dWorkers[is.na(HR02) & !is.na(HR02_new), HR02:=HR02_new]
sum(is.na(dWorkers$HR02)) #32
dWorkers[,HR02_new:=NULL]

length(unique(dWorkers[is.na(HR02)]$HR01)) #25

# midwives that should be female
femaleWorkers <- data.table(readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                                         "data_richard",
                                                         "Workers to be changed from male to female.xlsx")))
dWorkers[HR01 %in% femaleWorkers$`Worker ID Number`, HR02:=2]

# updating genders for people with dual genders in same ID
dGender <- data.table(readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                    "Workers records same ID but different gender.xlsx")))
setnames(dGender,c("HR01","Gender"))
dGender[tolower(Gender)=="male",HR02_new:=1]
dGender[tolower(Gender)=="female",HR02_new:=2]
dGender <- unique(dGender[,c("HR01","HR02_new")])
sum(is.na(dGender$HR02_new)) # 0
dGender[,N:=.N,by=HR01]
dGender[N>1]
dGender <- dGender[!is.na(HR02_new) & N==1]
dGender[,N:=NULL]
nrow(dGender) # 17

nrow(dWorkers)
dWorkers <- merge(dWorkers,dGender,by=c("HR01"),all.x=T)
nrow(dWorkers)
sum(is.na(dWorkers$HR02)) #32
dWorkers[is.na(HR02) & !is.na(HR02_new), HR02:=HR02_new]
sum(is.na(dWorkers$HR02)) #26

namesIDGender <- unique(dWorkers[,c("HR00","HR01","HR02")])
namesIDGender <- namesIDGender[,.(N=.N),by=.(HR00,HR01)]
openxlsx::write.xlsx(namesIDGender[N>1],file.path(RAWmisc::PROJ$SHARED_TODAY,"two_genders_same_name.xlsx"))

# update old workers facilities data with new facilities data
xtabs(~updatedFacilitiesList$IDH01)
xtabs(~updatedFacilitiesList$IDH01_T)
setnames(updatedFacilitiesList,
         c("IDH01","IDH01_T","IDH02"),
         c("IDH02","IDH02_T","IDH04"))
xtabs(~updatedFacilitiesList$IDH02)
xtabs(~updatedFacilitiesList$IDH02_T)

updateWorkerNames <- c("IDH00","IDH02","IDH02_T","IDH04","IDH03","IDH03_T")
for(name in updateWorkerNames){
  if(name=="IDH00") next
  dWorkers[,(name):=NULL]
}
nrow(dWorkers)
dWorkers <- merge(dWorkers, updatedFacilitiesList[,updateWorkerNames], by="IDH00",all.x=T)
nrow(dWorkers)

# IF dWorkers$IDH03 is missing, use dFacilities$IDH03 and link on IDH00
fixable <- unique(dFacilities[,c("IDH00","IDH03")])
setnames(fixable,"IDH03","IDH03_from_facility")
nrow(dWorkers)
dWorkers <- merge(dWorkers,fixable,by="IDH00",all.x=T)
nrow(dWorkers)
dWorkers[is.na(IDH03),IDH03:=IDH03_from_facility]
nrow(dWorkers)
# DISTRICTS
dLocation <- list()
for(i in c("North WB","Middle WB", "South WB", "North Gaza", "Middle Gaza", "South Gaza", "East Jerusalem (J1)")){
  dLocation[[i]] <- readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                                   "Districts and localities codes - Richard.xls"),
                                         sheet = i)
  dLocation[[i]]$region <- i
}
dLocation <- rbindlist(dLocation)
dLocation[,isGaza := 0]
dLocation[region %in% c("North Gaza", "Middle Gaza", "South Gaza"), isGaza := 1]
setnames(dLocation,c("district","districtCode","localityCode","localityName","urbanRural","region","isGaza"))
dLocation[,districtCode:=as.numeric(districtCode)]
dLocation <- dLocation[!is.na(districtCode)]
dLocation[,districtJerusalemClean:=district]
dLocation[district %in% c("Jerusalem (J2)", "East Jerusalem (J1)"),districtJerusalemClean:="Jerusalem"]

dLocation[,isGazaNOJERUSALEM:=isGaza]
dLocation[district=="East Jerusalem (J1)",isGazaNOJERUSALEM:=NA]
dLocation[,gazaWBEJ:="West Bank (Not East J)"]
dLocation[isGaza==1,gazaWBEJ:="Gaza"]
dLocation[district=="East Jerusalem (J1)",gazaWBEJ:="East Jerusalem"]


# WORKER CODES
dSpecializedDoctors <- readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                                   "Groups - ULTIMIT.xlsx"),
                                         sheet = "Specialized doctor")
dSpecializedDoctors <- dSpecializedDoctors[,c("Code of profession","Profession")]
setnames(dSpecializedDoctors,c("CW00","doctor_specialization"))
nrow(dWorkers)
dWorkers[,CW00:=as.numeric(CW00)]
dWorkers <- merge(dWorkers,dSpecializedDoctors[!is.na(dSpecializedDoctors$CW00),],by="CW00",all.x=T)
nrow(dWorkers)

dSpecializedDoctors <- readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                                   "Groups - ULTIMIT.xlsx"),
                                         sheet = "Specialized doctor")
dSpecializedDoctors <- dSpecializedDoctors[,c("Code of profession","Profession")]
setnames(dSpecializedDoctors,c("CW06","CW06doctor_specialization"))
nrow(dWorkers)
dWorkers[,CW06:=as.numeric(CW06)]
dWorkers <- merge(dWorkers,dSpecializedDoctors[!is.na(dSpecializedDoctors$CW06),],by="CW06",all.x=T)
nrow(dWorkers)

sum(dWorkers$doctor_specialization!=dWorkers$CW06doctor_specialization,na.rm=T)

dWorkers[doctor_specialization!=CW06doctor_specialization]
dWorkers[,BOTHdoctor_specialization:=doctor_specialization]
dWorkers[is.na(BOTHdoctor_specialization),BOTHdoctor_specialization:=CW06doctor_specialization]

xtabs(~dWorkers$doctor_specialization)
xtabs(~dWorkers$BOTHdoctor_specialization)

sum(!is.na(dWorkers$doctor_specialization))
sum(!is.na(dWorkers$BOTHdoctor_specialization))

dWorkerCodes <- list()
for(i in c("Doctor",
           "Specialized doctor",
           "Dentist",
           "Pharmacist",
           "Nurse",
           "Midwife",
           "Psychologist,counselors, therap",
           "Psychiatrist",
           "Allied health sciences",
           "Alternative  Medicine",
           "Administrative & support staff"
)){
    dWorkerCodes[[i]] <- readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                                   "Groups - ULTIMIT.xlsx"),
                                         sheet = i)
    dWorkerCodes[[i]]$groupedProfession <- i
    if(ncol(dWorkerCodes[[i]])!=5) dWorkerCodes[[i]]$`Profession sub-category` <- ""
    if(i!="Doctor"){
      dWorkerCodes[[i]] <- dWorkerCodes[[i]][names(dWorkerCodes[["Doctor"]])]  
    }
}
for(i in names(dWorkerCodes)){
    newName <- stringr::str_replace_all(i,"[& ,]","")
    newName <- sprintf("isProf_%s",newName)
    dWorkerCodes[[i]][[newName]] <- 1
}
dWorkerCodes <- rbindlist(dWorkerCodes,fill=T)
setnames(dWorkerCodes,c(1:5),c("CW00","profession","arabicProfession","professionGrouped","progessionSubCategory"))

professionVarsTemp <- c(
  "isProf_Doctor",
  "isProf_Specializeddoctor",
  "isProf_Dentist",          
  "isProf_Pharmacist",
  "isProf_Nurse",
  "isProf_Midwife",
  "isProf_Psychologistcounselorstherap",
  "isProf_Psychiatrist",
  "isProf_Alliedhealthsciences",
  "isProf_AlternativeMedicine",
  "isProf_Administrativesupportstaff"  
  )

professionVarsTempHealthCare <- c(
  "isProf_Doctor",
  "isProf_Specializeddoctor",
  "isProf_Dentist",          
  "isProf_Pharmacist",
  "isProf_Nurse",
  "isProf_Midwife",
  "isProf_Psychologistcounselorstherap",
  "isProf_Psychiatrist",
  "isProf_Alliedhealthsciences"
  )
professionVars <- c(professionVarsTemp,"isProf_Healthworker","isProf_DocNurseMid")

for (col in professionVarsTemp) dWorkerCodes[is.na(get(col)), (col) := 0]
dWorkerCodes <- dWorkerCodes[, lapply(.SD, max, na.rm=T), by = CW00, .SDcols = professionVarsTemp]
dWorkerCodes[,isProf_Healthworker:=matrixStats::rowMaxs(as.matrix(.SD)),.SDcols=professionVarsTempHealthCare]
dWorkerCodes[,isProf_DocNurseMid:=matrixStats::rowMaxs(as.matrix(.SD)),.SDcols=c("isProf_Doctor","isProf_Nurse","isProf_Midwife")]

dWorkerCodes <- dWorkerCodes[!is.na(CW00)]

nrow(dWorkers)
dWorkers <- merge(dWorkers,dWorkerCodes,by="CW00",all.x=T)
nrow(dWorkers)

# NOW REDO FOR CW06
namesToChange <- names(dWorkerCodes)[stringr::str_detect(names(dWorkerCodes),"isProf")]
setnames(dWorkerCodes,namesToChange,paste0("CW06",namesToChange))
setnames(dWorkerCodes,"CW00","CW06")
nrow(dWorkers)
dWorkers[,CW06:=as.numeric(CW06)]
dWorkers <- merge(dWorkers,dWorkerCodes,by="CW06",all.x=T)
nrow(dWorkers)

for(i in professionVars){
  newVar <- sprintf("BOTH_%s",i)
  oldVar1 <- i
  oldVar2 <- sprintf("CW06%s",i)
  dWorkers[(!is.na(get(oldVar1))) | (!is.na(get(oldVar2))),(newVar):=0]
  dWorkers[get(oldVar1)==1,(newVar):=1]
  dWorkers[get(oldVar2)==1,(newVar):=1]
}

for(i in professionVars){
  print(sprintf("***%s***",i))
  tmpdata <- dWorkers[get(sprintf("BOTH_%s",i))==1]
  expression <- sprintf("print(xtabs(~tmpdata$%s+tmpdata$CW06%s,addNA=T))",i,i) 
   eval(parse(text=expression))
}

sum(is.na(dWorkers$CW00))
sum(is.na(dWorkers$CW06))
sum(is.na(dWorkers$CW00) & is.na(dWorkers$CW06))
sum(is.na(dWorkers$CW00) & !is.na(dWorkers$CW06))

professionVarsBOTH <- paste0("BOTH_",professionVars)

# Remove east jerusalem non-hospitals
badFacilities <- dFacilities[
  IDH03 %in% c(dLocation[district=="East Jerusalem (J1)"]$localityCode) &
  IS06!=9]$IDH00
nrow(dWorkers)
dWorkers <- dWorkers[!IDH00 %in% badFacilities]
nrow(dWorkers)
dFacilities <- dFacilities[!IDH00 %in% badFacilities]

#dFacilities[NUMDUP>1,c("IDH00","IDH01","IDH03","IS04","IDH02")]

# POPULATION
pop <- data.table(readxl::read_excel(file.path(RAWmisc::PROJ$RAW,"Districts population estimates 2016.xlsx")))
setnames(pop,c("districtName","pop","districtCode","area"))

PrintTableNPerc <- function(d){
  print(xtabs(~d$numerator,addNA=TRUE))
  cat(sprintf("\nN=%s\n", nrow(d)))
  cat(sprintf("Percentage indicator: %s%%\n", RAWmisc::Format(mean(d$numerator*100,na.rm=T),1)))
}
```

```{r}
nrow(dFacilities)
nrow(dWorkers)
```

## FINDING HR01==999999999

```{r}
missingHR01 <- dWorkers[HR01==999999999,
                          c("HR00","HR01","IDH04","HR02","HR03","IDH00","IDH03","CW00")]
dLoc <- unique(dLocation[,c("localityCode","localityName","district","gazaWBEJ")])

setnames(dLoc,"localityCode","IDH03")
nrow(missingHR01)
missingHR01 <- merge(missingHR01,dLoc,by="IDH03",all.x=T)
nrow(missingHR01)

openxlsx::write.xlsx(missingHR01,file.path(RAWmisc::PROJ$SHARED_TODAY,"missing_HR01.xlsx"))
```

## Multiple names, same ID number

```{r}
missingHR01 <- unique(dWorkers[,c("HR00","HR01")])
missingHR01[,numberOfNames:=.N,by=.(HR01)]
missingHR01 <- dWorkers[HR01 %in% missingHR01[numberOfNames>1]$HR01,
                          c("HR00","HR01","IDH04","HR02","HR03","IDH00","IDH03","CW00","CW00_T")]
dLoc <- unique(dLocation[,c("localityCode","localityName","district","gazaWBEJ")])

setnames(dLoc,"localityCode","IDH03")
nrow(missingHR01)
missingHR01 <- merge(missingHR01,dLoc,by="IDH03",all.x=T)
nrow(missingHR01)
setorder(missingHR01,HR01, HR00)

openxlsx::write.xlsx(missingHR01,file.path(RAWmisc::PROJ$SHARED_TODAY,"multiple_names_same_hr01.xlsx"))
```

## MISSING CW00 OR CW06

```{r}
missingCW <- dWorkers[is.na(CW00)]
missingCW <- merge(missingCW, dFacilities[,c("IDH00","facilitySector","IS04","IS06")], by="IDH00")
missingCW <- missingCW[,c("HR00","HR01","CW00","CW06","IS04","IS06","facilitySector","IDH03","IDH04")]

dLoc <- unique(dLocation[,c("localityCode","district","gazaWBEJ")])
setnames(dLoc,"localityCode","IDH03")

nrow(missingCW)
missingCW <- merge(missingCW,dLoc,by="IDH03",all.x=T)
nrow(missingCW)

openxlsx::write.xlsx(missingCW,file.path(RAWmisc::PROJ$SHARED_TODAY,"missing_CW00.xlsx"))
```

## FINDING MISSING GENDER PERSON

```{r}
missingGender <- dWorkers[is.na(HR02),
                          c("HR00","HR01")]
openxlsx::write.xlsx(missingGender,file.path(RAWmisc::PROJ$SHARED_TODAY,"missing_gender.xlsx"))
```


## LIST OF ALL FACILITIES IN AREA C AND JORDAN VALLEY

```{r}
areaC <- dFacilities[RE02==1,
                           c("IDH00","IDH01","IDH02","IDH03","IS06","IS04","facilitySector","RE01","RE02")]

openxlsx::write.xlsx(areaC,file.path(RAWmisc::PROJ$SHARED_TODAY,"facilities_areaC.xlsx"))

jordanvalley <- dFacilities[isJordanValley==1,
                           c("IDH00","IDH01","IDH02","IDH03","IS06","IS04","facilitySector","RE01","RE02")]

openxlsx::write.xlsx(jordanvalley,file.path(RAWmisc::PROJ$SHARED_TODAY,"facilities_jordan_valley.xlsx"))
```

## VALIDATING IDHs in WORKERS TO IDHs in FACILITIES

```{r}
dW <- dWorkers[,c("IDH00","IDH02","IDH03")] # district, locality
dF <- dFacilities[,c("IDH00","IDH01","IDH03")] # district, locality

setnames(dW,c("IDH00","IDH02_W_dist","IDH03_W_loc"))
setnames(dF,c("IDH00","IDH01_F_dist","IDH03_F_loc"))

nrow(dW)
d <- merge(dW,dF,by="IDH00",all.x=T)
nrow(d)

d[,districtMatch:=IDH02_W_dist==IDH01_F_dist]
d[,localityMatch:=IDH03_W_loc==IDH03_F_loc]

xtabs(~d$districtMatch, addNA = T)
xtabs(~d$localityMatch, addNA = T)

sum(is.na(dW$IDH02_W_dist))
sum(is.na(dF$IDH01_F_dist))

openxlsx::write.xlsx(d[,c("IDH00","IDH02_W_dist","IDH03_W_loc","IDH01_F_dist","IDH03_F_loc","districtMatch","localityMatch")],file.path(RAWmisc::PROJ$SHARED_TODAY,"VALIDATING IDHs in WORKERS TO IDHs in FACILITIES.xlsx"))
```


\newpage 

# Extra random things Hadeel wanted

Could we also have distribution of health facilities by IS04 and by sector.

For example: how many UNRWA facilities?
How many Military Health services facilities
How many private sector pharmacies?
How many Palestinian Red crescent facilties? 
etc... for each answer in IS04 how many facilities do we have. By IS06 if possible (type of facility). For example: how many UNRWA hospitals and how many UNRWA health centers in Palestine, in West Bank and in Gaza for all sectors and IS04. Thank you

## IS06

```{r}
d <- dFacilities[,.(N=.N),by=.(facilitySector,IS06)]
setorder(d,facilitySector,IS06)
print(d)
```

```{r}
dLoc <- unique(dLocation[,c("localityCode","district","gazaWBEJ")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities,dLoc,by="IDH03",all.x=T)
d <- d[,.(N=.N),by=.(gazaWBEJ,facilitySector,IS06)]
setorder(d,gazaWBEJ,facilitySector,IS06)
print(d)
```

### Taking a look at JERUSALEM DISTRICT

```{r}
d <- dFacilities[IDH03 %in% dLoc[district=="Jerusalem"]$IDH03,.(N=.N),by=.(facilitySector,IS06)]
setorder(d,facilitySector,IS06)
print(d)
```

### Taking a look at AREA C

```{r}
d <- dFacilities[RE02==1,.(N=.N),by=.(facilitySector,IS06)]
setorder(d,facilitySector,IS06)
print(d)
```

### Taking a look at JORDAN VALLEY [HADEEL CHECK THIS]

```{r}
d <- dFacilities[isJordanValley==1,.(N=.N),by=.(facilitySector,IS06)]
setorder(d,facilitySector,IS06)
print(d)
```

## IS04 ONLY NGOs

```{r}
d <- dFacilities[facilitySector=="NGO",.(N=.N),by=.(facilitySector,IS06,IS04)]
setorder(d,facilitySector,IS06,IS04)
setcolorder(d,c("facilitySector","IS06","IS04","N"))
print(d)
```

```{r}
dLoc <- unique(dLocation[,c("localityCode","district","gazaWBEJ")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities,dLoc,by="IDH03",all.x=T)
d <- d[facilitySector=="NGO",.(N=.N),by=.(gazaWBEJ,facilitySector,IS06,IS04)]
setorder(d,gazaWBEJ,facilitySector,IS06,IS04)
setcolorder(d,c("gazaWBEJ","facilitySector","IS06","IS04","N"))
print(d)
```

## WHAT COUNTRY DO DOCTORS GRADUATE FROM CW00 AND CW06

```{r}
d1 <- readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                    "Data collected by PCBS - Gaza 1st phase",
                                    "Gaza Phase I - After auditing by Fayez",
                                    "WORKERS_ED03 (1).xlsx"))

d2 <- readxl::read_excel(file.path(RAWmisc::PROJ$RAW,
                                    "Data collected by PCBS - WB 1st phase",
                                    "WB - Phase I",
                                    "WORKERS_ED03 WB.xlsx"))

d3 <- readxl::read_excel(file.path(
  RAWmisc::PROJ$RAW,
  "Data collected by PNIPH - Gaza 2nd phase",
  "WORKERS_ED03_GAZA-2nd phase-final.xlsx"))

d4 <- readxl::read_excel(file.path(
  RAWmisc::PROJ$RAW,
  "Data collected by PNIPH - WB 2nd phase",
  "WORKERS_ED03_WB-final-2nd phase.xlsx"))

masterdED03 <- dED03 <- data.table(rbind(d1,d2,d3[names(d1)],d4[names(d1)]))
#dED03[ED03C %in% 720101:720152 & ED03A<4]
dED03 <- dED03[ED03C %in% 720101:720152 & ED03A>=4]
dED03[,lowest:=min(ED03A),by=HR01]
dED03 <- dED03[ED03A==lowest]
dED03[,N:=1:.N,by=HR01]
dED03 <- dED03[N==1]
#dED03

d <- dWorkers[BOTH_isProf_Doctor==1]
nrow(d)
d <- merge(d,dED03,by="HR01",all.x=T)
nrow(d)

dCountryCodes <- readxl::read_excel(file.path(
  RAWmisc::PROJ$RAW,"county_codes.xlsx"))
setnames(dCountryCodes,c("english","x","ED03D","x2"))

nrow(d)
d[,ED03D:=as.numeric(ED03D)]
d <- merge(d,dCountryCodes,by="ED03D",all.x=T)
nrow(d)

d <- d[,.(numerator=.N),by=.(english)]
d[,denominator:=sum(numerator)]
d[,perc:=RAWmisc::Format(100*numerator/denominator,digits=2)]
setorder(d,-numerator)
print(d)
```

## Diploma vs BA nurse using CW00 AND CW06

```{r}
d <- dWorkers[BOTH_isProf_Nurse==1]
d[,numerator:=ED01>=4]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
cat("has a BA or higher, versus diploma or lower\n")
PrintTableNPerc(d)
cat("\n\n")
```

## How many OTHER places have you worked

```{r}
d <- copy(dWorkers)
d[,age:=floor(as.numeric(difftime("2016-01-01",HR03,units="days"))/365.25)]

d[,ageCat:=as.character(NA)]
d[age>=18 & age<=30,ageCat:="18-30"]
d[age>=31 & age<=45,ageCat:="31-45"]
d[age>=46 & age<=54,ageCat:="46-54"]
d[age>=55 & age<=59,ageCat:="55-59"]
d[age>=60,ageCat:="60+"]
d[,numerator:=ED01>=4]

d <- d[,.(
  number_places_worked=mean(PW03,na.rm=T)
),by=.(
  HR01,ageCat
)]

d <- d[,.(
  average_number_places_worked=mean(number_places_worked,na.rm=T),
  N=.N
),by=.(ageCat)]

setorder(d,ageCat)
print(d)
```

## How many OTHER places have you worked by profession (CW00 + CW06)

```{r}
for(i in professionVarsBOTH){
  d <- dWorkers[get(i)==1]
  d[,age:=floor(as.numeric(difftime("2016-01-01",HR03,units="days"))/365.25)]
  
  d[,ageCat:=as.character(NA)]
  d[age>=18 & age<=30,ageCat:="18-30"]
  d[age>=31 & age<=45,ageCat:="31-45"]
  d[age>=46 & age<=54,ageCat:="46-54"]
  d[age>=55 & age<=59,ageCat:="55-59"]
  d[age>=60,ageCat:="60+"]
  d[,numerator:=ED01>=4]
  
  d <- d[,.(
    number_places_worked=mean(PW03,na.rm=T)
  ),by=.(
    HR01,ageCat
  )]
  
  d <- d[,.(
    average_number_places_worked=mean(number_places_worked,na.rm=T),
    N=.N
  ),by=.(ageCat)]
  
  setorder(d,ageCat)
  cat(sprintf("***** %s *****\n",i))
  print(d)
  cat("\n\n")
}
```

# PCBS REQUESTS

## 1.   Distribution of health workers by Educational Speciality stratified by gender (ED03)

- only include ED03A<=7 [removing both people and records]
- only keep ED03A==max(ED03A) [highest level per person, removing just records]
- we now have problems with people with multiple records at the same level
- only keep ED03B==max(ED03B) [latest year per person, removing just records]
- only keep people whose countries are the same [removing just people!!!]
- keep records with the highest ED03C code [removing just records]
- people who answer as both male and female are recoded to female

```{r}
d <- dWorkers[BOTH_isProf_Healthworker==1]
d[,isFemale:=HR02-1]
d <- d[,.(isFemale=max(isFemale)),by=.(HR01)]

reducedED03 <- masterdED03[ED03A<=7 & !is.na(ED03C) & HR01 %in% d$HR01]
reducedED03[,maxED03A:=max(ED03A,na.rm=T),by=HR01]
reducedED03 <- reducedED03[maxED03A==ED03A]
reducedED03[,maxYear:=max(ED03B,na.rm=T),by=HR01]
reducedED03 <- reducedED03[maxYear==ED03B]
reducedED03[,num_at_same_level:=.N,by=HR01]
xtabs(~reducedED03$num_at_same_level)

reducedED03[,maxCountry:=max(ED03D,na.rm=T),by=HR01]
reducedED03 <- reducedED03[maxCountry==ED03D | is.na(maxCountry)]
reducedED03[,num_at_same_level:=.N,by=HR01]
xtabs(~reducedED03$num_at_same_level)

reducedED03[,max_ED03C:=max(ED03C),by=HR01]
reducedED03 <- reducedED03[max_ED03C==ED03C]
reducedED03[,num_at_same_level:=.N,by=HR01]
xtabs(~reducedED03$num_at_same_level)

reducedED03[,IDH00:=NULL]
reducedED03[,ED03E:=NULL]
reducedED03[,ED03C_T:=NULL]
reducedED03[,ED03D_T:=NULL]
reducedED03 <- unique(reducedED03)
reducedED03[,num_at_same_level:=.N,by=HR01]
xtabs(~reducedED03$num_at_same_level)

nrow(d)
d <- merge(d,reducedED03,by="HR01",all.x=T)
nrow(d)

res <- d[,.(N=.N),by=.(isFemale,ED03C)]
setorder(res,isFemale,-N)
openxlsx::write.xlsx(res,file.path(RAWmisc::PROJ$SHARED_TODAY,"Distribution of health workers by Educational Speciality stratified by gender.xlsx"))

nrow(d)
d[,ED03D:=as.numeric(ED03D)]
d <- merge(d,dCountryCodes,by="ED03D",all.x=T)
nrow(d)

res <- d[,.(N=.N),by=.(isFemale,ED03C,english)]
setorder(res,isFemale,english,-N)
openxlsx::write.xlsx(res,file.path(RAWmisc::PROJ$SHARED_TODAY,"Distribution of health workers by graduation country, educational specialty by gender.xlsx"))
```

## 3. Distribution of health workers by highest educational level and gender (ED01)
```{r}
d <- dWorkers[BOTH_isProf_Healthworker==1]
d[,isFemale:=HR02-1]
d <- d[,.(
  ED01=max(ED01,na.rm=T),
  isFemale=max(isFemale,na.rm=T)
),by=.(
  HR01
)]
d[is.infinite(ED01),ED01:=NA]
xtabs(~d$ED01+d$isFemale,addNA=T)
```


## 4. Distribution of health workers by years of experience and gender (ED02)
```{r}
d <- dWorkers[BOTH_isProf_Healthworker==1]
d[,isFemale:=HR02-1]
d <- d[,.(
  yearsExperience=max(ED02,na.rm=T),
  isFemale=max(isFemale,na.rm=T)
),by=.(
  HR01
)]
d[,yearsExperience:=cut(yearsExperience,c(-5,9,30,500))]
d[is.infinite(yearsExperience),yearsExperience:=NA]
xtabs(~d$yearsExperience+d$isFemale,addNA=T)
```


## Who lives in SAME district THAT THEY WORK IN (BY RECORDS)

### EVERYONE

```{r}
dWorkers[,livesInSameDistrictAsWork:= HR08_B==IDH02]
xtabs(~dWorkers$livesInSameDistrictAsWork, addNA=T)
```

### BY CW00 AND CW06

```{r}
for(i in professionVarsBOTH){
  print("")
  print("")
  print("****")
  print(i)
  print(xtabs(~dWorkers[get(i)==1]$livesInSameDistrictAsWork, addNA=T))
}
```


## Who lives RURAL AND WORKS IN URBAN (BY RECORDS)

### EVERYONE

```{r}
dWorkers[,livesInRural:= HR08_A %in% dLocation[urbanRural=="Rural"]$localityCode]
dWorkers[,worksInUrban:= IDH03 %in% dLocation[urbanRural=="Urban"]$localityCode]

xtabs(~dWorkers$livesInRural+dWorkers$worksInUrban, addNA=T)
```

### BY CW00 AND CW06

```{r}
for(i in professionVarsBOTH){
  print("")
  print("")
  print("****")
  print(i)
  d <- dWorkers[get(i)==1]
  print(xtabs(~d$livesInRural+d$worksInUrban, addNA=T))
}
```


\newpage 

# Pre-service training indicators

## 1. Total number of facilities that provide clinical trainings ( pre-graduation ) in Palestine

- Source: Facility questionnaire
- Calculation: TR01 answer 1
- Indicator description: Total number of health facilities in Palestine that offer clinical trainings sites 

### Results

```{r}
xtabs(~dFacilities$TR01,addNA=TRUE)
```

\newpage 

## 2. Total number of facilities that provide clinical trainings ( pre-graduation ) in the West Bank

- Source: Facility questionnaire
- Calculation: Sum of all TR01 answer 1 per  IDH 01 District in West Bank
- Indicator description: Total number of health facilities in the West Bank that offer clinical trainings sites 

```{r}
dLoc <- unique(dLocation[,c("localityCode","district","isGaza")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities,dLoc,by="IDH03",all.x=T)
nrow(d)
```

### Results

```{r}
with(d[isGaza==0],xtabs(~district+TR01,addNA=TRUE))
with(d[isGaza==0],xtabs(~TR01,addNA=TRUE))
```

\newpage 

## 3. Total number of facilities that provide clinical trainings (pre-graduation ) in Gaza

- Source: Facility questionnaire
- Calculation: Sum of all TR01 answer 1 per IDH 01 district in Gaza
- Indicator description: Total number of health facilities in Gaza that offer clinical trainings sites 

```{r}
dLoc <- unique(dLocation[,c("localityCode","district","isGaza")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities,dLoc,by="IDH03",all.x=T)
nrow(d)
```

### Results

```{r}
with(d[isGaza==1],xtabs(~district+TR01,addNA=TRUE))
with(d[isGaza==1],xtabs(~TR01,addNA=TRUE))
```

\newpage 

## 4. Total number of facilities that provide internships (post-graduation) in Palestine

- Source: Facility questionnaire
- Calculation: Sum of all TR05 answer 1
- Indicator description: Total number of health facilities in Palestine that offer internship sites needed to apply for licensing

```{r}
xtabs(~dFacilities$TR05,addNA=TRUE)
```

\newpage 

## 5. Total number of facilities that provide internships (post-graduation) in the West Bank

- Source: Facility questionnaire
- Calculation: Sum of all TR05 answer 1 per IDH01 district in West Bank
- Indicator description: Total number of health facilities in the West Bank that offer internship sites needed to apply for licensing

```{r}
dLoc <- unique(dLocation[,c("localityCode","district","isGaza")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities,dLoc,by="IDH03",all.x=T)
nrow(d)
```

### Results

```{r}
with(d[isGaza==0],xtabs(~district+TR05,addNA=TRUE))
with(d[isGaza==0],xtabs(~TR05,addNA=TRUE))
```


\newpage 

## 6. Total number of facilities that provide internships (post-graduation) in Gaza 

- Source: Facility questionnaire
- Calculation: Sum of all TR05 answer 1 per IDH01 district in Gaza
- Indicator description: Total number of health facilities in Gaza that offer internship sites needed to apply for licensing

```{r}
dLoc <- unique(dLocation[,c("localityCode","district","isGaza")])
setnames(dLoc,"localityCode","IDH03")

nrow(dFacilities)
d <- merge(dFacilities,dLoc,by="IDH03",all.x=T)
nrow(d)
```

### Results

```{r}
with(d[isGaza==1],xtabs(~district+TR05,addNA=TRUE))
with(d[isGaza==1],xtabs(~TR05,addNA=TRUE))
```

\newpage

## 7. Percentage of facilities with semi-structured clinical training programs in Palestine

- Source: Facility questionnaire
- Calculation: ( Sum of all TR01 answer 1. who answered at least 3 Yes from TR03   / sum of TR01 answer 1.  ) * 100
- Indicator description: Percentage of clinical training sites that offer semi-structures taining programs

```{r}
dFacilities[,sumYesTR03:=0]
dFacilities[,numMissing:=0]
for(l in c("A","B","C","D","E","F","G")){
  newVar <- sprintf("TR03_%s",l)
  dFacilities[get(newVar)==1,sumYesTR03:=sumYesTR03+1]
  dFacilities[is.na(get(newVar)),numMissing:=numMissing+1]
}
dFacilities[numMissing>=5,sumYesTR03:=NA]

dFacilities[,three_or_more_TR03:=as.numeric(NA)]
dFacilities[!is.na(sumYesTR03),three_or_more_TR03:=0]
dFacilities[sumYesTR03>=3,three_or_more_TR03:=1]

d <- dFacilities[TR01==1]
d[,numerator:=three_or_more_TR03]
```

### Results

```{r}
PrintTableNPerc(d)
```

\newpage

## 8. Percentage of facilities with semi-structured internship programs in Palestine

- Source: Facility questionnaire
- Calculation: ( Sum of all TR05 answer 1. who answered at least 3 YES from TR07  / sum of all TR05 answer 1 ) * 100
- Indicator description: Percentage of internship sites that offer semi-structures training programs

```{r}
dFacilities[,sumYesTR07:=0]
dFacilities[,numMissing:=0]
for(l in c("A","B","C","D","E","F","G")){
  newVar <- sprintf("TR07_%s",l)
  dFacilities[get(newVar)==1,sumYesTR07:=sumYesTR07+1]
  dFacilities[is.na(get(newVar)),numMissing:=numMissing+1]
}
dFacilities[numMissing>=5,sumYesTR07:=NA]

dFacilities[,three_or_more_TR07:=as.numeric(NA)]
dFacilities[!is.na(sumYesTR07),three_or_more_TR07:=0]
dFacilities[sumYesTR07>=3,three_or_more_TR07:=1]

d <- dFacilities[TR05==1]
d[,numerator:=three_or_more_TR07]
```

### Results

```{r}
PrintTableNPerc(d)
```

\newpage 

# CPD Indicators

## 5. Percentage distribution of health workers per profession who took CPD courses within the past year

- Source: Workforce questionnaire 
- Calculation: ( CW00 nurses who answered SK02 with 1. Yes  / sum of CW00 nurses) * 100
- Indicator description: Percentage distribution of health workers from each profession, who took certified CPD courses within the past year
- Note: Note that this indicator needs to be repeated for each profession in CW00 and present percentage distribution ( the calculation provided was an example, repeat the indicator for doctors, allied health sciences, pharmacists, dentists, psychologists)

### Results BY CW00

```{r message=FALSE, warning=FALSE}
for(i in professionVars){
  d <- dWorkers[get(i)==1]
  d[,numerator:=as.numeric(NA)]
  d[!is.na(SK02),numerator:=0]
  d[SK02==1,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  cat(sprintf("***** %s *****\n",i))
  PrintTableNPerc(d)
  cat("\n\n")
}
```

### Results BY BOTH CW00 AND CW06

```{r message=FALSE, warning=FALSE}
for(i in professionVarsBOTH){
  d <- dWorkers[get(i)==1]
  d[,numerator:=as.numeric(NA)]
  d[!is.na(SK02),numerator:=0]
  d[SK02==1,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  cat(sprintf("***** %s *****\n",i))
  PrintTableNPerc(d)
  cat("\n\n")
}
```

## 6. Percentage distribution of health workers  per sector who took CPD courses within the past year

- Source: Workforce questionnaire 
- Calculation: ( sum of SK02 with 1. Yes  / All health workers ) * 100----> this is done by sector
- Percentage distritbution of health workers from each sector, who took certified CPD courses within the past year 
- Note: Note that this indicators is combined from 2 forms. We need the facility sector ) + this indicator needs to be repeated for each sector (Ministry of Health, Military Health Services, UNRWA, Private and NGO from IS04 ) and present percentage distribution and shows different values in same indicator

```{r}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

```


### Results BY CW00

```{r message=FALSE, warning=FALSE}
for(i in unique(dMaster$facilitySector)){
  d <- dMaster[facilitySector==i & isProf_Healthworker==1]
  d[,numerator:=as.numeric(NA)]
  d[!is.na(SK02),numerator:=0]
  d[SK02==1,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  cat(sprintf("***** %s *****\n",i))
  PrintTableNPerc(d)
  cat("\n\n")
}
```

### Results BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
for(i in unique(dMaster$facilitySector)){
  d <- dMaster[facilitySector==i & BOTH_isProf_Healthworker==1]
  d[,numerator:=as.numeric(NA)]
  d[!is.na(SK02),numerator:=0]
  d[SK02==1,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  d[is.infinite(numerator),numerator:=NA]
  cat(sprintf("***** %s *****\n",i))
  PrintTableNPerc(d)
  cat("\n\n")
}
```


# Health Workforce Indicators

## 1. Total number of working doctors in Palestine

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 ( doctors )
- Indicator description: Total number of doctors ( General Doctors and Specialized Doctors ) currently working in Palestine
- Note: 

### Results BY CW00

```{r message=FALSE, warning=FALSE}
d <- dWorkers[isProf_Doctor==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

### RESULTS BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
d <- dWorkers[BOTH_isProf_Doctor==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```


## 3. Total number of working specialized doctors per specialization in Palestine

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 ( specialized doctors )
- Indicator description: Total number of specialized doctors currently working in Palestine
- Note: 

### Results for all specialized doctors BY CW00

```{r message=FALSE, warning=FALSE}
d <- dWorkers[isProf_Specializeddoctor==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

### Results for all specialized doctors BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
d <- dWorkers[BOTH_isProf_Specializeddoctor==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

### Results stratified by type of specialized doctors BY CW00

```{r message=FALSE, warning=FALSE}
d <- dWorkers[isProf_Specializeddoctor==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01,doctor_specialization
)]

d <- d[,.(
  numerator=sum(numerator,na.rm=T)
),by=.(
  doctor_specialization
)]

setorder(d,doctor_specialization)
print(d)
```

### Results stratified by type of specialized doctors BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
d <- dWorkers[BOTH_isProf_Specializeddoctor==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01,doctor_specialization
)]

d <- d[,.(
  numerator=sum(numerator,na.rm=T)
),by=.(
  doctor_specialization
)]

setorder(d,doctor_specialization)
print(d)
```

## 5. Total number of  working dentists in Palestine

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 dentists
- Indicator description: Total number of dentists currently working in Palestine 
- Note: 

### Results BY CW00

```{r message=FALSE, warning=FALSE}
d <- dWorkers[isProf_Dentist==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

### Results BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
d <- dWorkers[BOTH_isProf_Dentist==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

## 7. Total number of working pharmacists in Palestine

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 pharmacists 
- Indicator description: Total number of pharmacists working in Palestine

### Results BY CW00

```{r message=FALSE, warning=FALSE}
d <- dWorkers[isProf_Pharmacist==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

### Results BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
d <- dWorkers[BOTH_isProf_Pharmacist==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```


## 9. Total number of working nurses in Palestine

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 nurses
- Indicator description: Total number of nurses ( Registered and Practical ) working in Palestine

### Results BY CW00

```{r message=FALSE, warning=FALSE}
d <- dWorkers[isProf_Nurse==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

### Results BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
d <- dWorkers[BOTH_isProf_Nurse==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

## 11. Total number of working midwives in Palestine

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 midwives
- Indicator description: Total number of midwives working in Palestine

### Results BY CW00

```{r message=FALSE, warning=FALSE}
d <- dWorkers[isProf_Midwife==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

### Results BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
d <- dWorkers[BOTH_isProf_Midwife==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

## 13. Total number of working allied health sciences professionals in Palestine

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 allied health sciences
- Indicator description: Total number of allied health sciences professionals working in Palestine

### Results BY CW00

```{r message=FALSE, warning=FALSE}
d <- dWorkers[isProf_Alliedhealthsciences==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

### Results BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
d <- dWorkers[BOTH_isProf_Alliedhealthsciences==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

## 15. Total number of working psychologists, counselors and therapists in Palestine

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 ( psychologists, counselor and therapists )
- Indicator description: Total number of psychologists, counselors and therapists working in Palestine

### Results BY CW00

```{r message=FALSE, warning=FALSE}
d <- dWorkers[isProf_Psychologistcounselorstherap==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

### Results BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
d <- dWorkers[BOTH_isProf_Psychologistcounselorstherap==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

## 17. Total number of working psychaitrists in Palestine

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 psychaitrists
- Indicator description: Total number of psychologists, counselors and therapists working in Palestine

### Results BY CW00

```{r message=FALSE, warning=FALSE}
d <- dWorkers[isProf_Psychiatrist==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

### Results BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
d <- dWorkers[BOTH_isProf_Psychiatrist==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

## 19. Total number of working alternative medicine practitioners in Palestine 

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 alternative medicine practitioners
- Indicator description: Total number of alternative medicine practitioners in Palestine

### Results BY CW00

```{r message=FALSE, warning=FALSE}
d <- dWorkers[isProf_AlternativeMedicine==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

### Results BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
d <- dWorkers[BOTH_isProf_AlternativeMedicine==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

## 21. Total number of working doctors, nurses and midwives per 1,000 population in Palestine

- Source: Workforce questionnaire 
- Calculation: ( CW00 doctors + CW00 nurses + CW00 midwives / total Palestine population ) * 1,000
- Indicator description: Total number of doctors, nurses and midwives working in Palestine per 1,000 population

### Results BY CW00

```{r message=FALSE, warning=FALSE}
d <- dWorkers[isProf_Doctor==1 | isProf_Nurse==1 | isProf_Midwife==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

### Results BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
d <- dWorkers[BOTH_isProf_Doctor==1 | BOTH_isProf_Nurse==1 | BOTH_isProf_Midwife==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)

cat("***PER 1000 PEOPLE ***\n")
d[is.infinite(numerator),numerator:=NA]
sum(d$numerator)/pop[districtName=="Palestine population"]$pop*1000
```

## 22. Total number of administrative and support staff in the health sector in Palestine

- Source: Workforce questionnaire 
- Calculation: Sum of CW00 administrative and support staff
- Indicator description: Total number of administrative and support staff working in the health sector in Palestine

### Results BY CW00

```{r message=FALSE, warning=FALSE}
d <- dWorkers[isProf_Administrativesupportstaff==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)
```

### Results BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
d <- dWorkers[BOTH_isProf_Administrativesupportstaff==1]
d[,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]

d[is.infinite(numerator),numerator:=NA]
PrintTableNPerc(d)
```

## 23. Health workers : administrative and support staff per sector of employment in Palestine

- Source: Workforce questionnaire and linked by faciity sector from facility questionnaire
- Calculation: sum of all health workers / sum of all administrative and support staff ----(this should be applied for all workers under each sector)
- Indicator description: Ratio of health workers to administrative and supportstaff in each sector of employment ( repeat for each sector of employment )

```{r}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
```


### Results BY CW00

```{r message=FALSE, warning=FALSE}
for(i in unique(dMaster$facilitySector)){
  d <- dMaster[facilitySector==i & (isProf_Healthworker==1 | isProf_Administrativesupportstaff==1)]
  
  d[,numerator:=isProf_Healthworker]
  d[,denominator:=isProf_Administrativesupportstaff]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T),
    denominator=max(denominator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Healthcare worker: %s\n",sum(d$numerator)))
  cat(sprintf("Admin staff: %s\n",sum(d$denominator)))
  cat(sprintf("Ratio: %s\n",sum(d$numerator)/sum(d$denominator)))
  cat(sprintf("Number of people in both categories: %s\n",sum(d$numerator==1 & d$denominator==1)))
  cat("\n\n")
}
```

### Results USING BOTH CW00 and CW06

```{r message=FALSE, warning=FALSE}
for(i in unique(dMaster$facilitySector)){
  d <- dMaster[facilitySector==i & (BOTH_isProf_Healthworker==1 | BOTH_isProf_Administrativesupportstaff==1)]
  
  d[,numerator:=BOTH_isProf_Healthworker]
  d[,denominator:=BOTH_isProf_Administrativesupportstaff]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T),
    denominator=max(denominator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Healthcare worker: %s\n",sum(d$numerator)))
  cat(sprintf("Admin staff: %s\n",sum(d$denominator)))
  cat(sprintf("Ratio: %s\n",sum(d$numerator)/sum(d$denominator)))
  cat(sprintf("Number of people in both categories: %s\n",sum(d$numerator==1 & d$denominator==1)))
  cat("\n\n")
}
```

## 24/25. Percentage distribution of each health profession per sector  of employment in Palestine

- Source: Workforce and facility questionnaire
- Calculation: ( total number of health workers in MoH / total number of health workers ) * 100 --This is repeated for all sectors to come out with percentage distribution
- Indicator description: Percentge of total health workers at each sector to total health workers in all sectors ( repeat indicator for each sector of employment )

### BY CW00

```{r}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

for(i in professionVars){
  d <- dMaster[get(i)==1]
  
  d[,numerator:=1]
  d <- d[,.(
      person=max(numerator,na.rm=T),
      jobs=sum(numerator,na.rm=T)
    ),by=.(
      HR01,
      facilitySector
    )]
  
  
  NumberOfPeople <- length(unique(d$HR01))
  
  d <- d[,.(
    person=sum(person),
    jobs=sum(jobs)),
    by=.(facilitySector)]
  d[,denom:=sum(person)]
  d[,percentagePerson:=person/denom*100]
  d[,denom:=NULL]
  
  cat(sprintf("***** %s *****\n",i))
  print(d)
  print(sprintf("Number of jobs: %s",sum(d$jobs)))
  print(sprintf("Number of people-sectors: %s",sum(d$person)))
  print(sprintf("Number of unique people WITHIN Palestine: %s",NumberOfPeople))
  cat("\n\n")
}
```

### BY CW00 AND CW06

```{r}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

for(i in professionVarsBOTH){
  d <- dMaster[get(i)==1]
  
  d[,numerator:=1]
  d <- d[,.(
      person=max(numerator,na.rm=T),
      jobs=sum(numerator,na.rm=T)
    ),by=.(
      HR01,
      facilitySector
    )]
  
  
  NumberOfPeople <- length(unique(d$HR01))
  
  d <- d[,.(
    person=sum(person),
    jobs=sum(jobs)),
    by=.(facilitySector)]
  d[,denom:=sum(person)]
  d[,percentagePerson:=person/denom*100]
  d[,denom:=NULL]
  
  cat(sprintf("***** %s *****\n",i))
  print(d)
  print(sprintf("Number of jobs: %s",sum(d$jobs)))
  print(sprintf("Number of people-sectors: %s",sum(d$person)))
  print(sprintf("Number of unique people WITHIN Palestine: %s",NumberOfPeople))
  cat("\n\n")
}
```

### BY SPECIALIZED DOCTOR BY CW00

```{r}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

specializations <- unique(dMaster$doctor_specialization)

for(i in specializations){
  d <- dMaster[doctor_specialization==i]
  
  d[,numerator:=1]
  d <- d[,.(
      person=max(numerator,na.rm=T),
      jobs=sum(numerator,na.rm=T)
    ),by=.(
      HR01,
      facilitySector
    )]
  
  
  NumberOfPeople <- length(unique(d$HR01))
  
  d <- d[,.(
    person=sum(person),
    jobs=sum(jobs)),
    by=.(facilitySector)]
  d[,denom:=sum(person)]
  d[,percentagePerson:=person/denom*100]
  d[,denom:=NULL]
  
  cat(sprintf("***** %s *****\n",i))
  print(d)
  print(sprintf("Number of jobs: %s",sum(d$jobs)))
  print(sprintf("Number of people-sectors: %s",sum(d$person)))
  print(sprintf("Number of unique people WITHIN Palestine: %s",NumberOfPeople))
  cat("\n\n")
}
```

### BY SPECIALIZED DOCTOR BY CW00 AND CW06

```{r}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

specializations <- unique(dMaster$BOTHdoctor_specialization)

for(i in specializations){
  d <- dMaster[BOTHdoctor_specialization==i]
  
  d[,numerator:=1]
  d <- d[,.(
      person=max(numerator,na.rm=T),
      jobs=sum(numerator,na.rm=T)
    ),by=.(
      HR01,
      facilitySector
    )]
  
  
  NumberOfPeople <- length(unique(d$HR01))
  
  d <- d[,.(
    person=sum(person),
    jobs=sum(jobs)),
    by=.(facilitySector)]
  d[,denom:=sum(person)]
  d[,percentagePerson:=person/denom*100]
  d[,denom:=NULL]
  
  cat(sprintf("***** %s *****\n",i))
  print(d)
  print(sprintf("Number of jobs: %s",sum(d$jobs)))
  print(sprintf("Number of people-sectors: %s",sum(d$person)))
  print(sprintf("Number of unique people WITHIN Palestine: %s",NumberOfPeople))
  cat("\n\n")
}
```

## 26/27. Ratio of total working nurses to working doctors in Palestine

- Source: Workforce and facility questionnaire
- Calculation: All CW00 nurses / All CW00 doctors
- Indicator description: Ratio of working nurses to working doctors in Palestine

### Results BY CW00

```{r}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

for(i in c("All",unique(dMaster$facilitySector))){
  d <- dMaster[isProf_Doctor==1 | isProf_Nurse==1]
  if(i!="All") d <- d[facilitySector==i]
  
  d[,numerator:=isProf_Nurse]
  d[,denominator:=isProf_Doctor]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T),
    denominator=max(denominator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Nurse: %s\n",sum(d$numerator)))
  cat(sprintf("Doctor: %s\n",sum(d$denominator)))
  cat(sprintf("Ratio: %s\n",sum(d$numerator)/sum(d$denominator)))
  cat("\n\n")
}
```

### Results BY CW00 AND CW06

```{r}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

for(i in c("All",unique(dMaster$facilitySector))){
  d <- dMaster[BOTH_isProf_Doctor==1 | BOTH_isProf_Nurse==1]
  if(i!="All") d <- d[facilitySector==i]
  
  d[,numerator:=BOTH_isProf_Nurse]
  d[,denominator:=BOTH_isProf_Doctor]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T),
    denominator=max(denominator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Nurse: %s\n",sum(d$numerator)))
  cat(sprintf("Doctor: %s\n",sum(d$denominator)))
  cat(sprintf("Ratio: %s\n",sum(d$numerator)/sum(d$denominator)))
  cat("\n\n")
}
```

## 28/30. Percentage of health workers from the Ministry of Health who dual practice 

- Source: Workforce and facility questionnaire
- Calculation: ( Health workers at Ministry of Health (IS04) with IDs found in outside MoH sector / all MoH workers ) * 100
- Indicator description: Percentage of health workers at the Ministry of Health of who dual practice

### Results BY CW00

```{r}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
unique(dMaster$facilitySector)

for(i in professionVars){
  d <- dMaster[get(i)==1]
  
  d[,numerator:=0]
  d[facilitySector!="Ministry of Health",numerator:=1]
  d[,denominator:=0]
  d[facilitySector=="Ministry of Health",denominator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T),
    denominator=max(denominator,na.rm=T)
  ),by=.(
    HR01
  )]
  d <- d[denominator==1]
  
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Numerator: %s\n",sum(d$numerator)))
  cat(sprintf("Denominator: %s\n",sum(d$denominator)))
  cat(sprintf("Percentage: %s%%\n",sum(d$numerator)/sum(d$denominator)*100))
  cat("\n\n")
}
```

### Results BY CW00 AND CW06

```{r}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
unique(dMaster$facilitySector)

for(i in professionVarsBOTH){
  d <- dMaster[get(i)==1]
  
  d[,numerator:=0]
  d[facilitySector!="Ministry of Health",numerator:=1]
  d[,denominator:=0]
  d[facilitySector=="Ministry of Health",denominator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T),
    denominator=max(denominator,na.rm=T)
  ),by=.(
    HR01
  )]
  d <- d[denominator==1]
  
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Numerator: %s\n",sum(d$numerator)))
  cat(sprintf("Denominator: %s\n",sum(d$denominator)))
  cat(sprintf("Percentage: %s%%\n",sum(d$numerator)/sum(d$denominator)*100))
  cat("\n\n")
}
```

### BY SPECIALIZED DOCTOR BY CW00

```{r}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
unique(dMaster$facilitySector)

specializations <- unique(dMaster$doctor_specialization)

for(i in specializations){
  d <- dMaster[doctor_specialization==i]
  
  d[,numerator:=0]
  d[facilitySector!="Ministry of Health",numerator:=1]
  d[,denominator:=0]
  d[facilitySector=="Ministry of Health",denominator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T),
    denominator=max(denominator,na.rm=T)
  ),by=.(
    HR01
  )]
  d <- d[denominator==1]
  
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Numerator: %s\n",sum(d$numerator)))
  cat(sprintf("Denominator: %s\n",sum(d$denominator)))
  cat(sprintf("Percentage: %s%%\n",sum(d$numerator)/sum(d$denominator)*100))
  cat("\n\n")
}
```

### BY SPECIALIZED DOCTOR BY CW00 AND CW06

```{r}
dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)
unique(dMaster$facilitySector)

specializations <- unique(dMaster$BOTHdoctor_specialization)

for(i in specializations){
  d <- dMaster[BOTHdoctor_specialization==i]
  
  d[,numerator:=0]
  d[facilitySector!="Ministry of Health",numerator:=1]
  d[,denominator:=0]
  d[facilitySector=="Ministry of Health",denominator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T),
    denominator=max(denominator,na.rm=T)
  ),by=.(
    HR01
  )]
  d <- d[denominator==1]
  
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Numerator: %s\n",sum(d$numerator)))
  cat(sprintf("Denominator: %s\n",sum(d$denominator)))
  cat(sprintf("Percentage: %s%%\n",sum(d$numerator)/sum(d$denominator)*100))
  cat("\n\n")
}
```

## 31. Percentage of doctors working in hospitals in Palestine

- Source: Workforce and facility questionnaire
- Calculation: ( sum of CW00 doctors with answer 9 in facility questionnaire IS06 / total doctors ) * 100
- Indicator description: Percentage of doctors working in Palestine who work in hospitals

### Results BY CW00

```{r}
d <- merge(dWorkers, dFacilities[,c("IDH00","IS06")], by="IDH00")
d <- d[isProf_Doctor==1]
d[!is.na(IS06),numerator:=0]
d[IS06==9,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]
 
PrintTableNPerc(d) 
```

### Results BY CW00 AND CW06

```{r}
d <- merge(dWorkers, dFacilities[,c("IDH00","IS06")], by="IDH00")
d <- d[BOTH_isProf_Doctor==1]
d[!is.na(IS06),numerator:=0]
d[IS06==9,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]
 
PrintTableNPerc(d) 
```

## 32. Percentage of nurses working in hospitals in Palestine

- Source: Workforce and facility questionnaire
- Calculation: ( sum of CW00 nurses with answer 9 in facility questionnaire IS06 / total nurses ) * 100
- Indicator description: Percentage of nurses working in Palestine who work in hospitals

### Results BY CW00

```{r}
d <- merge(dWorkers, dFacilities[,c("IDH00","IS06")], by="IDH00")
d <- d[isProf_Nurse==1]
d[!is.na(IS06),numerator:=0]
d[IS06==9,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]
 
PrintTableNPerc(d) 
```

### Results BY CW00 AND CW06

```{r}
d <- merge(dWorkers, dFacilities[,c("IDH00","IS06")], by="IDH00")
d <- d[BOTH_isProf_Nurse==1]
d[!is.na(IS06),numerator:=0]
d[IS06==9,numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]
 
PrintTableNPerc(d) 
```

## 33. Percentage of working doctors in private clinics in Palestine

- Source: Workforce and facility questionnaire
- Calculation: ( sum of CW00 doctors with answers in facility questionnaire IS06 1 +2 (and IS04--Private sector) / total number of CW00 doctors ) * 100
- Indicator description: Percentage of doctors working in Palestine who work in private clinics

### Results BY CW00

```{r}
d <- merge(dWorkers, dFacilities[,c("IDH00","IS06","facilitySector")], by="IDH00")
d <- d[isProf_Doctor==1]
d[!is.na(IS06),numerator:=0]
d[IS06 %in% c(1,2),numerator:=1]
d[facilitySector=="Private",numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]
 
PrintTableNPerc(d) 
```

### Results BY CW00 AND CW06

```{r}
d <- merge(dWorkers, dFacilities[,c("IDH00","IS06","facilitySector")], by="IDH00")
d <- d[BOTH_isProf_Doctor==1]
d[!is.na(IS06),numerator:=0]
d[IS06 %in% c(1,2),numerator:=1]
d[facilitySector=="Private",numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]
 
PrintTableNPerc(d) 
```

## 34. Percentage of working specialized doctors in private clinics in Palestine

- Source: Workforce and facility questionnaire
- Calculation: ( sum of CW00 specialized doctors with answers in facilitiy questionnaire IS06 1+ 2 (ad IS04--private sector)/ total number of CW00 specialized doctors ) * 100
- Indicator description: Percentage of working specialized doctors in private clinics in Palestine

### Results BY CW00

```{r}
d <- merge(dWorkers, dFacilities[,c("IDH00","IS06","facilitySector")], by="IDH00")
d <- d[isProf_Specializeddoctor==1]
d[!is.na(IS06),numerator:=0]
d[IS06 %in% c(1,2),numerator:=1]
d[facilitySector=="Private",numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]
 
PrintTableNPerc(d) 
```

### Results BY CW00 AND CW06

```{r}
d <- merge(dWorkers, dFacilities[,c("IDH00","IS06","facilitySector")], by="IDH00")
d <- d[BOTH_isProf_Specializeddoctor==1]
d[!is.na(IS06),numerator:=0]
d[IS06 %in% c(1,2),numerator:=1]
d[facilitySector=="Private",numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01
)]
 
PrintTableNPerc(d) 
```

### Results by specialization type BY CW00

```{r}
d <- merge(dWorkers, dFacilities[,c("IDH00","IS06","facilitySector")], by="IDH00")
d <- d[isProf_Specializeddoctor==1]
d[!is.na(IS06),numerator:=0]
d[IS06 %in% c(1,2),numerator:=1]
d[facilitySector=="Private",numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01,doctor_specialization
)]

d <- d[,.(
  numerator=sum(numerator,na.rm=T),
  denominator=.N
),by=.(
  doctor_specialization
)]
d[,perc:=RAWmisc::Format(100*numerator/denominator,digits = 2)]

setorder(d,doctor_specialization)

print(d)
```

### Results by specialization type BY CW00 AND CW06

```{r}
d <- merge(dWorkers, dFacilities[,c("IDH00","IS06","facilitySector")], by="IDH00")
d <- d[BOTH_isProf_Specializeddoctor==1]
d[!is.na(IS06),numerator:=0]
d[IS06 %in% c(1,2),numerator:=1]
d[facilitySector=="Private",numerator:=1]

d <- d[,.(
  numerator=max(numerator,na.rm=T)
),by=.(
  HR01,BOTHdoctor_specialization
)]

d <- d[,.(
  numerator=sum(numerator,na.rm=T),
  denominator=.N
),by=.(
  BOTHdoctor_specialization
)]
d[,perc:=RAWmisc::Format(100*numerator/denominator,digits = 2)]

setorder(d,BOTHdoctor_specialization)

print(d)
```



## 35x-41x. Total number of X (doctors/nurses/etc) working in East Jerusalem hospitals


- Source: Workforce and facility questionnaire
- Calculation: ( sum of CW00 doctors IDH03 who work in a facility in East Jerusalem and IS06 9. hospitals )
- Indicator description: Total number of doctors working in East Jerusalem hospitals

### Results BY CW00

```{r message=FALSE, warning=FALSE}

dMaster <- merge(dWorkers, dFacilities[,c("IDH00","IS06")], by="IDH00")

for(i in professionVars){
  #d <- dWorkers[get(i)==1 & IDH03 %in% c(dLocation[district=="East Jerusalem (J1)"]$localityCode)]
  d <- dMaster[get(i)==1 & 
                  IDH03 %in% c(dLocation[district=="East Jerusalem (J1)"]$localityCode) &
                  IS06==9]
  
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Numerator: %s\n",sum(d$numerator)))
  cat("\n\n")
}
```

### Results BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}

dMaster <- merge(dWorkers, dFacilities[,c("IDH00","IS06")], by="IDH00")

for(i in professionVarsBOTH){
  #d <- dWorkers[get(i)==1 & IDH03 %in% c(dLocation[district=="East Jerusalem (J1)"]$localityCode)]
  d <- dMaster[get(i)==1 & 
                  IDH03 %in% c(dLocation[district=="East Jerusalem (J1)"]$localityCode) &
                  IS06==9]
  
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Numerator: %s\n",sum(d$numerator)))
  cat("\n\n")
}
```

### BY SPECIALIZED DOCTOR BY CW00

```{r message=FALSE, warning=FALSE}

dMaster <- merge(dWorkers, dFacilities[,c("IDH00","IS06")], by="IDH00")

specializations <- unique(dMaster$doctor_specialization)

for(i in specializations){
  #d <- dWorkers[get(i)==1 & IDH03 %in% c(dLocation[district=="East Jerusalem (J1)"]$localityCode)]
  d <- dMaster[doctor_specialization==i & 
                  IDH03 %in% c(dLocation[district=="East Jerusalem (J1)"]$localityCode) &
                  IS06==9]
  
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Numerator: %s\n",sum(d$numerator)))
  cat("\n\n")
}
```

### BY SPECIALIZED DOCTOR BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}

dMaster <- merge(dWorkers, dFacilities[,c("IDH00","IS06")], by="IDH00")

specializations <- unique(dMaster$BOTHdoctor_specialization)

for(i in specializations){
  #d <- dWorkers[get(i)==1 & IDH03 %in% c(dLocation[district=="East Jerusalem (J1)"]$localityCode)]
  d <- dMaster[BOTHdoctor_specialization==i & 
                  IDH03 %in% c(dLocation[district=="East Jerusalem (J1)"]$localityCode) &
                  IS06==9]
  
  d[,numerator:=1]
  
  d <- d[,.(
    numerator=max(numerator,na.rm=T)
  ),by=.(
    HR01
  )]
  
  cat(sprintf("***** %s *****\n",i))
  cat(sprintf("Numerator: %s\n",sum(d$numerator)))
  cat("\n\n")
}
```

# At Risk Area Indicators

- Number/per 1000 
- Doctors, Dentists, Pharmacists, Nurses, Midwives, Doctors+Nurses+Midwives
- Area C, Jordan Valley, Jerusalem District

## BY CW00

```{r message=FALSE, warning=FALSE}

#dMaster <- merge(dWorkers, dFacilities[,c("IDH00","RE02")], by="IDH00")
#xtabs(~dMaster$RE02)

dWorkers[,isJerusalem:=as.numeric(NA)]
dWorkers[IDH03 %in% dLocation[district=="Jerusalem"]$localityCode, isJerusalem:=1]

whereDoTheyWork <- dFacilities[,c("IDH00","isJordanValley","RE02")]
whereDoTheyWork[RE02==1,worksInAreaC:=1]
whereDoTheyWork[isJordanValley==1,worksInJordanValley:=1]
whereDoTheyWork[,isJordanValley:=NULL]
whereDoTheyWork[,RE02:=NULL]

xtabs(~whereDoTheyWork$worksInAreaC)
xtabs(~whereDoTheyWork$worksInJordanValley)

nrow(dWorkers)
dWorkers[,worksInAreaC:=NULL]
dWorkers[,worksInJordanValley:=NULL]
dWorkers <- merge(dWorkers,whereDoTheyWork,by="IDH00",all.x=T)
nrow(dWorkers)


res <- list()
index <- 1
for(prof in c(
  "isProf_Doctor",
  "isProf_Dentist",
  "isProf_Pharmacist",
  "isProf_Nurse",
  "isProf_Midwife",
  "isProf_DocNurseMid"
  )) for(area in c(
    "worksInAreaC",
    "worksInJordanValley",
    "isJerusalem"
  )){
    d <- dWorkers[get(prof)==1 & get(area)==1]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01
    )]
    res[[index]] <- data.frame(prof=prof,area=area,n=nrow(d))
    index <- index + 1
  }

res <- rbindlist(res)
res[,pop:=161596.6]
res[area=="worksInAreaC",pop:=297986]
res[area=="worksInJordanValley",pop:=18241]
res[,ratep1000:=RAWmisc::Format(n/pop*1000,digits=2)]
print(res)
```

## BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}

#dMaster <- merge(dWorkers, dFacilities[,c("IDH00","RE02")], by="IDH00")
#xtabs(~dMaster$RE02)

res <- list()
index <- 1
for(prof in c(
  "BOTH_isProf_Doctor",
  "BOTH_isProf_Dentist",
  "BOTH_isProf_Pharmacist",
  "BOTH_isProf_Nurse",
  "BOTH_isProf_Midwife",
  "BOTH_isProf_DocNurseMid"
  )) for(area in c(
    "worksInAreaC",
    "worksInJordanValley",
    "isJerusalem"
  )){
    d <- dWorkers[get(prof)==1 & get(area)==1]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01
    )]
    res[[index]] <- data.frame(prof=prof,area=area,n=nrow(d))
    index <- index + 1
  }

res <- rbindlist(res)
res[,pop:=161596.6]
res[area=="worksInAreaC",pop:=297986]
res[area=="worksInJordanValley",pop:=18241]
res[,ratep1000:=RAWmisc::Format(n/pop*1000,digits=2)]
print(res)
```

# Age Indicators

- Age -> should sum up to 100%
- Stratified by professionVars
- Stratified by Palestine/Gaza/WB
- Doctors, Dentists, Pharmacists, Nurses, Midwives, Doctors+Nurses+Midwives
- Area C, Jordan Valley, Jerusalem District

## BY CW00

```{r message=FALSE, warning=FALSE}

dWorkers[,isGaza:=as.numeric(NA)]
dWorkers[,isWB:=as.numeric(NA)]

dWorkers[,isPalestine:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]
dWorkers[,age:=floor(as.numeric(difftime("2016-01-01",HR03,units="days"))/365.25)]

dWorkers[,ageCat:=as.character(NA)]
dWorkers[age>=18 & age<=30,ageCat:="18-30"]
dWorkers[age>=31 & age<=45,ageCat:="31-45"]
dWorkers[age>=46 & age<=54,ageCat:="46-54"]
dWorkers[age>=55 & age<=59,ageCat:="55-59"]
dWorkers[age>=60,ageCat:="60+"]

for(prof in professionVars) for(area in c(
    "isPalestine",
    "isGaza",
    "isWB"
  )){
    d <- dWorkers[get(prof)==1 & get(area)==1]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     ageCat
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=ageCat]
    d[!is.na(ageCat),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    d[,ageCat:=factor(ageCat,levels=c(
      "18-30",
      "31-45",
      "46-54",
      "55-59",
      "60+"
      ))]
    setorder(d,ageCat)

    cat("*******\n")
    cat(sprintf("%s %s\n",prof,area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

## BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}

dWorkers[,isGaza:=as.numeric(NA)]
dWorkers[,isWB:=as.numeric(NA)]

dWorkers[,isPalestine:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]
dWorkers[,age:=floor(as.numeric(difftime("2016-01-01",HR03,units="days"))/365.25)]

dWorkers[,ageCat:=as.character(NA)]
dWorkers[age>=18 & age<=30,ageCat:="18-30"]
dWorkers[age>=31 & age<=45,ageCat:="31-45"]
dWorkers[age>=46 & age<=54,ageCat:="46-54"]
dWorkers[age>=55 & age<=59,ageCat:="55-59"]
dWorkers[age>=60,ageCat:="60+"]

for(prof in professionVarsBOTH) for(area in c(
    "isPalestine",
    "isGaza",
    "isWB"
  )){
    d <- dWorkers[get(prof)==1 & get(area)==1]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     ageCat
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=ageCat]
    d[!is.na(ageCat),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    d[,ageCat:=factor(ageCat,levels=c(
      "18-30",
      "31-45",
      "46-54",
      "55-59",
      "60+"
      ))]
    setorder(d,ageCat)

    cat("*******\n")
    cat(sprintf("%s %s\n",prof,area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

### STRATIFIED BY SPECIALIZED DOCTOR BY CW00

```{r message=FALSE, warning=FALSE}
specializations <- unique(dWorkers$doctor_specialization)

for(prof in specializations) for(area in c(
    "isPalestine",
    "isGaza",
    "isWB"
  )){
    d <- dWorkers[doctor_specialization==prof & get(area)==1]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     ageCat
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=ageCat]
    d[!is.na(ageCat),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    d[,ageCat:=factor(ageCat,levels=c(
      "18-30",
      "31-45",
      "46-54",
      "55-59",
      "60+"
      ))]
    setorder(d,ageCat)

    cat("*******\n")
    cat(sprintf("%s %s\n",prof,area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

### STRATIFIED BY SPECIALIZED DOCTOR BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
specializations <- unique(dWorkers$BOTHdoctor_specialization)

for(prof in specializations) for(area in c(
    "isPalestine",
    "isGaza",
    "isWB"
  )){
    d <- dWorkers[BOTHdoctor_specialization==prof & get(area)==1]
    d[,numerator:=1]
  
    d <- d[,.(
     numerator=max(numerator,na.rm=T)
    ),by=.(
     HR01,
     ageCat
    )]
    
    d <- d[,.(numerator=sum(numerator)),by=ageCat]
    d[!is.na(ageCat),denominator_excl_miss:=sum(numerator)]
    d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
    d[,ageCat:=factor(ageCat,levels=c(
      "18-30",
      "31-45",
      "46-54",
      "55-59",
      "60+"
      ))]
    setorder(d,ageCat)

    cat("*******\n")
    cat(sprintf("%s %s\n",prof,area))
    if(nrow(d)==0){
      print("THERE ARE NO PEOPLE HERE")
    } else {
      print(d)
    }
    cat("\n\n")
  }

```

# Gender Indicators

- Sex -> should sum up to 100% (numbers and percentages)
- Stratified by professionVars
- Stratified by Palestine/Gaza/WB/Gaza Districts/WB Districts
- Doctors, Dentists, Pharmacists, Nurses, Midwives, Doctors+Nurses+Midwives
- Area C, Jordan Valley, Jerusalem District

## BY CW00

```{r message=FALSE, warning=FALSE}

dWorkers[,isGaza:=as.numeric(NA)]
dWorkers[,isWB:=as.numeric(NA)]

dWorkers[,isPalestineUrban:=as.numeric(NA)]
dWorkers[,isGazaUrban:=as.numeric(NA)]
dWorkers[,isWBUrban:=as.numeric(NA)]

dWorkers[,isPalestineRural:=as.numeric(NA)]
dWorkers[,isGazaRural:=as.numeric(NA)]
dWorkers[,isWBRural:=as.numeric(NA)]

dWorkers[,isPalestineCamp:=as.numeric(NA)]
dWorkers[,isGazaCamp:=as.numeric(NA)]
dWorkers[,isWBCamp:=as.numeric(NA)]

dWorkers[,isPalestine:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

dWorkers[IDH03 %in% dLocation[urbanRural=="Urban"]$localityCode,
         isPalestineUrban:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1 & urbanRural=="Urban"]$localityCode,
         isGazaUrban:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0 & urbanRural=="Urban"]$localityCode,
         isWBUrban:=1]

dWorkers[IDH03 %in% dLocation[urbanRural=="Rural"]$localityCode,
         isPalestineRural:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1 & urbanRural=="Rural"]$localityCode,
         isGazaRural:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0 & urbanRural=="Rural"]$localityCode,
         isWBRural:=1]

dWorkers[IDH03 %in% dLocation[urbanRural=="Camp"]$localityCode,
         isPalestineCamp:=1]
dWorkers[IDH03 %in% dLocation[isGaza==1 & urbanRural=="Camp"]$localityCode,
         isGazaCamp:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0 & urbanRural=="Camp"]$localityCode,
         isWBCamp:=1]

dWorkers[,isFemale:=HR02-1]

districtNames <- c("isPalestine","isGaza","isWB",
                   "isPalestineUrban","isGazaUrban","isWBUrban",
                   "isPalestineRural","isGazaRural","isWBRural",
                   "isPalestineCamp","isGazaCamp","isWBCamp")

for(i in unique(dLocation$district)){
  newName <- stringr::str_replace_all(i,"[& ,\\-\\(\\)]","")
  newName <- sprintf("isDistrict_%s",newName)
  districtNames <- c(districtNames, newName)
  dWorkers[,(newName):=as.numeric(NA)]
  dWorkers[IDH03 %in% dLocation[district==i]$localityCode, (newName):=1]
}

stack <- data.table(expand.grid(prof=professionVars,dist=districtNames,stringsAsFactors = F))

for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dWorkers[get(s$prof)==1 & get(s$dist)==1]
  d[,numerator:=1]

  d <- d[,.(
   numerator=max(numerator,na.rm=T)
  ),by=.(
   HR01,
   isFemale
  )]
  
  d <- d[,.(numerator=sum(numerator)),by=isFemale]
  d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  d[,ratio:=RAWmisc::Format(numerator/(denominator_excl_miss-numerator),2)]
  setorder(d,isFemale)
  cat("*******\n")
  cat(sprintf("%s %s\n",s$prof,s$dist))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
  }
  cat("\n\n")
}

```

### STRATIFIED BY SPECIALIZED DOCTORS BY CW00

```{r}
## FINDING OUT DUAL SPECIALIZATIONS
locationsToMerge <- dWorkers[,c("HR01","doctor_specialization","IDH00")]
locationsToMerge <- merge(locationsToMerge,dFacilities[,c("IDH00","IS04_T")],by="IDH00")


temp <- dWorkers[isFemale==1 & isProf_Specializeddoctor==1,.(N=.N),by=.(HR01,doctor_specialization)]
temp[,N:=NULL]
temp[,N:=.N,by=HR01]
setorder(temp,HR01)
temp <- temp[N>1]
temp <- merge(temp,locationsToMerge,by=c("HR01","doctor_specialization"))
openxlsx::write.xlsx(temp,file.path(RAWmisc::PROJ$SHARED_TODAY,"dual_specialization_female.xlsx"))

temp <- dWorkers[isFemale==0 & isProf_Specializeddoctor==1,.(N=.N),by=.(HR01,doctor_specialization)]
temp[,N:=NULL]
temp[,N:=.N,by=HR01]
setorder(temp,HR01)
temp <- temp[N>1]
temp <- merge(temp,locationsToMerge,by=c("HR01","doctor_specialization"))
openxlsx::write.xlsx(temp,file.path(RAWmisc::PROJ$SHARED_TODAY,"dual_specialization_male.xlsx"))
```

```{r}
specializations <- unique(dWorkers$doctor_specialization)
stack <- data.table(expand.grid(prof=specializations,dist=districtNames,stringsAsFactors = F))

res <- list()
for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dWorkers[doctor_specialization==s$prof & get(s$dist)==1]
  d[,numerator:=1]

  d <- d[,.(
   numerator=max(numerator,na.rm=T)
  ),by=.(
   HR01,
   isFemale
  )]
  
  d <- d[,.(numerator=sum(numerator)),by=isFemale]
  d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  d[,ratio:=RAWmisc::Format(numerator/(denominator_excl_miss-numerator),2)]
  setorder(d,isFemale)
  cat("*******\n")
  cat(sprintf("%s %s\n",s$prof,s$dist))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
    res[[i]] <- d
  }
  
  cat("\n\n")
}
```

## BY CW00 AND CW06

```{r message=FALSE, warning=FALSE}
stack <- data.table(expand.grid(prof=professionVarsBOTH,dist=districtNames,stringsAsFactors = F))

for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dWorkers[get(s$prof)==1 & get(s$dist)==1]
  d[,numerator:=1]

  d <- d[,.(
   numerator=max(numerator,na.rm=T)
  ),by=.(
   HR01,
   isFemale
  )]
  
  d <- d[,.(numerator=sum(numerator)),by=isFemale]
  d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  d[,ratio:=RAWmisc::Format(numerator/(denominator_excl_miss-numerator),2)]
  setorder(d,isFemale)
  cat("*******\n")
  cat(sprintf("%s %s\n",s$prof,s$dist))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
  }
  cat("\n\n")
}

```

### STRATIFIED BY SPECIALIZED DOCTORS BY CW00 AND CW06

```{r}
specializations <- unique(dWorkers$BOTHdoctor_specialization)
stack <- data.table(expand.grid(prof=specializations,dist=districtNames,stringsAsFactors = F))

res <- list()
for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dWorkers[BOTHdoctor_specialization==s$prof & get(s$dist)==1]
  d[,numerator:=1]

  d <- d[,.(
   numerator=max(numerator,na.rm=T)
  ),by=.(
   HR01,
   isFemale
  )]
  
  d <- d[,.(numerator=sum(numerator)),by=isFemale]
  d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  d[,ratio:=RAWmisc::Format(numerator/(denominator_excl_miss-numerator),2)]
  setorder(d,isFemale)
  cat("*******\n")
  cat(sprintf("%s %s\n",s$prof,s$dist))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
    res[[i]] <- d
  }
  
  cat("\n\n")
}
```

## BY SECTOR BY CW00

- Sex -> should sum up to 100% (numbers and percentages)
- Stratified by professionVars
- Stratified by Palestine/Gaza/WB/Gaza Districts/WB Districts
- Doctors, Dentists, Pharmacists, Nurses, Midwives, Doctors+Nurses+Midwives
- Area C, Jordan Valley, Jerusalem District

```{r message=FALSE, warning=FALSE}

dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

for(i in unique(dMaster$facilitySector)){
  d <- dMaster[facilitySector==i & isProf_Healthworker==1]
  d[,numerator:=1]

  d <- d[,.(
   numerator=max(numerator,na.rm=T)
  ),by=.(
   HR01,
   isFemale
  )]
  
  d <- d[,.(numerator=sum(numerator)),by=isFemale]
  d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  d[,ratio:=RAWmisc::Format(numerator/(denominator_excl_miss-numerator),2)]
  setorder(d,isFemale)
  cat("*******\n")
  cat(sprintf("%s\n",i))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
  }
  cat("\n\n")
}

```

## BY SECTOR BY CW00 AND CW06

- Sex -> should sum up to 100% (numbers and percentages)
- Stratified by professionVars
- Stratified by Palestine/Gaza/WB/Gaza Districts/WB Districts
- Doctors, Dentists, Pharmacists, Nurses, Midwives, Doctors+Nurses+Midwives
- Area C, Jordan Valley, Jerusalem District

```{r message=FALSE, warning=FALSE}

dMaster <- merge(dWorkers, dFacilities[,c("IDH00","facilitySector")], by="IDH00")
nrow(dWorkers)
nrow(dMaster)

for(i in unique(dMaster$facilitySector)){
  d <- dMaster[facilitySector==i & BOTH_isProf_Healthworker==1]
  d[,numerator:=1]

  d <- d[,.(
   numerator=max(numerator,na.rm=T)
  ),by=.(
   HR01,
   isFemale
  )]
  
  d <- d[,.(numerator=sum(numerator)),by=isFemale]
  d[!is.na(isFemale),denominator_excl_miss:=sum(numerator)]
  d[,perc:=RAWmisc::Format(numerator/denominator_excl_miss*100,1)]
  d[,ratio:=RAWmisc::Format(numerator/(denominator_excl_miss-numerator),2)]
  setorder(d,isFemale)
  cat("*******\n")
  cat(sprintf("%s\n",i))
  if(nrow(d)==0){
    print("THERE ARE NO PEOPLE HERE")
  } else {
    print(d)
  }
  cat("\n\n")
}

```


# GEOGRAPHIC INDICATORS x

## PERCENTAGE DISTRIBUTIONS BY GEOGRAPHY

- Percentage distribution (doctors/dentist/nurses/midwives/psychologisttherapistcounselor/psychiatrist) per (palestine), (WB/Gaza), (north/middle/south of wb/gaza)

### BY CW00

```{r}

dWorkers[,isPalestine:=1]
dWorkers[,isGaza:=0]
dWorkers[,isWB:=0]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

dWorkers[,campUrbanRural:=as.character(NA)]
dWorkers[IDH03 %in% dLocation[urbanRural=="Urban"]$localityCode,
         campUrbanRural:="Urban"]
dWorkers[IDH03 %in% dLocation[urbanRural=="Rural"]$localityCode,
         campUrbanRural:="Rural"]
dWorkers[IDH03 %in% dLocation[urbanRural=="Camp"]$localityCode,
         campUrbanRural:="Camp"]

districtNames <- c("isPalestine","isGaza","isWB")

stack <- data.table(expand.grid(prof=c(
  "isProf_Doctor",
  "isProf_Dentist",
  "isProf_Nurse",
  "isProf_Midwife",
  "isProf_Psychiatrist",
  "isProf_Pharmacist"
  ),dist=districtNames,
  sector=c("All sectors",unique(dFacilities$facilitySector)),stringsAsFactors = F))

dLocation[,IDH03:=localityCode]
dMaster <- merge(dWorkers, dLocation[,c("IDH03","region","district")], by="IDH03",all.x=T)
nrow(dWorkers)
nrow(dMaster)

nrow(dMaster)
dMaster <- merge(dMaster, dFacilities[,c("IDH00","facilitySector")], by="IDH00", all.x=T)
nrow(dMaster)

unique(dMaster[is.na(region),"IDH03"])

for(i in 1:nrow(stack)){
  
  ## by region
  s <- stack[i]
  d <- dMaster[get(s$prof)==1 & get(s$dist)==1]
  if(s$sector!="All sectors"){
    d <- d[facilitySector==s$sector]
  }
  
  d[,numerator:=1]
  d <- d[,.(
      person=max(numerator,na.rm=T),
      jobs=sum(numerator,na.rm=T)
    ),by=.(
      HR01,
      region
    )]
  
  NumberOfPeople <- length(unique(d$HR01))
  
  d <- d[,.(
    person=sum(person),
    jobs=sum(jobs)),
    by=.(region)]
  d[,denom:=sum(person)]
  d[,percentagePerson:=person/denom]
  d[,denom:=NULL]
  
  cat(sprintf("***** %s - %s - %s *****\n",s$prof,s$dist,s$sector))
  print(d)
  print(sprintf("Number of jobs: %s",sum(d$jobs)))
  print(sprintf("Number of people-regions: %s",sum(d$person)))
  print(sprintf("Number of unique people WITHIN %s: %s",s$dist,NumberOfPeople))
  cat("\n\n")
  
  ## by district
  s <- stack[i]
  d <- dMaster[get(s$prof)==1 & get(s$dist)==1]
  if(s$sector!="All sectors"){
    d <- d[facilitySector==s$sector]
  }
  
  d[,numerator:=1]
  d <- d[,.(
      person=max(numerator,na.rm=T),
      jobs=sum(numerator,na.rm=T)
    ),by=.(
      HR01,
      district
    )]
  
  NumberOfPeople <- length(unique(d$HR01))
  
  d <- d[,.(
    person=sum(person),
    jobs=sum(jobs)),
    by=.(district)]
  d[,denom:=sum(person)]
  d[,percentagePerson:=person/denom*100]
  d[,denom:=NULL]
  
  cat(sprintf("***** %s - %s - %s *****\n",s$prof,s$dist,s$sector))
  print(d)
  print(sprintf("Number of jobs: %s",sum(d$jobs)))
  print(sprintf("Number of people-regions: %s",sum(d$person)))
  print(sprintf("Number of unique people WITHIN %s: %s",s$dist,NumberOfPeople))
  cat("\n\n")
  
  ## by camp\urban\rural
  s <- stack[i]
  d <- dMaster[get(s$prof)==1 & get(s$dist)==1]
  if(s$sector!="All sectors"){
    d <- d[facilitySector==s$sector]
  }
  
  d[,numerator:=1]
  d <- d[,.(
      person=max(numerator,na.rm=T),
      jobs=sum(numerator,na.rm=T)
    ),by=.(
      HR01,
      campUrbanRural
    )]
  
  NumberOfPeople <- length(unique(d$HR01))
  
  d <- d[,.(
    person=sum(person),
    jobs=sum(jobs)),
    by=.(campUrbanRural)]
  d[,denom:=sum(person)]
  d[,percentagePerson:=person/denom*100]
  d[,denom:=NULL]
  
  cat(sprintf("***** %s - %s - %s *****\n",s$prof,s$dist,s$sector))
  print(d)
  print(sprintf("Number of jobs: %s",sum(d$jobs)))
  print(sprintf("Number of people-regions: %s",sum(d$person)))
  print(sprintf("Number of unique people WITHIN %s: %s",s$dist,NumberOfPeople))
  cat("\n\n")
}
```

### BY CW00 AND CW06

```{r}
stack <- data.table(expand.grid(prof=c(
  "BOTH_isProf_Doctor",
  "BOTH_isProf_Dentist",
  "BOTH_isProf_Nurse",
  "BOTH_isProf_Midwife",
  "BOTH_isProf_Psychiatrist",
  "BOTH_isProf_Pharmacist"
  ),dist=districtNames,
  sector=c("All sectors",unique(dFacilities$facilitySector)),stringsAsFactors = F))

dLocation[,IDH03:=localityCode]
dMaster <- merge(dWorkers, dLocation[,c("IDH03","region","district")], by="IDH03",all.x=T)
nrow(dWorkers)
nrow(dMaster)

nrow(dMaster)
dMaster <- merge(dMaster, dFacilities[,c("IDH00","facilitySector")], by="IDH00", all.x=T)
nrow(dMaster)

unique(dMaster[is.na(region),"IDH03"])

for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dMaster[get(s$prof)==1 & get(s$dist)==1]
  if(s$sector!="All sectors"){
    d <- d[facilitySector==s$sector]
  }
  
  d[,numerator:=1]
  d <- d[,.(
      person=max(numerator,na.rm=T),
      jobs=sum(numerator,na.rm=T)
    ),by=.(
      HR01,
      region
    )]
  
  NumberOfPeople <- length(unique(d$HR01))
  
  d <- d[,.(
    person=sum(person),
    jobs=sum(jobs)),
    by=.(region)]
  d[,denom:=sum(person)]
  d[,percentagePerson:=person/denom]
  d[,denom:=NULL]
  
  cat(sprintf("***** %s - %s - %s *****\n",s$prof,s$dist,s$sector))
  print(d)
  print(sprintf("Number of jobs: %s",sum(d$jobs)))
  print(sprintf("Number of people-regions: %s",sum(d$person)))
  print(sprintf("Number of unique people WITHIN %s: %s",s$dist,NumberOfPeople))
  cat("\n\n")
  
  s <- stack[i]
  d <- dMaster[get(s$prof)==1 & get(s$dist)==1]
  if(s$sector!="All sectors"){
    d <- d[facilitySector==s$sector]
  }
  
  d[,numerator:=1]
  d <- d[,.(
      person=max(numerator,na.rm=T),
      jobs=sum(numerator,na.rm=T)
    ),by=.(
      HR01,
      district
    )]
  
  NumberOfPeople <- length(unique(d$HR01))
  
  d <- d[,.(
    person=sum(person),
    jobs=sum(jobs)),
    by=.(district)]
  d[,denom:=sum(person)]
  d[,percentagePerson:=person/denom*100]
  d[,denom:=NULL]
  
  cat(sprintf("***** %s - %s - %s *****\n",s$prof,s$dist,s$sector))
  print(d)
  print(sprintf("Number of jobs: %s",sum(d$jobs)))
  print(sprintf("Number of people-regions: %s",sum(d$person)))
  print(sprintf("Number of unique people WITHIN %s: %s",s$dist,NumberOfPeople))
  cat("\n\n")
  
  ## by camp\urban\rural
  s <- stack[i]
  d <- dMaster[get(s$prof)==1 & get(s$dist)==1]
  if(s$sector!="All sectors"){
    d <- d[facilitySector==s$sector]
  }
  
  d[,numerator:=1]
  d <- d[,.(
      person=max(numerator,na.rm=T),
      jobs=sum(numerator,na.rm=T)
    ),by=.(
      HR01,
      campUrbanRural
    )]
  
  NumberOfPeople <- length(unique(d$HR01))
  
  d <- d[,.(
    person=sum(person),
    jobs=sum(jobs)),
    by=.(campUrbanRural)]
  d[,denom:=sum(person)]
  d[,percentagePerson:=person/denom*100]
  d[,denom:=NULL]
  
  cat(sprintf("***** %s - %s - %s *****\n",s$prof,s$dist,s$sector))
  print(d)
  print(sprintf("Number of jobs: %s",sum(d$jobs)))
  print(sprintf("Number of people-regions: %s",sum(d$person)))
  print(sprintf("Number of unique people WITHIN %s: %s",s$dist,NumberOfPeople))
  cat("\n\n")
}
```

## RATIOS OF NURSES TO DOCTORS

- Percentage distribution (doctors/dentist/nurses/midwives/psychologisttherapistcounselor/psychiatrist) per (palestine), (WB/Gaza), (north/middle/south of wb/gaza)

### BY CW00

```{r}

dWorkers[,isPalestine:=1]
dWorkers[,isGaza:=0]
dWorkers[,isWB:=0]
dWorkers[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dWorkers[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

dWorkers[,campUrbanRural:=as.character(NA)]
dWorkers[IDH03 %in% dLocation[urbanRural=="Urban"]$localityCode,
         campUrbanRural:="Urban"]
dWorkers[IDH03 %in% dLocation[urbanRural=="Rural"]$localityCode,
         campUrbanRural:="Rural"]
dWorkers[IDH03 %in% dLocation[urbanRural=="Camp"]$localityCode,
         campUrbanRural:="Camp"]


districtNames <- c("isPalestine","isGaza","isWB")

dLocation[,IDH03:=localityCode]
dMaster <- merge(dWorkers, dLocation[,c("IDH03","region","district")], by="IDH03",all.x=T)
nrow(dWorkers)
nrow(dMaster)

nrow(dMaster)
dMaster <- merge(dMaster, dFacilities[,c("IDH00","facilitySector")], by="IDH00", all.x=T)
nrow(dMaster)

unique(dMaster[is.na(region),"IDH03"])

for(i in c("isPalestine","isGaza","isWB")){
  for(s in c("All sectors",unique(dFacilities$facilitySector))){
    d <- dMaster[(isProf_Doctor==1 | isProf_Nurse==1) & get(i)==1]
    if(s!="All sectors"){
      d <- d[facilitySector==s]
    }
    
    d[,numerator:=isProf_Nurse]
    d[,denominator:=isProf_Doctor]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01
    )]
    
    d <- d[,.(
      nurses=sum(numerator),
      doctors=sum(denominator)
    )]
    d[,ratio:=nurses/doctors]
    
    cat(sprintf("***** ALL: %s - %s *****\n",i,s))
    print(d)
    cat("\n\n")
    
    d <- dMaster[(isProf_Doctor==1 | isProf_Nurse==1) & get(i)==1]
    if(s!="All sectors"){
      d <- d[facilitySector==s]
    }
    
    d[,numerator:=isProf_Nurse]
    d[,denominator:=isProf_Doctor]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01,region
    )]
    
    d <- d[,.(
      nurses=sum(numerator),
      doctors=sum(denominator)
    ),by=.(region)]
    d[,ratio:=nurses/doctors]
    
    cat(sprintf("***** REGION: %s - %s *****\n",i,s))
    print(d)
    cat("\n\n")
    
    d <- dMaster[(isProf_Doctor==1 | isProf_Nurse==1) & get(i)==1]
    if(s!="All sectors"){
      d <- d[facilitySector==s]
    }
    
    d[,numerator:=isProf_Nurse]
    d[,denominator:=isProf_Doctor]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01,district
    )]
    
    d <- d[,.(
      nurses=sum(numerator),
      doctors=sum(denominator)
    ),by=.(district)]
    d[,ratio:=nurses/doctors]
    
    cat(sprintf("***** DISTRICT: %s - %s *****\n",i,s))
    print(d)
    cat("\n\n")
    
    d <- dMaster[(isProf_Doctor==1 | isProf_Nurse==1) & get(i)==1]
    if(s!="All sectors"){
      d <- d[facilitySector==s]
    }
    
    d[,numerator:=isProf_Nurse]
    d[,denominator:=isProf_Doctor]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01,campUrbanRural
    )]
    
    d <- d[,.(
      nurses=sum(numerator),
      doctors=sum(denominator)
    ),by=.(campUrbanRural)]
    d[,ratio:=nurses/doctors]
    
    cat(sprintf("***** campUrbanRural: %s - %s *****\n",i,s))
    print(d)
    cat("\n\n")
  }
}
```

### BY CW00 AND CW06

```{r}

dLocation[,IDH03:=localityCode]
dMaster <- merge(dWorkers, dLocation[,c("IDH03","region","district")], by="IDH03",all.x=T)
nrow(dWorkers)
nrow(dMaster)

unique(dMaster[is.na(region),"IDH03"])

nrow(dMaster)
dMaster <- merge(dMaster, dFacilities[,c("IDH00","facilitySector")], by="IDH00", all.x=T)
nrow(dMaster)

for(i in c("isPalestine","isGaza","isWB")){
  for(s in c("All sectors",unique(dFacilities$facilitySector))){
    d <- dMaster[(BOTH_isProf_Doctor==1 | BOTH_isProf_Nurse==1) & get(i)==1]
    if(s!="All sectors"){
      d <- d[facilitySector==s]
    }
    
    d[,numerator:=BOTH_isProf_Nurse]
    d[,denominator:=BOTH_isProf_Doctor]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01
    )]
    
    d <- d[,.(
      nurses=sum(numerator),
      doctors=sum(denominator)
    )]
    d[,ratio:=nurses/doctors]
    
    cat(sprintf("***** ALL: %s - %s *****\n",i,s))
    print(d)
    cat("\n\n")
    
    d <- dMaster[(BOTH_isProf_Doctor==1 | BOTH_isProf_Nurse==1) & get(i)==1]
    if(s!="All sectors"){
      d <- d[facilitySector==s]
    }
    
    d[,numerator:=BOTH_isProf_Nurse]
    d[,denominator:=BOTH_isProf_Doctor]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01,region
    )]
    
    d <- d[,.(
      nurses=sum(numerator),
      doctors=sum(denominator)
    ),by=.(region)]
    d[,ratio:=nurses/doctors]
    
    cat(sprintf("***** REGION: %s - %s *****\n",i,s))
    print(d)
    cat("\n\n")
    
    d <- dMaster[(BOTH_isProf_Doctor==1 | BOTH_isProf_Nurse==1) & get(i)==1]
    if(s!="All sectors"){
      d <- d[facilitySector==s]
    }
    
    d[,numerator:=BOTH_isProf_Nurse]
    d[,denominator:=BOTH_isProf_Doctor]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01,district
    )]
    
    d <- d[,.(
      nurses=sum(numerator),
      doctors=sum(denominator)
    ),by=.(district)]
    d[,ratio:=nurses/doctors]
    
    cat(sprintf("***** DISTRICT: %s - %s *****\n",i,s))
    print(d)
    cat("\n\n")
    
    d <- dMaster[(BOTH_isProf_Doctor==1 | BOTH_isProf_Nurse==1) & get(i)==1]
    if(s!="All sectors"){
      d <- d[facilitySector==s]
    }
    
    d[,numerator:=BOTH_isProf_Nurse]
    d[,denominator:=BOTH_isProf_Doctor]
    
    d <- d[,.(
      numerator=max(numerator,na.rm=T),
      denominator=max(denominator,na.rm=T)
    ),by=.(
      HR01,campUrbanRural
    )]
    
    d <- d[,.(
      nurses=sum(numerator),
      doctors=sum(denominator)
    ),by=.(campUrbanRural)]
    d[,ratio:=nurses/doctors]
    
    cat(sprintf("***** campUrbanRural: %s - %s *****\n",i,s))
    print(d)
    cat("\n\n")
  }
}
```

# Disability Indicators

```{r}
dFacilities[,isPalestine:=1]
dFacilities[,isGaza := as.numeric(NA)]
dFacilities[,isWB:=as.numeric(NA)]
dFacilities[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dFacilities[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]

stack <- data.table(expand.grid(
  sector=c("All sectors",unique(dFacilities$facilitySector)),
  dist=c("isPalestine","isGaza","isWB"),stringsAsFactors = F))

for(i in 1:nrow(stack)){
  d <- dFacilities[get(stack[i]$dist)==1]
  if(stack[i]$sector!="All sectors") d <- d[facilitySector==stack[i]$sector]
  
  numerator <- sum(d$IS03_A,na.rm=T)
  denominator <- sum(d$IS02_A,na.rm=T)
  missing <- sum(is.na(d$IS02_A),na.rm=T)
  cat(sprintf("*******%s %s\n",stack[i]$dist,stack[i]$sector))
  cat(sprintf("numerator: %s denominator: %s, missing: %s, percentage: %s%%\n",
              numerator,denominator,missing,RAWmisc::Format(numerator/denominator*100),1))
  cat("\n\n")
}

```

# Services Indicators

## Numbers and per 1000

```{r}
dFacilities[,isHospital:=0]
dFacilities[IS06==9,isHospital:=1]

dFacilities[,isMOH_PHC:=0]
dFacilities[facilitySector=="Ministry of Health" & IS06==4, isMOH_PHC:=1]

dFacilities[,isPrivate_Lab:=0]
dFacilities[facilitySector=="Private" & IS06==8, isPrivate_Lab:=1]

dFacilities[,isPrivate_Radiology:=0]
dFacilities[facilitySector=="Private" & IS06==6, isPrivate_Radiology:=1]

dFacilities[,isPrivate_Dentistry:=0]
dFacilities[facilitySector=="Private" & IS06==3, isPrivate_Dentistry:=1]

dFacilities[,isPrivate_Rehab:=0]
dFacilities[facilitySector=="Private" & IS06==7, isPrivate_Rehab:=1]

dFacilities[,isPalestine:=1]
dFacilities[,isGaza:=0]
dFacilities[,isWB:=0]
dFacilities[IDH03 %in% dLocation[isGaza==1]$localityCode, isGaza:=1]
dFacilities[IDH03 %in% dLocation[isGaza==0]$localityCode, isWB:=1]
dFacilities[IDH03 %in% dLocation[region=="East Jerusalem (J1)"]$localityCode, isEJerusalem:=1]

stack <- data.table(expand.grid(
  type=c("isHospital",
         "isMOH_PHC",
         "isPrivate_Lab",
         "isPrivate_Radiology",
         "isPrivate_Dentistry",
         "isPrivate_Rehab"),
  location=c("isPalestine","isGaza","isWB","isEJerusalem")
  , stringsAsFactors = F
))

for(i in 1:nrow(stack)){
  s <- stack[i]
  d <- dFacilities[get(s$type)==1 & get(s$location)==1]
  
  if(s$location=="isPalestine"){
    usePop <- pop[districtName=="Palestine population"]$pop
  } else if(s$location=="isGaza"){
    usePop <- pop[districtName=="Gaza Population"]$pop
  } else if(s$location=="isWB"){
    usePop <- pop[districtName=="West Bank population"]$pop
  } else if(s$location=="isEJerusalem"){
    usePop <- 0
  }
  
  cat(sprintf("\n\n*********\nNumber of %s in %s: %s\n",
              s$type,
              s$location,
              nrow(d)
              ))
  
  cat(sprintf("\n\n%s in %s per 1,000 pop: %s\n",
              s$type,
              s$location,
              nrow(d)/usePop*1000
              ))
}

```



## Percentage distributions of hospitals

```{r}

for(i in c("isPalestine","isGaza","isWB")){
  d <- dFacilities[isHospital==1 & get(i)==1]
  
  d <- d[,.(
    N=.N
  ),by=.(
    facilitySector
  )]
  d[,denominator:=sum(N)]
  d[,perc:=N/denominator*100]
  
  cat(sprintf("\n\n*** %s ***\n",i))
  print(d)
  
}

```



